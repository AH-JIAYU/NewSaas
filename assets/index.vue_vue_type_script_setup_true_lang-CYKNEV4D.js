
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{_ as I}from"./index.vue_vue_type_script_setup_true_lang-CUOc_WLx.js";import{a as m}from"./user_customer-BLTsd0L7.js";import{o as N,s as w}from"./apiLoading-THjp2fBt.js";import{u as R}from"./stagedData-C96eLizY.js";import{u as j}from"./user_customer-B2drX096.js";import{d as U,r as u,a2 as M,a3 as v,a as h,o as T,b as O,f as c,w as i,g as p,e as P,j as Q,i as $,Q as q,an as F,E as d}from"./index-BItR3vGR.js";const Z=U({__name:"index",emits:["fetch-data"],setup(G,{expose:y,emit:k}){const f=R(),b=j(),D=k,l=u(!1),o=u(""),_=u(),n=u([]),r=u([]);function L(e){r.value.push(e)}M("validateTopTabs",L);let a=v([]);async function x(e){if(!e)o.value="添加",a=f.userCustomer||[{...b.initialTopTabsData}];else{o.value="编辑";const{data:t}=await N(m.detail({tenantCustomerId:e.tenantCustomerId}));S(t)}n.value=[],l.value=!0}function S(e){a.length=0,a.push({...e})}function V(e){const t=new Set;for(const s of e){if(t.has(s.customerAccord))return!0;t.add(s.customerAccord)}return!1}function E(){f.userCustomer=F(a),a=v([]),l.value=!1,r.value=[]}function g(){a=v([]),l.value=!1,r.value=[],o.value==="添加"&&(f.userCustomer=null)}async function C(){const e=[];r.value.forEach(s=>{e.push(s.validate())});const t=await Promise.allSettled(e);n.value=t.map(s=>s.status)}async function A(){if(await C(),n.value.every(e=>e==="fulfilled"))if(V(a))d.warning({message:"客户名称重复",center:!0});else{if(o.value==="添加"){const e={tenantCustomerInfoList:a},{status:t}=await w(m.create(e));t===1&&d.success({message:"新增成功",center:!0})}else{a[0].riskControl===1&&(a[0].turnover=null,a[0].rateAudit=null),console.log("leftTabsData[0]",a[0]);const{status:e}=await w(m.edit(a[0]));e===1&&d.success({message:"修改成功",center:!0})}D("fetch-data"),b.customer=null,g()}else _.value.activeLeftTab=n.value.indexOf("rejected"),d.warning({message:"请完善表单",center:!0})}return y({showEdit:x}),(e,t)=>{const s=h("el-button"),z=h("el-drawer");return T(),O("div",null,[c(z,{modelValue:l.value,"onUpdate:modelValue":t[0]||(t[0]=B=>l.value=B),class:q(o.value==="添加"?"hide-drawer-header":"edit-drawer"),"append-to-body":"","close-on-click-modal":!1,"destroy-on-close":"",draggable:"",size:"70%"},{footer:i(()=>[c(s,{onClick:g},{default:i(()=>[p(" 取消 ")]),_:1}),o.value==="添加"?(T(),P(s,{key:0,type:"warning",onClick:E},{default:i(()=>[p(" 暂存 ")]),_:1})):Q("",!0),c(s,{type:"primary",onClick:A},{default:i(()=>[p(" 确定 ")]),_:1})]),default:i(()=>[c(I,{onValidate:C,ref_key:"LeftTabsRef",ref:_,title:o.value,"left-tabs-data":$(a),"validate-top-tabs":r.value,"validate-all":n.value},null,8,["title","left-tabs-data","validate-top-tabs","validate-all"])]),_:1},8,["modelValue","class"])])}}});export{Z as _};

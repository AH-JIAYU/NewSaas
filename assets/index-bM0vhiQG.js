
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{d as W,m as F,r as g,u as X,c as Y,n as Z,p as M,a as v,q as ee,o as b,e as P,w as r,f as u,g as V,s as h,i as o,b as T,t as x,F as C,y as I,ao as U,E as D,L as le}from"./index-D7pIq9uP.js";import{a as N}from"./department-rsB7e1Cn.js";const ae={class:"user"},se={class:"mr checkbox-container"},oe={class:"centers mr"},te={class:"center mr"},ie={class:"center mr"},ne=W({__name:"index",props:F({parentId:{default:""},id:{default:""},tree:{},row:{},isClick:{type:Boolean}},{modelValue:{type:Boolean,default:!1},modelModifiers:{}}),emits:F(["getList","getItmelist"],["update:modelValue"]),setup(q,{emit:j}){const _=g([]),y=q,B=g(!1),R=[{label:"完成计提",value:1},{label:"审核计提",value:2},{label:"结算计提",value:3}],A=[{label:"按项目价",value:1},{label:"按成本价",value:2},{label:"按毛利润",value:3}],L=g(!1),k=j,w=X(q,"modelValue"),O=Y(()=>y.id===""?"新增部门":"编辑部门"),d=g([]),z=g(),e=g({parentId:y.parentId,name:"",remark:"",userIdList:[],organizationalStructurePersonList:[],commission:null,commissionTime:null,commissionStatus:2,commissionType:null}),J=g({name:[{required:!0,message:"请输入部门名称"}],commissionType:[{required:!0,message:"请选择计提方式",trigger:"change"}]}),$=t=>{var a,m;if(e.value.userIdList=t,d.value=_.value.filter(i=>{var c;return(c=e.value)==null?void 0:c.userIdList.includes(i.id)}),console.log((a=e.value)==null?void 0:a.userIdList,"form.value?.userIdList"),(m=e.value)!=null&&m.userIdList.length){const i=[];console.log(e.value.organizationalStructurePersonList,"form.value.organizationalStructurePersonList"),e.value.organizationalStructurePersonList.forEach(s=>{i.push(s)}),d.value.forEach(s=>{e.value.organizationalStructurePersonList.some(p=>p.userId===s.id)||i.push(s)});const n=Array.from(new Map(i.map(s=>[s.id,s])).values()).filter(s=>s.userId?t.includes(s.userId):t.includes(s.id));d.value=n,e.value.organizationalStructurePersonList=d.value}else d.value=[],e.value.organizationalStructurePersonList=d.value};async function G(){try{z.value&&await z.value.validate(async t=>{if(t){if(L.value=!0,e.value.organizationalStructurePersonList=[],e.value.commissionStatus===1&&!/^[1-9]\d*$/.test(e.value.commission)){D.warning({message:"提成比例必须是正整数",center:!0}),L.value=!1;return}d.value.forEach(n=>{if(n.userId){const s={id:n.id,userId:n.userId};e.value.organizationalStructurePersonList.push(s)}else{const s={userId:n.id};e.value.organizationalStructurePersonList.push(s)}}),e.value.commission=e.value.commission||0,e.value.commissionTime=e.value.commissionTime||1,e.value.commissionType=e.value.commissionType||1;const a=e.value.organizationalStructurePersonList.reduce((n,s)=>(n.some(p=>p.userId===s.userId)||n.push(s),n),[]);e.value.organizationalStructurePersonList=a;const m={...e.value};delete m.userIdList;let i;e.value.id?i=await N.edit(m):i=await N.create(m);const{status:c}=i;c===1?D.success({message:e.value.id?"编辑成功":"新增成功",center:!0}):D.error("操作失败，请重试"),B.value?(await k("getItmelist"),await k("getList")):await k("getList"),E()}})}catch{}finally{L.value=!1}}function E(){Object.assign(e,{parentId:"",name:"",remark:"",userIdList:[],organizationalStructurePersonList:[],commission:null,commissionTime:null,commissionStatus:2,commissionType:null}),w.value=!1}const H=()=>_.value.filter(t=>{var a;return(a=e.value)==null?void 0:a.userIdList.includes(t.id)});return Z(async()=>{try{if(L.value=!0,y.id){const{id:t,name:a,remark:m,organizationalStructurePersonList:i,commission:c,commissionTime:n,commissionStatus:s,commissionType:S}=JSON.parse(y.row);e.value.id=t,e.value.name=a,e.value.remark=m,B.value=y.isClick,e.value.commission=c,e.value.commissionTime=n,e.value.commissionStatus=s,e.value.commissionType=S;const{data:p}=await M.queryNotEnableStaffList({organizationalStructureId:e.value.id});p&&(_.value=p),e.value.organizationalStructurePersonList=[],i?(i.forEach(f=>{f.enableChargePerson==1&&e.value.organizationalStructurePersonList.push(f)}),e.value.organizationalStructurePersonList.forEach(f=>{e.value.userIdList.push(f.userId)})):e.value.organizationalStructurePersonList=[]}else{const{data:t}=await M.queryAllNotEnableStaffList();t&&(_.value=t)}d.value=H(),e.value.id&&(d.value=e.value.organizationalStructurePersonList)}catch(t){console.error("Error occurred:",t)}finally{L.value=!1}}),(t,a)=>{const m=v("ElInput"),i=v("ElFormItem"),c=v("el-option"),n=v("el-select"),s=v("el-text"),S=v("el-switch"),p=v("ElForm"),f=v("ElButton"),K=v("ElDialog"),Q=ee("loading");return b(),P(K,{modelValue:w.value,"onUpdate:modelValue":a[7]||(a[7]=l=>w.value=l),title:o(O),style:{width:"48rem"},"close-on-click-modal":!1,"append-to-body":"","destroy-on-close":"",onClosed:E},{footer:r(()=>[u(f,{size:"large",onClick:E},{default:r(()=>[V(" 取消 ")]),_:1}),u(f,{type:"primary",size:"large",onClick:G},{default:r(()=>[V(" 确定 ")]),_:1})]),default:r(()=>[h((b(),P(p,{ref_key:"formRef",ref:z,model:o(e),rules:o(J),"label-width":"7rem"},{default:r(()=>[u(i,{label:"部门名称",prop:"name"},{default:r(()=>[u(m,{modelValue:o(e).name,"onUpdate:modelValue":a[0]||(a[0]=l=>o(e).name=l),placeholder:"请输入部门名称",clearable:""},null,8,["modelValue"])]),_:1}),u(i,{label:"部门主管",prop:""},{default:r(()=>[u(n,{modelValue:o(e).userIdList,"onUpdate:modelValue":a[1]||(a[1]=l=>o(e).userIdList=l),"value-key":"",placeholder:"请选择部门主管",multiple:"","collapse-tags":"","collapse-tags-tooltip":"",clearable:"",filterable:"",onChange:$},{default:r(()=>[(b(!0),T(C,null,x(o(_),l=>(b(),P(c,{key:l.value,label:l.userName,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),u(i,{label:"备注"},{default:r(()=>[u(m,{modelValue:o(e).remark,"onUpdate:modelValue":a[2]||(a[2]=l=>o(e).remark=l),placeholder:"请输入备注",clearable:""},null,8,["modelValue"])]),_:1}),I("div",ae,[I("div",se,[u(s,{style:{width:"4.375rem"}},{default:r(()=>[V("开启提成")]),_:1}),u(S,{modelValue:o(e).commissionStatus,"onUpdate:modelValue":a[3]||(a[3]=l=>o(e).commissionStatus=l),"active-value":1,"inactive-value":2,"inline-prompt":"","active-text":"开启","inactive-text":"关闭"},null,8,["modelValue"])]),h(I("div",oe,[u(n,{modelValue:o(e).commissionType,"onUpdate:modelValue":a[4]||(a[4]=l=>o(e).commissionType=l),"value-key":"",placeholder:"计提方式",clearable:"",filterable:""},{default:r(()=>[(b(),T(C,null,x(A,l=>u(c,{key:l.value,label:l.label,value:l.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])],512),[[U,o(e).commissionStatus===1]]),h(I("div",te,[u(n,{class:"select",modelValue:o(e).commissionTime,"onUpdate:modelValue":a[5]||(a[5]=l=>o(e).commissionTime=l),"value-key":"",placeholder:"计提时间",clearable:"",filterable:""},{default:r(()=>[(b(),T(C,null,x(R,l=>u(c,{key:l.value,label:l.label,value:l.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])],512),[[U,o(e).commissionStatus===1]]),h(I("div",ie,[u(m,{modelValue:o(e).commission,"onUpdate:modelValue":a[6]||(a[6]=l=>o(e).commission=l),placeholder:"提成比例",style:{"max-width":"25rem"},clearable:""},{append:r(()=>[V("%")]),_:1},8,["modelValue"])],512),[[U,o(e).commissionStatus===1]])])]),_:1},8,["model","rules"])),[[Q,o(L)]])]),_:1},8,["modelValue","title"])}}}),me=le(ne,[["__scopeId","data-v-d6befdc0"]]);export{me as default};

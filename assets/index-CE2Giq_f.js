
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{d as z,al as N,r as c,a3 as q,a4 as d,k as H,a as I,o as T,b as O,f,w as u,g,n as F,ao as G,i as b,e as J,j as K,R as W,ap as p,E as m,Q as X}from"./index-D5mKHCpP.js";import Y from"./index-nS_UZAVd.js";import{o as Z,s as _}from"./apiLoading-C5jWlBzD.js";import{u as $}from"./index-_tV8CwTr.js";import{u as ee}from"./stagedData-CNUkrj1O.js";import{u as te}from"./user_customer-C-Ql9Xj-.js";import{a as L}from"./projectManagement-ChpAiHxw.js";import"./index.vue_vue_type_script_setup_true_lang-CkO5GMGz.js";import"./index-BRzif-Pl.js";import"./zh_Hans-CdmNlI-1.js";import"./zh_Hans-B39mJ-rS.js";import"./file-CJsKeTm3.js";import"./user_customer-DIAnXi1l.js";const ae=z({name:"ProjeckEdit",__name:"index",emits:["fetch-data"],setup(oe,{expose:P,emit:h}){const C=$(),v=ee(),D=N(),k=te(),V=h,l=c(!1),r=c(""),n=c([]),i=c([]);function S(t){n.value.push(t)}q("validateTopTabs",S);let o=d([]);const y=c();async function U(t){if(t){r.value="编辑";const a=await Z(L.detail({projectId:t.projectId}));A(a.data)}else{r.value="新增";const a=p(C.initialTopTabsData);o=v.projectManagementList||d([a])}l.value=!0,i.value=[],n.value=[]}function A(t){t.data={configurationInformation:{initialProblem:{countryId:null,projectProblemCategoryId:null,projectQuotaQuestionType:null,projectProblemId:null,keyValue:"",questionType:null,answerValueList:[],projectAnswerIdList:[]},configurationCountryList:null,projectCategoryList:null,ProjectProblemInfoList:[]}},o=[];const{projectInfoList:a,...e}=p(t);e.descriptionUrl?e.descriptionUrl=e.descriptionUrl.split(","):e.descriptionUrl=[],o.push(e),a&&a.length&&a.forEach(s=>{s.data={configurationInformation:{initialProblem:{countryId:null,projectProblemCategoryId:null,projectQuotaQuestionType:null,projectProblemId:null,keyValue:"",questionType:null,answerValueList:[],projectAnswerIdList:[]},configurationCountryList:null,projectCategoryList:null,ProjectProblemInfoList:[]}},s.descriptionUrl=s.descriptionUrl.split(","),o.push({...s})})}function E(){v.projectManagementList=p(o),o=d([]),l.value=!1,n.value=[]}async function j(){const t=[];n.value.forEach(e=>{t.push(e.validate())});const a=await Promise.allSettled(t);i.value=a.map(e=>e.status)}function x(t){const a=new Set;for(const e of t){if(a.has(e.name))return!0;a.add(e.name)}return!1}const M=()=>{const t=p(o);t.forEach(e=>{e.descriptionUrl=e.descriptionUrl.join(","),(!e.data.configurationInformation.ProjectProblemInfoList||!e.data.configurationInformation.ProjectProblemInfoList.length)&&(e.isProfile=2),e.data&&delete e.data,e.projectQuotaInfoList=e.projectQuotaInfoList.map(s=>(Array.isArray(s.answerValueList)||(s.answerValueList=[]),Array.isArray(s.projectAnswerIdList)||(s.projectAnswerIdList=[]),s))});let a=t[0];return a.projectInfoList=t.slice(1),a};async function Q(){if(await j(),i.value.every(t=>t==="fulfilled"))if(x(o))m({message:"项目名称重复",center:!0});else{const t=M();if(r.value==="新增"){const{status:a}=await _(L.create(t));a===1&&m.success({message:"新增成功",center:!0})}else{const{status:a}=await _(L.edit(t));a===1&&m.success({message:"编辑成功",center:!0})}V("fetch-data"),w()}else y.value.activeLeftTab=i.value.indexOf("rejected"),m.warning({message:"请完善表单",center:!0})}function w(){o=d([]),i.value=[],n.value=[],l.value=!1,r.value==="新增"&&(v.projectManagementList=null)}const B=async()=>{await k.getCustomerList(),await D.getCountry()};return H(async()=>{await B()}),P({showEdit:U}),(t,a)=>{const e=I("el-button"),s=I("el-drawer");return T(),O("div",null,[f(s,{modelValue:l.value,"onUpdate:modelValue":a[0]||(a[0]=R=>l.value=R),class:W(r.value==="新增"||b(o).length>1?"hide-drawer-header":"edit-drawer"),"append-to-body":"","close-on-click-modal":!1,"destroy-on-close":"",draggable:"",size:"70%"},{footer:u(()=>[f(e,{onClick:w},{default:u(()=>[g(" 取消 ")]),_:1}),F(f(e,{type:"warning",onClick:E},{default:u(()=>[g(" 暂存 ")]),_:1},512),[[G,r.value!=="编辑"]]),f(e,{type:"primary",onClick:Q},{default:u(()=>[g(" 确定 ")]),_:1})]),default:u(()=>[b(o).length?(T(),J(Y,{key:0,onValidate:j,ref_key:"LeftTabsRef",ref:y,"left-tabs-data":b(o),"validate-top-tabs":n.value,"validate-all":i.value,title:r.value},null,8,["left-tabs-data","validate-top-tabs","validate-all","title"])):K("",!0)]),_:1},8,["modelValue","class"])])}}}),be=X(ae,[["__scopeId","data-v-7aa71f5b"]]);export{be as default};

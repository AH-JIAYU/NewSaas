
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{d as $,r as n,aE as G,aD as J,l as K,X as C,Z as y,n as W,a as S,q as ee,o as x,b as te,f as d,w as p,y as ae,s as w,ao as E,g,z as oe,i as _,e as re,j as se,N as ie,ap as m,E as b,_ as ne,L as le}from"./index-CqImPfqe.js";import ce from"./index-Wv1OQmCK.js";import{u as ue}from"./projectManagement_list-jLK_WIwf.js";import{u as de}from"./stagedData-aCpTa4k0.js";import{u as pe}from"./user_customer-Bg_roLDB.js";import{a as P}from"./projectManagement-BYS9e3bB.js";import"./index-D5DaMEn_.js";import"./user_customer-MbmjStr5.js";import"./file-DzT94R5m.js";import"./index-bosxiaxz.js";import"./zh_Hans-B2rs90h7.js";import"./zh_Hans-B39mJ-rS.js";import"./index-B6_l_zr6.js";import"./index.vue_vue_type_script_setup_true_lang-HCqpUtos.js";import"./index-D9ebsik0.js";import"./index-Bp6P0TeJ.js";import"./index-DODrp3_N.js";import"./index-CszxH0mH.js";import"./department-BC0rvror.js";import"./position_manage-D6aTf3rd.js";import"./configuration_role-DV0MofoF.js";import"./tenant_role-BcX-nfeb.js";import"./configuration_manager-DGeWVR_j.js";import"./configuration_siteSetting-Cdg1BXdh.js";import"./configuration_site_setting-5w9zZ0J4.js";import"./apiLoading-COSxSarN.js";import"./index.vue_vue_type_script_setup_true_lang-COCbXq3z.js";const fe={class:"flex-c"},me=$({name:"ProjeckEdit",__name:"index",emits:["fetch-data"],setup(ve,{expose:k,emit:R}){const j=n();j.value=G.local.get("currencyTypeRes");const i=J(),v=ue(),T=de(),V=K(),U=pe(),M=R,f=n(!1),l=n(""),s=n(!1),c=n([]),L=n(""),u=n([]);function A(e){c.value.push(e)}function B(e){L.value=e}C("validateTopTabs",A),C("currentProjectTimeline",B);let r=y([]);const h=n();async function N(e){try{if(s.value=!0,e){l.value="编辑";const a=await P.detail({projectId:e.projectId});Q(a.data)}else{l.value="新增";const a=m(v.initialTopTabsData);r=T.projectManagementList||y([a])}f.value=!0,u.value=[],c.value=[],s.value=!1}catch{}finally{s.value=!1}}function Q(e){e.data={configurationInformation:{initialProblem:{countryId:null,projectProblemCategoryId:null,projectQuotaQuestionType:null,projectProblemId:null,keyValue:"",questionType:null,answerValueList:[],projectAnswerIdList:[]},configurationCountryList:null,projectCategoryList:null,ProjectProblemInfoList:[]}},r=[];const{projectInfoList:a,...t}=m(e);t.descriptionUrl?t.descriptionUrl=t.descriptionUrl.split(","):t.descriptionUrl=[],r.push(t),a&&a.length&&a.forEach(o=>{o.data={configurationInformation:{initialProblem:{countryId:null,projectProblemCategoryId:null,projectQuotaQuestionType:null,projectProblemId:null,keyValue:"",questionType:null,answerValueList:[],projectAnswerIdList:[]},configurationCountryList:null,projectCategoryList:null,ProjectProblemInfoList:[]}},o.descriptionUrl=o.descriptionUrl.split(","),r.push({...o})}),v.dataBeforeEditing=m(r)}function z(){T.projectManagementList=m(r),r=y([]),f.value=!1,c.value=[]}async function I(){const e=[];c.value.forEach(t=>{e.push(t.validate())});const a=await Promise.allSettled(e);u.value=a.map(t=>t.status)}function q(e){const a=new Set;for(const t of e){if(a.has(t.name))return!0;a.add(t.name)}return!1}const Y=async()=>{const e=m(r);await v.compareProjectData(v.dataBeforeEditing,e),await e.forEach(t=>{t.descriptionUrl=t.descriptionUrl.join(","),(!t.data.configurationInformation.ProjectProblemInfoList||!t.data.configurationInformation.ProjectProblemInfoList.length)&&(t.isProfile=2),t.data&&delete t.data,t.projectQuotaInfoList=t.projectQuotaInfoList.map(o=>(Array.isArray(o.answerValueList)||(o.answerValueList=[]),Array.isArray(o.projectAnswerIdList)||(o.projectAnswerIdList=[]),o))});let a=e[0];return a.projectInfoList=e.slice(1),a};async function F(){if(s.value=!0,await I(),u.value.every(e=>e==="fulfilled"))if(q(r))b({message:"项目名称重复",center:!0});else{const e=await Y();setTimeout(async()=>{if(l.value==="新增"){i.currencyType===2&&e.currencyType==="CNY"||i.currencyType===1&&e.currencyType==="USD"?(e.memberPrice=e.doMoneyPrice,e.exchangeRate=i.originalExchangeRate):i.currencyType===2&&e.currencyType==="USD"?(e.exchangeRate=j.value,e.memberPrice=e.doMoneyPrice*i.originalExchangeRate):i.currencyType===1&&e.currencyType==="CNY"&&(e.exchangeRate=(1/j.value).toFixed(2),e.memberPrice=e.doMoneyPrice/i.originalExchangeRate);const{status:a}=await P.create(e);a===1&&b.success({message:"新增成功",center:!0})}else{const{status:a}=await P.edit(e);a===1&&b.success({message:"编辑成功",center:!0})}M("fetch-data"),D()},1e3)}else h.value.activeLeftTab=u.value.indexOf("rejected"),b.warning({message:"请完善表单",center:!0});s.value=!1}function D(){r=y([]),u.value=[],c.value=[],f.value=!1,l.value==="新增"&&(T.projectManagementList=null)}const H=async()=>{await U.getCustomerList(),await V.getCountry()};return W(async()=>{await H()}),k({showEdit:N}),(e,a)=>{const t=ne,o=S("el-button"),O=S("el-drawer"),X=ee("loading");return x(),te("div",null,[d(O,{modelValue:f.value,"onUpdate:modelValue":a[0]||(a[0]=Z=>f.value=Z),class:ie(l.value==="新增"||_(r).length>1?"hide-drawer-header":"edit-drawer"),"append-to-body":"","close-on-click-modal":!1,"destroy-on-close":"",draggable:"",size:"70%"},{footer:p(()=>[ae("div",fe,[w(d(o,{link:""},{default:p(()=>[d(t,{name:"ant-design:clock-circle-outlined"}),g("   "+oe(L.value),1)]),_:1},512),[[E,L.value]]),d(o,{type:"primary",onClick:F,disabled:s.value},{default:p(()=>[g(" 发布项目 ")]),_:1},8,["disabled"]),w(d(o,{type:"warning",onClick:z,disabled:s.value},{default:p(()=>[g(" 暂存 ")]),_:1},8,["disabled"]),[[E,l.value!=="编辑"]]),d(o,{onClick:D,disabled:s.value},{default:p(()=>[g(" 取消 ")]),_:1},8,["disabled"])])]),default:p(()=>[_(r).length?w((x(),re(ce,{key:0,onValidate:I,ref_key:"LeftTabsRef",ref:h,"left-tabs-data":_(r),"validate-top-tabs":c.value,"validate-all":u.value,title:l.value},null,8,["left-tabs-data","validate-top-tabs","validate-all","title"])),[[X,s.value]]):se("",!0)]),_:1},8,["modelValue","class"])])}}}),Ye=le(me,[["__scopeId","data-v-c625e657"]]);export{Ye as default};


/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{d as N,am as H,r as c,a4 as O,a5 as m,k as F,a as T,p as G,o as P,b as J,f as v,w as d,g as y,q as h,aq as K,i as j,e as W,j as X,S as Y,an as p,E as g,R as Z}from"./index-BSaSDwJk.js";import $ from"./index-B58g46LG.js";import{u as ee}from"./index-7xGDaK6t.js";import{u as te}from"./stagedData-DQasJCUP.js";import{u as ae}from"./user_customer-Boim8i4r.js";import{a as L}from"./projectManagement-SC29luf_.js";import"./index.vue_vue_type_script_setup_true_lang-CX_uf6jT.js";import"./index-CeMKPDzu.js";import"./zh_Hans-2WlIuTMU.js";import"./zh_Hans-B39mJ-rS.js";import"./file-B4ZA0C4c.js";import"./index.vue_vue_type_script_setup_true_lang-BjEko45l.js";import"./index.vue_vue_type_script_setup_true_lang-DzeXt_cF.js";import"./index-7BZMApoy.js";import"./user_customer-CAB0rGxF.js";import"./index-uV5ryW1W.js";import"./department-DrFTGi0s.js";import"./position_manage-BujE0Xfl.js";import"./department-DyRE3I4A.js";import"./tenant_role-1_3OVB6-.js";import"./configuration_role-D2y-ujUf.js";import"./configuration_manager-Bk0n0_Rf.js";import"./apiLoading-C41OHBCM.js";const oe=N({name:"ProjeckEdit",__name:"index",emits:["fetch-data"],setup(se,{expose:C,emit:D}){const f=ee(),b=te(),k=H(),S=ae(),V=D,u=c(!1),i=c(""),r=c(!1),n=c([]),l=c([]);function E(t){n.value.push(t)}O("validateTopTabs",E);let o=m([]);const w=c();async function U(t){try{if(r.value=!0,t){i.value="编辑";const a=await L.detail({projectId:t.projectId});A(a.data)}else{i.value="新增";const a=p(f.initialTopTabsData);o=b.projectManagementList||m([a])}u.value=!0,l.value=[],n.value=[],r.value=!1}catch{}finally{r.value=!1}}function A(t){t.data={configurationInformation:{initialProblem:{countryId:null,projectProblemCategoryId:null,projectQuotaQuestionType:null,projectProblemId:null,keyValue:"",questionType:null,answerValueList:[],projectAnswerIdList:[]},configurationCountryList:null,projectCategoryList:null,ProjectProblemInfoList:[]}},o=[];const{projectInfoList:a,...e}=p(t);e.descriptionUrl?e.descriptionUrl=e.descriptionUrl.split(","):e.descriptionUrl=[],o.push(e),a&&a.length&&a.forEach(s=>{s.data={configurationInformation:{initialProblem:{countryId:null,projectProblemCategoryId:null,projectQuotaQuestionType:null,projectProblemId:null,keyValue:"",questionType:null,answerValueList:[],projectAnswerIdList:[]},configurationCountryList:null,projectCategoryList:null,ProjectProblemInfoList:[]}},s.descriptionUrl=s.descriptionUrl.split(","),o.push({...s})}),f.dataBeforeEditing=p(o)}function x(){b.projectManagementList=p(o),o=m([]),u.value=!1,n.value=[]}async function I(){const t=[];n.value.forEach(e=>{t.push(e.validate())});const a=await Promise.allSettled(t);l.value=a.map(e=>e.status)}function M(t){const a=new Set;for(const e of t){if(a.has(e.name))return!0;a.add(e.name)}return!1}const B=async()=>{const t=p(o);await f.compareProjectData(f.dataBeforeEditing,t),await t.forEach(e=>{e.descriptionUrl=e.descriptionUrl.join(","),(!e.data.configurationInformation.ProjectProblemInfoList||!e.data.configurationInformation.ProjectProblemInfoList.length)&&(e.isProfile=2),e.data&&delete e.data,e.projectQuotaInfoList=e.projectQuotaInfoList.map(s=>(Array.isArray(s.answerValueList)||(s.answerValueList=[]),Array.isArray(s.projectAnswerIdList)||(s.projectAnswerIdList=[]),s))});let a=t[0];return a.projectInfoList=t.slice(1),a};async function Q(){if(r.value=!0,await I(),l.value.every(t=>t==="fulfilled"))if(M(o))g({message:"项目名称重复",center:!0});else{const t=await B();setTimeout(async()=>{if(i.value==="新增"){const{status:a}=await L.create(t);a===1&&g.success({message:"新增成功",center:!0})}else{const{status:a}=await L.edit(t);a===1&&g.success({message:"编辑成功",center:!0})}V("fetch-data"),_()},1e3)}else w.value.activeLeftTab=l.value.indexOf("rejected"),g.warning({message:"请完善表单",center:!0});r.value=!1}function _(){o=m([]),l.value=[],n.value=[],u.value=!1,i.value==="新增"&&(b.projectManagementList=null)}const q=async()=>{await S.getCustomerList(),await k.getCountry()};return F(async()=>{await q()}),C({showEdit:U}),(t,a)=>{const e=T("el-button"),s=T("el-drawer"),R=G("loading");return P(),J("div",null,[v(s,{modelValue:u.value,"onUpdate:modelValue":a[0]||(a[0]=z=>u.value=z),class:Y(i.value==="新增"||j(o).length>1?"hide-drawer-header":"edit-drawer"),"append-to-body":"","close-on-click-modal":!1,"destroy-on-close":"",draggable:"",size:"70%"},{footer:d(()=>[v(e,{onClick:_,disabled:r.value},{default:d(()=>[y(" 取消 ")]),_:1},8,["disabled"]),h(v(e,{type:"warning",onClick:x,disabled:r.value},{default:d(()=>[y(" 暂存 ")]),_:1},8,["disabled"]),[[K,i.value!=="编辑"]]),v(e,{type:"primary",onClick:Q,disabled:r.value},{default:d(()=>[y(" 确定 ")]),_:1},8,["disabled"])]),default:d(()=>[j(o).length?h((P(),W($,{key:0,onValidate:I,ref_key:"LeftTabsRef",ref:w,"left-tabs-data":j(o),"validate-top-tabs":n.value,"validate-all":l.value,title:i.value},null,8,["left-tabs-data","validate-top-tabs","validate-all","title"])),[[R,r.value]]):X("",!0)]),_:1},8,["modelValue","class"])])}}}),De=Z(oe,[["__scopeId","data-v-abcb73d5"]]);export{De as default};


/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{d as Y,m as q,r as I,u as Z,c as ee,n as le,a as p,q as se,s as V,i as d,o as _,e as M,w as c,f as r,g as h,b,t as S,F as x,y,z as ae,ao as P,E as U,L as oe}from"./index-DaALCnOY.js";import{a as T}from"./survey_vip_department-DgRnvB2C.js";const te={class:"mr"},ne={class:"mr checkbox-container"},ue={class:"centers mr"},re={class:"center mr"},ie={class:"center mr"},de=Y({__name:"index",props:q({parentId:{default:""},id:{default:""},tree:{},row:{},name:{}},{modelValue:{type:Boolean,default:!1},modelModifiers:{}}),emits:q(["getList"],["update:modelValue"]),setup(C,{emit:B}){const L=I([]),f=C,F=[{label:"完成计提",value:1},{label:"审核计提",value:2}],N=[{label:"按项目价",value:1},{label:"按成本价",value:2},{label:"按毛利润",value:3}],v=I(!1),O=B,k=Z(C,"modelValue"),j=ee(()=>f.id===""?"新增子部门":"编辑子部门"),m=I([]),z=I(),e=I({parentId:f.parentId,name:"",remark:"",userIdList:[],organizationalStructurePersonList:[],superior:""}),R=I({name:[{required:!0,message:"请输入部门名称"}],commissionType:[{required:!0,message:"请选择计提方式",trigger:"change"}]});function $(t){for(const o of t){const u=o.commission,l=o.commissionStatus;if(l!==2&&l===1&&!/^[1-9]\d*$/.test(u))return!1}return!0}async function A(){try{z.value&&z.value.validate(async t=>{if(t){if(v.value=!0,e.value.organizationalStructurePersonList=[],!$(m.value)){U.warning({message:"提成比例必须是正整数",center:!0}),v.value=!1;return}m.value.forEach(s=>{if(s.userId){const n={id:s.id,userId:s.userId,commission:s.commission||0,commissionTime:s.commissionTime||1,commissionStatus:s.commissionStatus,commissionType:s.commissionType||1};e.value.organizationalStructurePersonList.push(n)}else{const n={userId:s.id,commission:s.commission||0,commissionTime:s.commissionTime||1,commissionStatus:s.commissionStatus,commissionType:s.commissionType||1};e.value.organizationalStructurePersonList.push(n)}});const u=e.value.organizationalStructurePersonList.reduce((s,n)=>(s.some(g=>g.userId===n.userId)||s.push(n),s),[]);e.value.organizationalStructurePersonList=u;const l={...e.value};if(delete l.userIdList,delete l.superior,e.value.id){const{status:s}=await T.edit(l);s===1&&U.success({message:"编辑成功",center:!0}),v.value=!1}else{const{status:s}=await T.create(l);s===1&&U.success({message:"新增成功",center:!0}),v.value=!1}await O("getList"),w()}})}catch{}finally{v.value=!1}}const J=t=>{if(t.userId){const l=e.value.userIdList.indexOf(t.userId);l!==-1&&e.value.userIdList.splice(l,1)}else{const l=e.value.userIdList.indexOf(t.id);l!==-1&&e.value.userIdList.splice(l,1)}const o=e.value.organizationalStructurePersonList.findIndex(l=>l.id===t.id||l.userId===t.id);o!==-1&&e.value.organizationalStructurePersonList.splice(o,1);const u=m.value.findIndex(l=>l.id===t.id||l.userId===t.id);u!==-1&&m.value.splice(u,1)},G=t=>{var o;if(e.value.userIdList=t,m.value=L.value.filter(u=>{var l;return(l=e.value)==null?void 0:l.userIdList.includes(u.id)}),(o=e.value)!=null&&o.userIdList.length){const u=[];e.value.organizationalStructurePersonList.forEach(n=>{u.push(n)}),m.value.forEach(n=>{e.value.organizationalStructurePersonList.some(g=>g.userId===n.id)||u.push(n)});const s=Array.from(new Map(u.map(n=>[n.id,n])).values()).filter(n=>t.includes(n.id));m.value=s,e.value.organizationalStructurePersonList=m.value}else m.value=[],e.value.organizationalStructurePersonList=m.value};function w(){Object.assign(e,{parentId:"",name:"",remark:"",userIdList:[],organizationalStructurePersonList:[],superior:""}),k.value=!1}const H=()=>L.value.filter(t=>{var o;return(o=e.value)==null?void 0:o.userIdList.includes(t.id)});return f.parentId&&(e.value.superior=f.name),le(async()=>{try{if(v.value=!0,f.id!==""){const{id:t,name:o,remark:u,organizationalStructurePersonList:l}=JSON.parse(f.row);e.value.id=t,e.value.name=o,e.value.remark=u,e.value.organizationalStructurePersonList=l,l.forEach(s=>{e.value.userIdList.push(s.userId)})}else{const{data:t}=await T.queryMemberList();t&&(L.value=t)}m.value=H(),e.value.id&&(m.value=e.value.organizationalStructurePersonList),v.value=!1}catch{}finally{v.value=!1}}),(t,o)=>{const u=p("ElInput"),l=p("ElFormItem"),s=p("el-option"),n=p("el-select"),E=p("el-tag"),g=p("el-text"),K=p("el-switch"),Q=p("ElForm"),D=p("ElButton"),W=p("ElDialog"),X=se("loading");return V((_(),M(W,{modelValue:k.value,"onUpdate:modelValue":o[4]||(o[4]=a=>k.value=a),title:d(j),style:{width:"48rem"},"close-on-click-modal":!1,"append-to-body":"","destroy-on-close":"",onClosed:w},{footer:c(()=>[r(D,{size:"large",onClick:w},{default:c(()=>[h(" 取消 ")]),_:1}),r(D,{type:"primary",size:"large",onClick:A},{default:c(()=>[h(" 确定 ")]),_:1})]),default:c(()=>[r(Q,{ref_key:"formRef",ref:z,model:d(e),rules:d(R),"label-width":"7rem"},{default:c(()=>[r(l,{label:"上级部门",prop:""},{default:c(()=>[r(u,{modelValue:d(e).superior,"onUpdate:modelValue":o[0]||(o[0]=a=>d(e).superior=a),disabled:!!f.parentId,placeholder:"请输入部门名称",clearable:""},null,8,["modelValue","disabled"])]),_:1}),r(l,{label:"部门名称",prop:"name"},{default:c(()=>[r(u,{modelValue:d(e).name,"onUpdate:modelValue":o[1]||(o[1]=a=>d(e).name=a),placeholder:"请输入部门名称",clearable:""},null,8,["modelValue"])]),_:1}),r(l,{label:"部门主管",prop:""},{default:c(()=>[r(n,{modelValue:d(e).userIdList,"onUpdate:modelValue":o[2]||(o[2]=a=>d(e).userIdList=a),"value-key":"",placeholder:"请选择部门主管",multiple:"","collapse-tags":"","collapse-tags-tooltip":"",clearable:"",filterable:"",onChange:G},{default:c(()=>[(_(!0),b(x,null,S(d(L),a=>(_(),M(s,{key:a.value,label:a.userName,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),r(l,{label:"备注"},{default:c(()=>[r(u,{modelValue:d(e).remark,"onUpdate:modelValue":o[3]||(o[3]=a=>d(e).remark=a),placeholder:"请输入备注",clearable:""},null,8,["modelValue"])]),_:1}),(_(!0),b(x,null,S(d(m),a=>(_(),b("div",{key:a.id,class:"user"},[y("div",te,[r(E,{type:"primary",closable:"",onClose:i=>J(a)},{default:c(()=>[h(ae(a.userName),1)]),_:2},1032,["onClose"])]),y("div",ne,[r(g,{style:{width:"4.375rem"}},{default:c(()=>[h("开启提成")]),_:1}),r(K,{modelValue:a.commissionStatus,"onUpdate:modelValue":i=>a.commissionStatus=i,"active-value":1,"inactive-value":2,"inline-prompt":"","active-text":"开启","inactive-text":"关闭"},null,8,["modelValue","onUpdate:modelValue"])]),V(y("div",ue,[r(n,{modelValue:a.commissionType,"onUpdate:modelValue":i=>a.commissionType=i,"value-key":"",placeholder:"计提方式",clearable:"",filterable:""},{default:c(()=>[(_(),b(x,null,S(N,i=>r(s,{key:i.value,label:i.label,value:i.value},null,8,["label","value"])),64))]),_:2},1032,["modelValue","onUpdate:modelValue"])],512),[[P,a.commissionStatus===1]]),V(y("div",re,[r(n,{class:"select",modelValue:a.commissionTime,"onUpdate:modelValue":i=>a.commissionTime=i,"value-key":"",placeholder:"计提时间",clearable:"",filterable:""},{default:c(()=>[(_(),b(x,null,S(F,i=>r(s,{key:i.value,label:i.label,value:i.value},null,8,["label","value"])),64))]),_:2},1032,["modelValue","onUpdate:modelValue"])],512),[[P,a.commissionStatus===1]]),V(y("div",ie,[r(u,{modelValue:a.commission,"onUpdate:modelValue":i=>a.commission=i,placeholder:"提成比例",style:{"max-width":"25rem"},clearable:""},null,8,["modelValue","onUpdate:modelValue"])],512),[[P,a.commissionStatus===1]])]))),128))]),_:1},8,["model","rules"])]),_:1},8,["modelValue","title"])),[[X,d(v)]])}}}),pe=oe(de,[["__scopeId","data-v-e1413451"]]);export{pe as default};


/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{d as Z,m as D,r as _,u as ee,c as ae,n as le,p as N,a as p,q as se,o as f,e as U,w as u,f as i,g as b,s as S,i as c,b as L,t as x,F as k,y,z as oe,aq as C,E as B,L as te}from"./index-Ccrs2enF.js";import{a as F}from"./department-W2sHQ5nS.js";const ne={class:"mr"},re={class:"mr checkbox-container"},ie={class:"centers mr"},ue={class:"center mr"},de={class:"center mr"},ce=Z({__name:"index",props:D({parentId:{default:""},id:{default:""},tree:{},row:{}},{modelValue:{type:Boolean,default:!1},modelModifiers:{}}),emits:D(["getList"],["update:modelValue"]),setup(T,{emit:M}){const I=_([]),h=T,O=[{label:"完成计提",value:1},{label:"审核计提",value:2},{label:"结算计提",value:3}],j=[{label:"按项目价",value:1},{label:"按成本价",value:2},{label:"按毛利润",value:3}],g=_(!1),R=M,z=ee(T,"modelValue"),A=ae(()=>h.id===""?"新增部门":"编辑部门"),d=_([]),w=_(),e=_({parentId:h.parentId,name:"",remark:"",userIdList:[],organizationalStructurePersonList:[]}),J=_({name:[{required:!0,message:"请输入部门名称"}],commissionType:[{required:!0,message:"请选择计提方式",trigger:"change"}]}),$=o=>{if(o.userId){const l=e.value.userIdList.indexOf(o.userId);l!==-1&&e.value.userIdList.splice(l,1)}else{const l=e.value.userIdList.indexOf(o.id);l!==-1&&e.value.userIdList.splice(l,1)}const t=e.value.organizationalStructurePersonList.findIndex(l=>l.id===o.id||l.userId===o.id);t!==-1&&e.value.organizationalStructurePersonList.splice(t,1);const n=d.value.findIndex(l=>l.id===o.id||l.userId===o.id);n!==-1&&d.value.splice(n,1)},G=o=>{var t;if(e.value.userIdList=o,d.value=I.value.filter(n=>{var l;return(l=e.value)==null?void 0:l.userIdList.includes(n.id)}),(t=e.value)!=null&&t.userIdList.length){const n=[];e.value.organizationalStructurePersonList.forEach(a=>{n.push(a)}),d.value.forEach(a=>{e.value.organizationalStructurePersonList.some(V=>V.userId===a.id)||n.push(a)});const m=Array.from(new Map(n.map(a=>[a.id,a])).values()).filter(a=>a.userId?o.includes(a.userId):o.includes(a.id));d.value=m,e.value.organizationalStructurePersonList=d.value}else d.value=[],e.value.organizationalStructurePersonList=d.value},H=o=>{};async function K(){try{w.value&&await w.value.validate(async o=>{if(o){g.value=!0,e.value.organizationalStructurePersonList=[],d.value.forEach(a=>{if(a.userId){const v={id:a.id,userId:a.userId,commission:a.commission||0,commissionTime:a.commissionTime||0,commissionStatus:a.commissionStatus||0,commissionType:a.commissionType||0};e.value.organizationalStructurePersonList.push(v)}else{const v={userId:a.id,commission:a.commission||0,commissionTime:a.commissionTime||0,commissionStatus:a.commissionStatus||0,commissionType:a.commissionType||0};e.value.organizationalStructurePersonList.push(v)}});const t=e.value.organizationalStructurePersonList.reduce((a,v)=>(a.some(P=>P.userId===v.userId)||a.push(v),a),[]);e.value.organizationalStructurePersonList=t;const n={...e.value};delete n.userIdList;let l;e.value.id?l=await F.edit(n):l=await F.create(n);const{status:m}=l;m===1?B.success({message:e.value.id?"编辑成功":"新增成功",center:!0}):B.error("操作失败，请重试"),await R("getList"),E()}})}catch{}finally{g.value=!1}}function E(){Object.assign(e,{parentId:"",name:"",remark:"",userIdList:[],organizationalStructurePersonList:[]}),z.value=!1}const Q=()=>I.value.filter(o=>{var t;return(t=e.value)==null?void 0:t.userIdList.includes(o.id)});return le(async()=>{try{if(g.value=!0,h.id){const{id:o,name:t,remark:n,organizationalStructurePersonList:l}=JSON.parse(h.row);e.value.id=o,e.value.name=t,e.value.remark=n;const{data:m}=await N.queryNotEnableStaffList({organizationalStructureId:e.value.id});m&&(I.value=m),l?(e.value.organizationalStructurePersonList=l,l.forEach(a=>{e.value.userIdList.push(a.userId)})):e.value.organizationalStructurePersonList=[]}else{const{data:o}=await N.queryAllNotEnableStaffList();o&&(I.value=o)}d.value=Q(),e.value.id&&(d.value=e.value.organizationalStructurePersonList)}catch(o){console.error("Error occurred:",o)}finally{g.value=!1}}),(o,t)=>{const n=p("ElInput"),l=p("ElFormItem"),m=p("el-option"),a=p("el-select"),v=p("el-tag"),V=p("el-text"),P=p("el-switch"),W=p("ElForm"),q=p("ElButton"),X=p("ElDialog"),Y=se("loading");return f(),U(X,{modelValue:z.value,"onUpdate:modelValue":t[3]||(t[3]=s=>z.value=s),title:c(A),style:{width:"48rem"},"close-on-click-modal":!1,"append-to-body":"","destroy-on-close":"",onClosed:E},{footer:u(()=>[i(q,{size:"large",onClick:E},{default:u(()=>[b(" 取消 ")]),_:1}),i(q,{type:"primary",size:"large",onClick:K},{default:u(()=>[b(" 确定 ")]),_:1})]),default:u(()=>[S((f(),U(W,{ref_key:"formRef",ref:w,model:c(e),rules:c(J),"label-width":"7rem"},{default:u(()=>[i(l,{label:"部门名称",prop:"name"},{default:u(()=>[i(n,{modelValue:c(e).name,"onUpdate:modelValue":t[0]||(t[0]=s=>c(e).name=s),placeholder:"请输入部门名称",clearable:""},null,8,["modelValue"])]),_:1}),i(l,{label:"部门主管",prop:""},{default:u(()=>[i(a,{modelValue:c(e).userIdList,"onUpdate:modelValue":t[1]||(t[1]=s=>c(e).userIdList=s),"value-key":"",placeholder:"请选择部门主管",multiple:"","collapse-tags":"","collapse-tags-tooltip":"",clearable:"",filterable:"",onChange:G},{default:u(()=>[(f(!0),L(k,null,x(c(I),s=>(f(),U(m,{key:s.value,label:s.userName,value:s.id,disabled:s.enableChargePerson===1},null,8,["label","value","disabled"]))),128))]),_:1},8,["modelValue"])]),_:1}),i(l,{label:"备注"},{default:u(()=>[i(n,{modelValue:c(e).remark,"onUpdate:modelValue":t[2]||(t[2]=s=>c(e).remark=s),placeholder:"请输入备注",clearable:""},null,8,["modelValue"])]),_:1}),(f(!0),L(k,null,x(c(d),s=>(f(),L("div",{key:s.id,class:"user"},[y("div",ne,[i(v,{type:"primary",closable:"",onClose:r=>$(s)},{default:u(()=>[b(oe(s.userName),1)]),_:2},1032,["onClose"])]),y("div",re,[i(V,{style:{width:"4.375rem"}},{default:u(()=>[b("开启提成")]),_:1}),i(P,{modelValue:s.commissionStatus,"onUpdate:modelValue":r=>s.commissionStatus=r,"active-value":1,"inactive-value":2,"inline-prompt":"","active-text":"开启","inactive-text":"关闭",onChange:H},null,8,["modelValue","onUpdate:modelValue"])]),S(y("div",ie,[i(a,{modelValue:s.commissionType,"onUpdate:modelValue":r=>s.commissionType=r,"value-key":"",placeholder:"计提方式",clearable:"",filterable:""},{default:u(()=>[(f(),L(k,null,x(j,r=>i(m,{key:r.value,label:r.label,value:r.value},null,8,["label","value"])),64))]),_:2},1032,["modelValue","onUpdate:modelValue"])],512),[[C,s.commissionStatus===1]]),S(y("div",ue,[i(a,{class:"select",modelValue:s.commissionTime,"onUpdate:modelValue":r=>s.commissionTime=r,"value-key":"",placeholder:"计提时间",clearable:"",filterable:""},{default:u(()=>[(f(),L(k,null,x(O,r=>i(m,{key:r.value,label:r.label,value:r.value},null,8,["label","value"])),64))]),_:2},1032,["modelValue","onUpdate:modelValue"])],512),[[C,s.commissionStatus===1]]),S(y("div",de,[i(n,{modelValue:s.commission,"onUpdate:modelValue":r=>s.commission=r,placeholder:"提成比例",style:{"max-width":"25rem"},clearable:""},{append:u(()=>[b("%")]),_:2},1032,["modelValue","onUpdate:modelValue"])],512),[[C,s.commissionStatus===1]])]))),128))]),_:1},8,["model","rules"])),[[Y,c(g)]])]),_:1},8,["modelValue","title"])}}}),ve=te(ce,[["__scopeId","data-v-c0c53329"]]);export{ve as default};

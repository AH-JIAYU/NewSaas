
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{d as ee,m as M,r as g,u as ae,c as le,n as se,p as O,a as f,q as oe,o as _,e as U,w as d,f as u,g as y,s as V,i as v,b as S,t as k,F as x,y as h,z as te,ao as T,E as D,L as ne}from"./index-BDT0MVn7.js";import{a as j}from"./department-CapddDQD.js";const ie={class:"mr"},re={class:"mr checkbox-container"},ue={class:"centers mr"},de={class:"center mr"},ce={class:"center mr"},me=ee({__name:"index",props:M({parentId:{default:""},id:{default:""},tree:{},row:{},isClick:{type:Boolean}},{modelValue:{type:Boolean,default:!1},modelModifiers:{}}),emits:M(["getList","getItmelist"],["update:modelValue"]),setup(q,{emit:R}){const b=g([]),L=q,B=g(!1),A=[{label:"完成计提",value:1},{label:"审核计提",value:2},{label:"结算计提",value:3}],$=[{label:"按项目价",value:1},{label:"按成本价",value:2},{label:"按毛利润",value:3}],I=g(!1),w=R,z=ae(q,"modelValue"),J=le(()=>L.id===""?"新增部门":"编辑部门"),c=g([]),E=g(),e=g({parentId:L.parentId,name:"",remark:"",userIdList:[],organizationalStructurePersonList:[]}),G=g({name:[{required:!0,message:"请输入部门名称"}],commissionType:[{required:!0,message:"请选择计提方式",trigger:"change"}]}),H=s=>{if(s.userId){const a=e.value.userIdList.indexOf(s.userId);a!==-1&&e.value.userIdList.splice(a,1)}else{const a=e.value.userIdList.indexOf(s.id);a!==-1&&e.value.userIdList.splice(a,1)}const o=e.value.organizationalStructurePersonList.findIndex(a=>a.id===s.id||a.userId===s.id);o!==-1&&e.value.organizationalStructurePersonList.splice(o,1);const i=c.value.findIndex(a=>a.id===s.id||a.userId===s.id);i!==-1&&c.value.splice(i,1)},K=s=>{var o;if(e.value.userIdList=s,c.value=b.value.filter(i=>{var a;return(a=e.value)==null?void 0:a.userIdList.includes(i.id)}),(o=e.value)!=null&&o.userIdList.length){const i=[];e.value.organizationalStructurePersonList.forEach(t=>{i.push(t)}),c.value.forEach(t=>{e.value.organizationalStructurePersonList.some(p=>p.userId===t.id)||i.push(t)});const m=Array.from(new Map(i.map(t=>[t.id,t])).values()).filter(t=>t.userId?s.includes(t.userId):s.includes(t.id));c.value=m,e.value.organizationalStructurePersonList=c.value}else c.value=[],e.value.organizationalStructurePersonList=c.value};function Q(s){for(const o of s){const i=o.commission,a=o.commissionStatus;if(a!==2&&a===1&&!/^[1-9]\d*$/.test(i))return!1}return!0}async function W(){try{E.value&&await E.value.validate(async s=>{if(s){if(I.value=!0,e.value.organizationalStructurePersonList=[],!Q(c.value)){D.warning({message:"提成比例必须是正整数",center:!0}),I.value=!1;return}c.value.forEach(n=>{if(n.userId){const p={id:n.id,userId:n.userId,commission:n.commission||0,commissionTime:n.commissionTime||1,commissionStatus:n.commissionStatus,commissionType:n.commissionType||1};e.value.organizationalStructurePersonList.push(p)}else{const p={userId:n.id,commission:n.commission||0,commissionTime:n.commissionTime||1,commissionStatus:n.commissionStatus,commissionType:n.commissionType||1};e.value.organizationalStructurePersonList.push(p)}});const i=e.value.organizationalStructurePersonList.reduce((n,p)=>(n.some(C=>C.userId===p.userId)||n.push(p),n),[]);e.value.organizationalStructurePersonList=i;const a={...e.value};delete a.userIdList;let m;e.value.id?m=await j.edit(a):m=await j.create(a);const{status:t}=m;t===1?D.success({message:e.value.id?"编辑成功":"新增成功",center:!0}):D.error("操作失败，请重试"),B.value?(await w("getItmelist"),await w("getList")):await w("getList"),P()}})}catch{}finally{I.value=!1}}function P(){Object.assign(e,{parentId:"",name:"",remark:"",userIdList:[],organizationalStructurePersonList:[]}),z.value=!1}const X=()=>b.value.filter(s=>{var o;return(o=e.value)==null?void 0:o.userIdList.includes(s.id)});return se(async()=>{try{if(I.value=!0,L.id){const{id:s,name:o,remark:i,organizationalStructurePersonList:a}=JSON.parse(L.row);e.value.id=s,e.value.name=o,e.value.remark=i,B.value=L.isClick;const{data:m}=await O.queryNotEnableStaffList({organizationalStructureId:e.value.id});m&&(b.value=m),a?(e.value.organizationalStructurePersonList=a,a.forEach(t=>{e.value.userIdList.push(t.userId)})):e.value.organizationalStructurePersonList=[]}else{const{data:s}=await O.queryAllNotEnableStaffList();s&&(b.value=s)}c.value=X(),e.value.id&&(c.value=e.value.organizationalStructurePersonList)}catch(s){console.error("Error occurred:",s)}finally{I.value=!1}}),(s,o)=>{const i=f("ElInput"),a=f("ElFormItem"),m=f("el-option"),t=f("el-select"),n=f("el-tag"),p=f("el-text"),N=f("el-switch"),C=f("ElForm"),F=f("ElButton"),Y=f("ElDialog"),Z=oe("loading");return _(),U(Y,{modelValue:z.value,"onUpdate:modelValue":o[3]||(o[3]=l=>z.value=l),title:v(J),style:{width:"48rem"},"close-on-click-modal":!1,"append-to-body":"","destroy-on-close":"",onClosed:P},{footer:d(()=>[u(F,{size:"large",onClick:P},{default:d(()=>[y(" 取消 ")]),_:1}),u(F,{type:"primary",size:"large",onClick:W},{default:d(()=>[y(" 确定 ")]),_:1})]),default:d(()=>[V((_(),U(C,{ref_key:"formRef",ref:E,model:v(e),rules:v(G),"label-width":"7rem"},{default:d(()=>[u(a,{label:"部门名称",prop:"name"},{default:d(()=>[u(i,{modelValue:v(e).name,"onUpdate:modelValue":o[0]||(o[0]=l=>v(e).name=l),placeholder:"请输入部门名称",clearable:""},null,8,["modelValue"])]),_:1}),u(a,{label:"部门主管",prop:""},{default:d(()=>[u(t,{modelValue:v(e).userIdList,"onUpdate:modelValue":o[1]||(o[1]=l=>v(e).userIdList=l),"value-key":"",placeholder:"请选择部门主管",multiple:"","collapse-tags":"","collapse-tags-tooltip":"",clearable:"",filterable:"",onChange:K},{default:d(()=>[(_(!0),S(x,null,k(v(b),l=>(_(),U(m,{key:l.value,label:l.userName,value:l.id,disabled:l.enableChargePerson===1},null,8,["label","value","disabled"]))),128))]),_:1},8,["modelValue"])]),_:1}),u(a,{label:"备注"},{default:d(()=>[u(i,{modelValue:v(e).remark,"onUpdate:modelValue":o[2]||(o[2]=l=>v(e).remark=l),placeholder:"请输入备注",clearable:""},null,8,["modelValue"])]),_:1}),(_(!0),S(x,null,k(v(c),l=>(_(),S("div",{key:l.id,class:"user"},[h("div",ie,[u(n,{type:"primary",closable:"",onClose:r=>H(l)},{default:d(()=>[y(te(l.userName),1)]),_:2},1032,["onClose"])]),h("div",re,[u(p,{style:{width:"4.375rem"}},{default:d(()=>[y("开启提成")]),_:1}),u(N,{modelValue:l.commissionStatus,"onUpdate:modelValue":r=>l.commissionStatus=r,"active-value":1,"inactive-value":2,"inline-prompt":"","active-text":"开启","inactive-text":"关闭"},null,8,["modelValue","onUpdate:modelValue"])]),V(h("div",ue,[u(t,{modelValue:l.commissionType,"onUpdate:modelValue":r=>l.commissionType=r,"value-key":"",placeholder:"计提方式",clearable:"",filterable:""},{default:d(()=>[(_(),S(x,null,k($,r=>u(m,{key:r.value,label:r.label,value:r.value},null,8,["label","value"])),64))]),_:2},1032,["modelValue","onUpdate:modelValue"])],512),[[T,l.commissionStatus===1]]),V(h("div",de,[u(t,{class:"select",modelValue:l.commissionTime,"onUpdate:modelValue":r=>l.commissionTime=r,"value-key":"",placeholder:"计提时间",clearable:"",filterable:""},{default:d(()=>[(_(),S(x,null,k(A,r=>u(m,{key:r.value,label:r.label,value:r.value},null,8,["label","value"])),64))]),_:2},1032,["modelValue","onUpdate:modelValue"])],512),[[T,l.commissionStatus===1]]),V(h("div",ce,[u(i,{modelValue:l.commission,"onUpdate:modelValue":r=>l.commission=r,placeholder:"提成比例",style:{"max-width":"25rem"},clearable:""},{append:d(()=>[y("%")]),_:2},1032,["modelValue","onUpdate:modelValue"])],512),[[T,l.commissionStatus===1]])]))),128))]),_:1},8,["model","rules"])),[[Z,v(I)]])]),_:1},8,["modelValue","title"])}}}),fe=ne(me,[["__scopeId","data-v-0fc90e13"]]);export{fe as default};


/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{d as ke,r as p,aj as Ae,n as Ce,a as S,q as Ee,o as g,b as _,f as n,w as o,v as h,g as m,A as u,i as l,s as Ve,e as w,aK as $,j,F as X,t as Y,B as Te,E as Z,_ as xe,aI as we,aJ as Ne,M as Pe}from"./index-Bi2SFuNB.js";import{_ as De,a as Ue}from"./he-DTzj0YDI.js";import{_ as q,a as Re}from"./jiantou-r_GPOlIm.js";import{o as N,s as Be}from"./apiLoading-s2lzwfnW.js";import{a as ee}from"./projectManagement-Dueq4QIj.js";import{a as le}from"./user_cooperation-CwC0K1jG.js";import{a as te}from"./survey_vip_department-CFxg4cLL.js";import{U as Oe}from"./user_supplier-CBjfn7zw.js";import{u as Ke}from"./survey_vipGroup-bi0tlCUC.js";import Me from"./index-B-qzdqS0.js";import $e from"./index-wvsPlydn.js";import qe from"./index-C_BEzyLj.js";import"./user_supplier-Cu4xN5Cg.js";import"./survey_vipGroup-96esx_qo.js";import"./index.vue_vue_type_script_setup_true_lang-BReeF26H.js";import"./index-C3qeZClt.js";import"./index-CT4nOHUR.js";import"./configuration_supplierLevel-LHerdzqR.js";import"./user_customer-B5Wtiasd.js";import"./stagedData-CHjPPmo2.js";import"./index-DjGFk39z.js";import"./index-CdmFvEX8.js";import"./index-BGNWyYM6.js";import"./clipboard-CV53RrjU.js";import"./department-BnHoc_Op.js";const E=P=>(we("data-v-bb12f5b4"),P=P(),Ne(),P),Fe={class:"icon-class"},ze=E(()=>h("img",{src:De,alt:"",style:{"margin-right":"0.25rem"}},null,-1)),He={key:0,class:"prefix-class"},Je=E(()=>h("img",{src:q,alt:"",style:{"margin-left":"0.25rem"}},null,-1)),Ge={key:1},We={class:"icon-class"},Qe=E(()=>h("img",{src:Re,alt:"",style:{"margin-right":"0.25rem"}},null,-1)),Xe={key:0,class:"prefix-class"},Ye=E(()=>h("img",{src:q,alt:"",style:{"margin-left":"0.25rem"}},null,-1)),Ze={key:1},el={class:"icon-class"},ll=E(()=>h("img",{src:Ue,alt:"",style:{"margin-right":"0.25rem"}},null,-1)),tl={key:0,class:"prefix-class"},al=E(()=>h("img",{src:q,alt:"",style:{"margin-left":"0.25rem"}},null,-1)),ol={key:1},il={style:{flex:"auto"}},nl=ke({name:"AllocationEdit",__name:"index",emits:["fetch-data"],setup(P,{expose:ae,emit:oe}){const F=Oe();Ke();const ie=oe,D=p(!1),{t:s}=Ae(),V=p(!1),B=p(),A=p(),C=p([]),ne={children:"children",label:"name"};p([]);const e=p({title:"分配",list:[],tenantSupplierList:[],departmentList:[],tenantList:[],form:{projectId:"",allocationType:1,groupSupplierIdList:[],deleteSet:[]},selectAll:{supplier:!1,member:!1,tenant:!1}}),v=p({projectId:null,allocationType:4,groupSupplierIdList:[],deleteSet:[]}),I=p({projectId:null,allocationType:2,groupSupplierIdList:[],deleteSet:[]}),d=p({projectId:null,allocationType:3,groupSupplierIdList:[],deleteSet:[]}),se=p({groupSupplierIdList:[{type:"array",required:!0,trigger:"change",message:"请选择分配目标"}]}),O=p([]),U=p();async function re(a,t){if(e.value.list=[{...a}],t==="reassign"){e.value.title="重新分配";const L=await N(ee.getProjectAllocation({projectId:a.projectId}));e.value.form.projectId=a.projectId;const{getProjectAllocationInfoList:k}=L.data;k.forEach(r=>{r.allocationType===2?I.value={allocationType:r.allocationType,projectId:r.projectId,groupSupplierIdList:r.groupSupplierIdSet}:r.allocationType===3?d.value={allocationType:r.allocationType,projectId:r.projectId,groupSupplierIdList:r.groupSupplierIdSet}:r.allocationType===4&&(v.value={allocationType:r.allocationType,projectId:r.projectId,groupSupplierIdList:r.groupSupplierIdSet},U.value=r.groupSupplierIdSet)})}else e.value.title="分配",e.value.form.projectId=a.projectId,v.value.projectId=a.projectId,I.value.projectId=a.projectId,d.value.projectId=a.projectId;e.value.tenantSupplierList=await N(F.getTenantSupplierList(a.projectId)),e.value.tenantSupplierList.length==I.value.groupSupplierIdList.length?e.value.selectAll.supplier=!0:e.value.selectAll.supplier=!1;const f=await te.list({name:""});e.value.departmentList=f.data;const b=JSON.parse(JSON.stringify(f.data));O.value=z(b),O.value.length==d.value.groupSupplierIdList.length?e.value.selectAll.member=!0:e.value.selectAll.member=!1;const c=await N(le.getAllocationBindList({projectId:a.projectId}));C.value=[],e.value.form.groupSupplierIdList&&e.value.form.allocationType===3&&(C.value=e.value.form.groupSupplierIdList),e.value.tenantList=c.data.allocationBindInfoList,e.value.tenantList.length==v.value.groupSupplierIdList.length?e.value.selectAll.tenant=!0:e.value.selectAll.tenant=!1,V.value=!0}const z=a=>a.reduce((t,f)=>{const{children:b,...c}=f;return t.push(c),f.children&&f.children.length>0&&(t=t.concat(z(f.children))),t},[]);function pe(){v.value.groupSupplierIdList=[],e.value.selectAll.tenant&&e.value.tenantList.map(a=>{v.value.groupSupplierIdList.push(a.beInvitationTenantId)})}function ue(){I.value.groupSupplierIdList=[],e.value.selectAll.supplier&&e.value.tenantSupplierList.map(a=>{I.value.groupSupplierIdList.push(a.tenantSupplierId)})}const de=()=>{e.value.tenantSupplierList.length==I.value.groupSupplierIdList.length?e.value.selectAll.supplier=!0:e.value.selectAll.supplier=!1},ce=()=>{e.value.tenantList.length==v.value.groupSupplierIdList.length?e.value.selectAll.tenant=!0:e.value.selectAll.tenant=!1},fe=()=>{d.value.groupSupplierIdList=[],e.value.departmentList.forEach(a=>{H(a)}),A.value.setCheckedKeys(d.value.groupSupplierIdList)};function H(a){d.value.groupSupplierIdList.push(a.id),a.children&&a.children.length&&a.children.forEach(t=>{H(t)})}function me(){d.value.groupSupplierIdList=[],e.value.selectAll.member?(fe(),A.value.setCheckedKeys(d.value.groupSupplierIdList)):(e.value.selectAll.member=!1,d.value.groupSupplierIdList=[],A.value.setCheckedKeys([]))}const ge=(a,t)=>{t?C.value.includes(a.id)||C.value.push(a.id):C.value=C.value.filter(L=>L!==a.id);const f=A.value.getCheckedKeys(),b=A.value.getHalfCheckedKeys(),c=[...f,...b];d.value.groupSupplierIdList=c,O.value.length==c.length?e.value.selectAll.member=!0:e.value.selectAll.member=!1},T=p(!1),x=p(!1),ve=()=>{x.value=!x.value,J(),x.value?T.value=!0:T.value=!1},J=()=>{Object.assign(v.value,{projectId:null,allocationType:4,groupSupplierIdList:[],deleteSet:[]}),Object.assign(I.value,{projectId:null,allocationType:2,groupSupplierIdList:[],deleteSet:[]}),Object.assign(d.value,{projectId:null,allocationType:3,groupSupplierIdList:[],deleteSet:[]}),e.value.selectAll.tenant=!1,e.value.selectAll.supplier=!1,e.value.selectAll.member=!1};function K(){B.value.resetFields(),J(),V.value=!1,T.value=!1,x.value=null}function Ie(){B.value.validate(async a=>{if(a)try{D.value=!0;let t={addProjectAllocationInfoList:[]};if(v.value.groupSupplierIdList.length&&(v.value.projectId=e.value.form.projectId,t.addProjectAllocationInfoList.push(v.value)),I.value.groupSupplierIdList.length&&(I.value.projectId=e.value.form.projectId,t.addProjectAllocationInfoList.push(I.value)),d.value.groupSupplierIdList.length&&(d.value.projectId=e.value.form.projectId,t.addProjectAllocationInfoList.push(d.value)),e.value.title!=="分配")t.addProjectAllocationInfoList.length||(T.value=!0),t.addProjectAllocationInfoList.map(c=>{c.projectId||(c.projectId=e.value.form.projectId),c.allocationType===4&&(c.deleteSet=[],U.value&&U.value.length&&U.value.filter(L=>{c.groupSupplierIdList.map(k=>{L!==k&&c.deleteSet.push(L)})}))});else if(!t.addProjectAllocationInfoList.length){Z.warning({message:s("allocationEdit.leastOne"),center:!0});return}let f="分配成功";T.value&&(f="取消分配成功",t={addProjectAllocationInfoList:[{projectId:e.value.form.projectId,allocationType:5,groupSupplierIdList:[],deleteSet:[]}]});const{status:b}=await Be(ee.allocation(t));D.value=!1,b===1&&Z.success({message:f,center:!0}),K(),ie("fetch-data")}catch{}finally{D.value=!1}})}p();const y=p({search:{name:""},tree:[],currentNode:void 0,currentData:void 0,dialog:{visible:!1,parentId:"",id:"",isClick:!1},row:"",loading:!1}),G=p(),W=p(),M=(a,t)=>{a=="供应商"?G.value.showEdit():a=="调查站"?(y.value.currentData=t,y.value.dialog.parentId="",y.value.dialog.id="",y.value.dialog.visible=!0):a=="合作商"&&W.value.showEdit()},he=async()=>{e.value.tenantSupplierList=await N(F.getTenantSupplierList(e.value.form.projectId))},ye=async()=>{const a=await te.list({name:""});e.value.departmentList=a.data},Se=async()=>{const a=await N(le.getAllocationBindList({projectId:e.value.form.projectId}));e.value.tenantList=a.data.allocationBindInfoList};return Ce(async()=>{}),ae({showEdit:re}),(a,t)=>{const f=S("el-table-column"),b=S("el-table"),c=S("el-checkbox"),L=S("el-option"),k=xe,r=S("el-button"),Q=S("el-select"),R=S("el-form-item"),Le=S("el-tree-select"),_e=S("el-form"),be=S("el-dialog"),je=Ee("loading");return g(),_("div",null,[n(be,{modelValue:l(V),"onUpdate:modelValue":t[10]||(t[10]=i=>Te(V)?V.value=i:null),title:l(e).title,width:"700","before-close":K},{footer:o(()=>[h("div",il,[n(r,{onClick:K},{default:o(()=>[m(u(l(s)("allocationEdit.cancel")),1)]),_:1}),n(r,{type:"primary",onClick:Ie},{default:o(()=>[m(u(l(s)("allocationEdit.confirm")),1)]),_:1})])]),default:o(()=>[Ve((g(),w(b,{data:l(e).list,"row-key":"id"},{default:o(()=>[n(f,{align:"left","show-overflow-tooltip":"",label:l(s)("allocationEdit.projectName"),prop:"name"},null,8,["label"]),n(f,{align:"left","show-overflow-tooltip":"",label:l(s)("allocationEdit.projectCode"),prop:"projectId"},null,8,["label"]),n(f,{align:"left","show-overflow-tooltip":"",label:l(s)("allocationEdit.CustomerAbbreviation"),width:"100",prop:"clientName"},null,8,["label"])]),_:1},8,["data"])),[[je,l(D)]]),n(_e,{ref_key:"formRef",ref:B,"label-width":"90px",rules:l(se),model:l(e).form,inline:!1,"label-position":"left",prop:"groupSupplierIdList"},{default:o(()=>[n(R,{style:{"margin-top":"1rem"}},{label:o(()=>[h("span",Fe,[ze,m(" "+u(l(s)("allocationEdit.supplier")),1)])]),default:o(()=>[n(Q,{modelValue:l(I).groupSupplierIdList,"onUpdate:modelValue":t[2]||(t[2]=i=>l(I).groupSupplierIdList=i),clearable:"",filterable:"",multiple:"","collapse-tags":"","collapse-tags-tooltip":"","max-collapse-tags":10,placeholder:"",onChange:de},$({prefix:o(()=>[l(e).tenantSupplierList.length==0?(g(),_("span",He,[m(u(l(s)("allocationEdit.supplierMaintenance"))+" ",1),Je])):j("",!0),l(I).groupSupplierIdList.length==0&&l(e).tenantSupplierList.length!=0?(g(),_("span",Ge,u(l(s)("allocationEdit.supplierSelect")),1)):j("",!0)]),empty:o(()=>[h("div",null,[n(r,{type:"primary",link:"",class:"buttonClass",size:"small",onClick:t[1]||(t[1]=i=>M("供应商"))},{default:o(()=>[m(u(l(s)("allocationEdit.quickAdd"))+" ",1),n(k,{name:"ant-design:plus-outlined",color:"#fff",style:{"background-color":"var(--el-color-primary)","border-radius":"50%",padding:"0.125rem",margin:"0 0.125rem"}})]),_:1})])]),default:o(()=>[(g(!0),_(X,null,Y(l(e).tenantSupplierList,i=>(g(),w(L,{label:i.supplierAccord,key:i.supplierAccord,value:i.tenantSupplierId},null,8,["label","value"]))),128))]),_:2},[l(e).tenantSupplierList.length?{name:"header",fn:o(()=>[n(c,{modelValue:l(e).selectAll.supplier,"onUpdate:modelValue":t[0]||(t[0]=i=>l(e).selectAll.supplier=i),onChange:ue,style:{display:"flex",height:"unset"}},{default:o(()=>[m(u(l(s)("allocationEdit.selectAll")),1)]),_:1},8,["modelValue"])]),key:"0"}:void 0]),1032,["modelValue"])]),_:1}),n(R,null,{label:o(()=>[h("span",We,[Qe,m(" "+u(l(s)("allocationEdit.SurveyStation")),1)])]),default:o(()=>[n(Le,{ref_key:"treeRef",ref:A,modelValue:l(d).groupSupplierIdList,"onUpdate:modelValue":t[5]||(t[5]=i=>l(d).groupSupplierIdList=i),data:l(e).departmentList,"show-checkbox":"","default-expand-all":"","node-key":"id",props:ne,onCheckChange:ge,"check-strictly":!0,"check-on-click-node":!0,multiple:!0,"expand-on-click-node":!1,style:{width:"37.625rem"},clearable:"",placeholder:""},$({prefix:o(()=>[l(e).departmentList.length==0?(g(),_("span",Xe,[m(u(l(s)("allocationEdit.SurveyStationMaintenance"))+" ",1),Ye])):j("",!0),!l(d).groupSupplierIdList.length&&l(e).departmentList.length!=0?(g(),_("span",Ze,u(l(s)("allocationEdit.SurveyStationSelect")),1)):j("",!0)]),empty:o(()=>[h("div",null,[n(r,{type:"primary",link:"",class:"buttonClass",size:"small",onClick:t[4]||(t[4]=i=>M("调查站"))},{default:o(()=>[m(u(l(s)("allocationEdit.quickAdd"))+" ",1),n(k,{name:"ant-design:plus-outlined",color:"#fff",style:{"background-color":"var(--el-color-primary)","border-radius":"50%",padding:"0.125rem",margin:"0 0.125rem"}})]),_:1})])]),_:2},[l(e).departmentList.length?{name:"header",fn:o(()=>[n(c,{modelValue:l(e).selectAll.member,"onUpdate:modelValue":t[3]||(t[3]=i=>l(e).selectAll.member=i),onChange:me,style:{display:"flex",height:"unset"}},{default:o(()=>[m(u(l(s)("allocationEdit.selectAll")),1)]),_:1},8,["modelValue"])]),key:"0"}:void 0]),1032,["modelValue","data"])]),_:1}),n(R,null,{label:o(()=>[h("span",el,[ll,m(" "+u(l(s)("allocationEdit.partner")),1)])]),default:o(()=>[n(Q,{modelValue:l(v).groupSupplierIdList,"onUpdate:modelValue":t[8]||(t[8]=i=>l(v).groupSupplierIdList=i),clearable:"",filterable:"",multiple:"","collapse-tags":"","collapse-tags-tooltip":"","max-collapse-tags":10,placeholder:"",onChange:ce},$({prefix:o(()=>[l(e).tenantList.length==0?(g(),_("span",tl,[m(u(l(s)("allocationEdit.partnerMaintenance"))+" ",1),al])):j("",!0),l(v).groupSupplierIdList.length==0&&l(e).tenantList.length!=0?(g(),_("span",ol,u(l(s)("allocationEdit.partnerSelect")),1)):j("",!0)]),empty:o(()=>[h("div",null,[n(r,{type:"primary",link:"",class:"buttonClass",size:"small",onClick:t[7]||(t[7]=i=>M("合作商"))},{default:o(()=>[m(u(l(s)("allocationEdit.quickAdd"))+" ",1),n(k,{name:"ant-design:plus-outlined",color:"#fff",style:{"background-color":"var(--el-color-primary)","border-radius":"50%",padding:"0.125rem",margin:"0 0.125rem"}})]),_:1})])]),default:o(()=>[(g(!0),_(X,null,Y(l(e).tenantList,i=>(g(),w(L,{label:i.beInvitationTenantName,key:i.beInvitationTenantName,value:i.beInvitationTenantId},null,8,["label","value"]))),128))]),_:2},[l(e).tenantList.length?{name:"header",fn:o(()=>[n(c,{modelValue:l(e).selectAll.tenant,"onUpdate:modelValue":t[6]||(t[6]=i=>l(e).selectAll.tenant=i),onChange:pe,style:{display:"flex",height:"unset"}},{default:o(()=>[m(u(l(s)("allocationEdit.selectAll")),1)]),_:1},8,["modelValue"])]),key:"0"}:void 0]),1032,["modelValue"])]),_:1}),l(e).title=="重新分配"?(g(),w(R,{key:0},{label:o(()=>[n(r,{type:l(x)?"primary":"",onClick:t[9]||(t[9]=i=>ve()),style:{"border-radius":"1.875rem"}},{default:o(()=>[m(u(l(s)("allocationEdit.unassign")),1)]),_:1},8,["type"])]),_:1})):j("",!0)]),_:1},8,["rules","model"])]),_:1},8,["modelValue","title"]),n($e,{ref_key:"editRef",ref:G,onFetchData:he},null,512),l(y).dialog.visible?(g(),w(Me,{key:0,id:l(y).dialog.id,modelValue:l(y).dialog.visible,"onUpdate:modelValue":t[11]||(t[11]=i=>l(y).dialog.visible=i),row:l(y).row,"parent-id":l(y).dialog.parentId,tree:l(y).tree,isClick:l(y).dialog.isClick,onGetList:ye},null,8,["id","modelValue","row","parent-id","tree","isClick"])):j("",!0),n(qe,{ref_key:"tenantRef",ref:W,onFetchData:Se},null,512)])}}}),wl=Pe(nl,[["__scopeId","data-v-bb12f5b4"]]);export{wl as default};


/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{d as W,aj as X,aB as Y,l as ee,r as s,Z as x,$ as y,n as te,a as A,q as oe,o as E,b as ae,f as p,w as d,v as re,s as h,aH as V,g as b,A as w,i as f,e as ie,j as se,ap as g,E as n,_ as ne,M as ce}from"./index-CBBxVEK9.js";import le from"./index-DD7yk8Xp.js";import{u as ue}from"./projectManagement_list-DVJ51hRH.js";import{u as pe}from"./stagedData-C7Djdjmu.js";import{u as de}from"./user_customer-rnisbOaO.js";import{a as I}from"./projectManagement-DCiBfrlb.js";import"./index-1-zf9NRg.js";import"./download-C9BGNMp9.js";import"./zh_Hans-BiAfgf-k.js";import"./index-Bmb2yTfB.js";/* empty css              */import"./index-Cxyq_HbB.js";import"./index.vue_vue_type_script_setup_true_lang-bGwPysAD.js";import"./index-CBzyQRFs.js";import"./index-BxlS9xjj.js";import"./index-D5y_2O8h.js";import"./clipboard-DI1h4Q1h.js";import"./index-DGZqqirl.js";import"./department-B9A_bESW.js";import"./position_manage-DUbchnfl.js";import"./configuration_role-DW4e5t-D.js";import"./tenant_role-Bo86g2CF.js";import"./configuration_manager-CGfFnCYW.js";import"./configuration_siteSetting-BGCkeXJk.js";import"./configuration_site_setting-DTItBin0.js";import"./apiLoading-D97kUiu0.js";import"./index.vue_vue_type_script_setup_true_lang-9NNKFQ4h.js";import"./otherFunctions_screenLibrary-odd6WoTb.js";import"./pdf-BhHCHn5I.js";import"./index.vue_vue_type_script_setup_true_lang-BJNHg0Lc.js";const me={class:"flex-c"},fe=W({name:"ProjeckEdit",__name:"index",emits:["fetch-data"],setup(ge,{expose:k,emit:C}){const{t:j}=X();Y();const v=ue(),L=pe(),U=ee(),M=de(),Q=C,m=s(!1),c=s(""),i=s(!1),l=s([]),P=s(""),u=s([]);function R(e){l.value.push(e)}function B(e){P.value=e}x("validateTopTabs",R),x("currentProjectTimeline",B);let r=y([]);const T=s();async function N(e){try{if(i.value=!0,e)if(c.value="编辑",e.projectType===2)_(e);else{const o=await I.detail({projectId:e.projectId});o.data&&_(o.data)}else{c.value="新增";const o=g(v.initialTopTabsData);r=L.projectManagementList||y([o])}m.value=!0,u.value=[],l.value=[],i.value=!1}catch{}finally{i.value=!1}}function _(e){e.data={configurationInformation:{initialProblem:{countryId:null,projectProblemCategoryId:null,projectQuotaQuestionType:null,projectProblemId:null,keyValue:"",questionType:null,answerValueList:[],projectAnswerIdList:[]},configurationCountryList:null,projectCategoryList:null,ProjectProblemInfoList:[]}},r=[];const{projectInfoList:o,...t}=g(e);t.browser&&(t.browser=t.browser.split(",")),t.operatingSystem&&(t.operatingSystem=t.operatingSystem.split(",")),t.descriptionUrl?t.descriptionUrl=t.descriptionUrl.split(","):t.descriptionUrl=[],r.push(t),o&&o.length&&o.forEach(a=>{a.data={configurationInformation:{initialProblem:{countryId:null,projectProblemCategoryId:null,projectQuotaQuestionType:null,projectProblemId:null,keyValue:"",questionType:null,answerValueList:[],projectAnswerIdList:[]},configurationCountryList:null,projectCategoryList:null,ProjectProblemInfoList:[]}},a.descriptionUrl=a.descriptionUrl.split(","),r.push({...a})}),v.dataBeforeEditing=g(r)}function O(){L.projectManagementList=g(r),r=y([]),m.value=!1,l.value=[]}async function D(){const e=[];l.value.forEach(t=>{e.push(t.validate())});const o=await Promise.allSettled(e);u.value=o.map(t=>t.status)}function q(e){const o=new Set;for(const t of e){if(o.has(t.name))return!0;o.add(t.name)}return!1}const F=e=>{e.data.configurationInformation.ProjectProblemInfoList.forEach(o=>{const t=e.projectQuotaInfoList.find(a=>a.projectProblemId===o.id);t?t.answerValueList.length===0&&t.projectAnswerIdList.length===0&&(t.answerValueList=o.getProjectAnswerInfoList.map(a=>a.anotherName),t.projectAnswerIdList=o.getProjectAnswerInfoList.map(a=>a.id)):e.projectQuotaInfoList.push({projectProblemId:o.id,answerValueList:o.getProjectAnswerInfoList.map(a=>a.anotherName),projectAnswerIdList:o.getProjectAnswerInfoList.map(a=>a.id)})})},z=async()=>{r.forEach(t=>{t.projectQuotaInfoList.forEach(a=>{a.answerValueList.length===0&&a.projectAnswerIdList.length===0&&F(t),a.questionType==1&&(a.projectAnswerIdList=a.answerValueList)})});const e=g(r);await v.compareProjectData(v.dataBeforeEditing,e),await e.forEach(t=>{t.descriptionUrl=t.descriptionUrl.join(","),(!t.data.configurationInformation.ProjectProblemInfoList||!t.data.configurationInformation.ProjectProblemInfoList.length)&&(t.isProfile=2),t.data&&delete t.data,t.isProfile==2?t.projectQuotaInfoList=[]:t.projectQuotaInfoList=t.projectQuotaInfoList.map(a=>(Array.isArray(a.answerValueList)||(a.answerValueList=[]),Array.isArray(a.projectAnswerIdList)||(a.projectAnswerIdList=[]),a))});let o=e[0];return o.projectInfoList=e.slice(1).map(t=>(t.browser=t.browser.join(","),t.operatingSystem=t.operatingSystem.join(","),{...t,memberPrice:(t.doMoneyPrice*t.exchangeRate).toFixed(2)})),o},H=e=>({projectOutsideInfoId:e.projectOutsideInfoId??null,projectId:e.projectId,doMoneyPrice:e.doMoneyPrice,currencyType:e.currencyType,exchangeRate:e.exchangeRate,memberPrice:e.memberPrice,num:e.num,minimumDuration:e.minimumDuration,ir:e.ir,mutualExclusionId:e.mutualExclusionId,remark:e.remark,descriptionUrl:e.descriptionUrl,richText:e.richText,ipDifferenceDetection:e.ipDifferenceDetection,limitedQuantity:e.limitedQuantity,preNum:e.preNum});async function $(){if(i.value=!0,await D(),u.value.every(e=>e==="fulfilled"))if(q(r))n({message:"项目名称重复",center:!0});else{const e=await z();e.browser=e.browser.join(","),e.operatingSystem=e.operatingSystem.join(","),setTimeout(async()=>{if(!e.endAge||!e.startAge){n.warning({message:"年龄区间未填写完整",center:!0});return}if(c.value==="新增"){if(e.memberPrice=(e.doMoneyPrice*e.exchangeRate).toFixed(2),e.minimumDuration=+e.minimumDuration,!e.exchangeRate){n.warning({message:"请设置汇率",center:!0});return}const{status:o}=await I.create(e);o===1&&n.success({message:"新增成功",center:!0})}else if(e.projectType===2){e.memberPrice=(e.doMoneyPrice*e.exchangeRate).toFixed(2);const o=H(e),{status:t}=await I.addOrUpdateProjectOutsideInfo(o);t===1&&n.success({message:"编辑成功",center:!0})}else{const{status:o}=await I.edit(e);o===1&&n.success({message:"编辑成功",center:!0})}Q("fetch-data"),S()},1e3)}else T.value.activeLeftTab=u.value.indexOf("rejected"),n.warning({message:j("projectEdit.perfect"),center:!0});i.value=!1}function S(){r=y([]),u.value=[],l.value=[],m.value=!1,c.value==="新增"&&(L.projectManagementList=null)}const Z=async()=>{await M.getCustomerList(),await U.getCountry()};return te(async()=>{await Z()}),k({showEdit:N}),(e,o)=>{const t=ne,a=A("el-button"),G=A("el-drawer"),J=oe("loading");return E(),ae("div",null,[p(G,{modelValue:m.value,"onUpdate:modelValue":o[0]||(o[0]=K=>m.value=K),class:"projectDrawer","append-to-body":"","close-on-click-modal":!1,"destroy-on-close":"",draggable:"",size:"75%"},{footer:d(()=>[re("div",me,[h(p(a,{link:""},{default:d(()=>[p(t,{name:"ant-design:clock-circle-outlined"}),b("   "+w(P.value),1)]),_:1},512),[[V,P.value]]),p(a,{type:"primary",onClick:$,disabled:i.value},{default:d(()=>[b(w(f(j)("projectEdit.releaseProject")),1)]),_:1},8,["disabled"]),h(p(a,{type:"warning",onClick:O,disabled:i.value},{default:d(()=>[b(w(f(j)("projectEdit.temporaryStorage")),1)]),_:1},8,["disabled"]),[[V,c.value!=="编辑"]]),p(a,{onClick:S,disabled:i.value},{default:d(()=>[b(w(f(j)("projectEdit.cancel")),1)]),_:1},8,["disabled"])])]),default:d(()=>[f(r).length?h((E(),ie(le,{key:0,onValidate:D,ref_key:"LeftTabsRef",ref:T,"left-tabs-data":f(r),"validate-top-tabs":l.value,"validate-all":u.value,title:c.value},null,8,["left-tabs-data","validate-top-tabs","validate-all","title"])),[[J,i.value]]):se("",!0)]),_:1},8,["modelValue"])])}}}),$e=ce(fe,[["__scopeId","data-v-d6268041"]]);export{$e as default};

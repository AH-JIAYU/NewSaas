
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{a as O}from"./group_team-CW0dOlW-.js";import{a as ie}from"./department-qU_DcxYy.js";import{u as ce}from"./department-BZW3eNAy.js";import{u as fe}from"./configuration_manager-CaoXwvYY.js";import{u as me}from"./position_manage-KvNB3Dij.js";import{d as pe,aO as _e,r as u,k as ve,a as c,p as he,q as ge,o as d,b as k,f as s,w as e,s as U,g as v,e as p,H as g,F as V,t as N,j as C,E as $,aJ as be,aK as Ie,R as ye}from"./index-D5QRSD_b.js";import"./position_manage-BIWUPvv7.js";const ke=w=>(be("data-v-2cad1137"),w=w(),Ie(),w),we=ke(()=>U("div",{class:"card-header"},[U("span",null,"组成员")],-1)),xe={style:{flex:"auto"}},Se=pe({name:"Edit",__name:"index",emits:["success"],setup(w,{expose:J,emit:q}){_e();const B=u(),z=u(),E=me(),M=u(),A=ce(),b=u(),G=fe(),L=u([]),K=q,T=u(""),Q=u(),I=u(!1);u([]);const D=u(),y=u(!1),_=u([]),j=u([]),R=u();u({loading:!1,tableAutoHeight:!1,border:!0,stripe:!1,lineHeight:"default",checkList:[],search:{chineseName:""},dataList:[],selectionDataList:[],row:"",dialog:{visible:!1,id:"",parentId:"",level:1}});const x=u(null),f=u({groupId:null,userInfo:[],menuId:[]}),W={children:"children",label:"name"},X=u({commission:[{validator:(t,n,o)=>{/^[0-9]*[.]?[0-9]+$/.test(n)?o():o(new Error("请输入有效的数字或小数"))},trigger:"blur"}]});async function Y(t){try{I.value=!0,T.value=t!=null&&t.id?"编辑":"新增";const n=JSON.parse(t);f.value.groupId=n.id,R.value=n.departmentId;const o={page:1,limit:10,groupId:n.id},m=await O.list(o);m!=null&&m.data.data&&m.data.data.forEach(a=>{var h,S;(S=(h=f.value)==null?void 0:h.menuId)==null||S.push(a.id),_.value.push(a)});const r=await ie.createEvery();b.value=r.data.result,b.value=b.value.filter(a=>a.id===R.value),I.value=!1,y.value=!0}catch{}finally{I.value=!1}}const Z=()=>{x&&(_.value=b.value[0].children.filter(t=>t.userName.includes(x.value)))};ve(async()=>{M.value=await(E==null?void 0:E.getPositionManage())||[],b.value=await A.getDepartment(),L.value=await G.getStaff(),Q.value=new Date});function F(t,n){const o=t.findIndex(m=>m.memberId===n);o!==-1&&t.splice(o,1)}function P(t,n){t.some(o=>o.id===n.id)||t.push(n)}function ee(t){_.value=_.value.filter(o=>o.id!==t.id),B.value.getNode(t.id).checked?t.children&&t.children.length?t.children.forEach(o=>P(_.value,o)):P(_.value,t):t.children&&t.children.length?t.children.forEach(o=>F(_.value,o.id)):F(_.value,t.id)}function te(){return new Promise(t=>{D.value&&D.value.validate(n=>{if(n)try{I.value=!0,f.value.userInfo=[],delete f.value.menuId;let o=0;j.value.forEach(r=>{r.commission&&(o+=r.commission);let a={userId:r.memberId,commission:r.commission};f.value.userInfo.push(a)}),_.value.forEach(r=>{r.commission&&(o+=r.commission);let a;r.memberId?a={userId:r.memberId,commission:r.commission}:a={userId:r.id,commission:r.commission},f.value.userInfo.push(a)});const m=new Set;if(f.value.userInfo=f.value.userInfo.filter(r=>{const{userId:a}=r;return m.has(a)?!1:(m.add(a),!0)}),o>100){$.warning({message:"提成比例不能超过100",center:!0});return}O.edit(f.value).then(()=>{I.value=!1,$.success({message:"操作成功",center:!0}),K("success"),y.value=!1,t()})}catch{}finally{I.value=!1}})})}const ae=()=>{Object.assign(f.value,{groupId:null,userInfo:[],menuId:[]}),j.value=[],_.value=[]};return J({showEdit:Y}),(t,n)=>{const o=c("el-input"),m=c("el-tree"),r=c("el-col"),a=c("el-text"),h=c("el-table-column"),S=c("el-form-item"),le=c("el-form"),oe=c("el-empty"),ne=c("el-table"),se=c("el-row"),re=c("el-card"),H=c("el-button"),ue=c("el-drawer"),de=he("loading");return ge((d(),k("div",null,[s(ue,{modelValue:y.value,"onUpdate:modelValue":n[2]||(n[2]=l=>y.value=l),title:T.value,onClose:ae,size:"60%"},{footer:e(()=>[U("div",xe,[s(H,{type:"",onClick:n[1]||(n[1]=l=>y.value=!1)},{default:e(()=>[v(" 取消 ")]),_:1}),s(H,{type:"primary",onClick:te},{default:e(()=>[v(" 确定 ")]),_:1})])]),default:e(()=>[s(re,{class:"box-card"},{header:e(()=>[we]),default:e(()=>[s(se,{gutter:20},{default:e(()=>[s(r,{class:"leftData",span:8},{default:e(()=>[s(o,{modelValue:x.value,"onUpdate:modelValue":n[0]||(n[0]=l=>x.value=l),placeholder:"可输入用户名查找",clearable:"",onBlur:Z},null,8,["modelValue"]),s(m,{style:{"max-width":"37.5rem","min-height":"20.125rem","margin-top":"20px"},data:b.value,ref_key:"treeRef",ref:B,"show-checkbox":"","node-key":"id","default-checked-keys":f.value.menuId,"default-expanded-keys":f.value.menuId,"default-expand-all":"",props:W,onCheck:ee},null,8,["data","default-checked-keys","default-expanded-keys"])]),_:1}),s(r,{span:16},{default:e(()=>[s(ne,{ref_key:"tableRef",ref:z,data:_.value,border:""},{empty:e(()=>[s(oe,{description:"暂无数据"})]),default:e(()=>[s(h,{align:"center","show-overflow-tooltip":"",prop:"memberId",label:"员工ID"},{default:e(({row:l})=>[l.id?(d(),p(a,{key:0},{default:e(()=>[v(g(l.id),1)]),_:2},1024)):(d(),p(a,{key:1},{default:e(()=>[v(g(l.id),1)]),_:2},1024))]),_:1}),s(h,{align:"center","show-overflow-tooltip":"",prop:"userName",label:"用户名"},{default:e(({row:l})=>[l.id?(d(!0),k(V,{key:0},N(L.value,i=>(d(),p(a,null,{default:e(()=>[l.id===i.id?(d(),p(a,{key:0},{default:e(()=>[v(g(i.name),1)]),_:2},1024)):C("",!0)]),_:2},1024))),256)):(d(),p(a,{key:1},{default:e(()=>[v(g(l.userName?l.userName:"-"),1)]),_:2},1024))]),_:1}),s(h,{align:"center","show-overflow-tooltip":"",prop:"name",label:"姓名"},{default:e(({row:l})=>[l.id?(d(!0),k(V,{key:0},N(L.value,i=>(d(),p(a,null,{default:e(()=>[l.id===i.id?(d(),p(a,{key:0},{default:e(()=>[v(g(i.name),1)]),_:2},1024)):C("",!0)]),_:2},1024))),256)):(d(),p(a,{key:1},{default:e(()=>[v(g(l.name),1)]),_:2},1024))]),_:1}),s(h,{align:"center","show-overflow-tooltip":"",prop:"lable",label:"职位"},{default:e(({row:l})=>[(d(!0),k(V,null,N(M.value,i=>(d(),p(a,null,{default:e(()=>[l.positionId===i.id?(d(),p(a,{key:0},{default:e(()=>[v(g(i.name),1)]),_:2},1024)):C("",!0)]),_:2},1024))),256))]),_:1}),s(h,{align:"center","show-overflow-tooltip":"",prop:"lable",label:"部门"},{default:e(({row:l})=>[(d(!0),k(V,null,N(b.value,i=>(d(),p(a,null,{default:e(()=>[R.value===i.id?(d(),p(a,{key:0},{default:e(()=>[v(g(i.name),1)]),_:2},1024)):C("",!0)]),_:2},1024))),256))]),_:1}),s(h,{align:"center",width:"200",fixed:"right","show-overflow-tooltip":"",label:"提成比例"},{default:e(({row:l})=>[s(le,{model:l,ref_key:"formRef",ref:D,rules:X.value},{default:e(()=>[s(S,{prop:"commission"},{default:e(()=>[s(o,{modelValue:l.commission,"onUpdate:modelValue":i=>l.commission=i,modelModifiers:{number:!0},placeholder:"请输入提成比例",clearable:""},{append:e(()=>[v("%")]),_:2},1032,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1032,["model","rules"])]),_:1})]),_:1},8,["data"])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue","title"])])),[[de,I.value]])}}}),Ue=ye(Se,[["__scopeId","data-v-2cad1137"]]);export{Ue as default};

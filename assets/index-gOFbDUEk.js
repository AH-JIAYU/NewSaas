
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{k as H,ag as J,r as c,d as O,bw as Q,n as W,ao as X,E as P,a as h,q as Y,s as Z,i as o,o as _,b as w,f as k,w as v,e as x,g as U,y as E,z as K,F as j,t as ee,j as V,bx as le,L as te}from"./index-Cy1wtqF8.js";import{a as T}from"./configuration_role-D6IVVuos.js";const oe={list:()=>H.get("role/getRoleButton")},se=J("buttonPermission",()=>{const g=c([]);return{permissions:g,getPermissions:async()=>{if(g.value.length)return g.value;const{data:y}=await oe.list();return g.value=y,y}}}),ae=se,ne={class:"custom-tree-node"},re={class:"menu"},ue={class:"permission"},ie={key:0,class:"permissions"},ce=O({__name:"index",props:["id","row"],setup(g,{expose:R}){const y=g,N=Q(),q=ae(),r=c(!1);c(!1);const A=c(),f=c(),I=c([]),s=c([]),e=c({id:y.id??null,menuId:[],permission:[],roleName:"",remark:"",checkAll:!1}),D=c({roleName:[{required:!0,message:"请输入角色名称",trigger:"blur"}]}),L=c(null);W(async()=>{try{r.value=!0,s.value=await q.getPermissions(),I.value=N.routesRaw,e.value.id!==""?await M():(e.value.menuId=[],e.value.permission=[],e.value.checkAll=!1),r.value=!1}catch{}finally{r.value=!1}s.value.length==e.value.permission.length&&(e.value.checkAll=!0)});const B=c(),G=()=>{L.value=le.service({target:B.value,text:"请稍后...",spinner:"el-icon-loading",background:"rgba(0, 0, 0, 0.7)",customClass:"custom-target-loading",lock:!0}),setTimeout(()=>{e.value.checkAll?(e.value.menuId=[],e.value.permission=[],I.value.length&&I.value.forEach(t=>{e.value.menuId.push(t.id)}),s.value.length&&s.value.forEach(t=>{e.value.permission.push(t.id)}),f.value.setCheckedNodes([...e.value.permission,...e.value.menuId])):(e.value.checkAll=!1,e.value.menuId=[],e.value.permission=[],f.value.setCheckedNodes([])),L.value.close()},2e3)};async function M(){r.value=!0;const{menuId:t,...l}=JSON.parse(y.row);e.value=l;const u=await N.obtainLevel1AndLevel2Routing();e.value.menuId=t.filter(a=>!u.some(n=>n.id===a)),r.value=!1}function F(t){var l;return(l=s==null?void 0:s.value)==null?void 0:l.filter(u=>t===u.menuId)}const $=t=>{const l=[];l.push(t),f.value.getNode(t.id).checked?l.map(a=>{var d;const n=(d=s==null?void 0:s.value)==null?void 0:d.filter(i=>a.id===i.menuId);n&&n.length&&n.forEach(i=>{e.value.permission.push(i.id)})}):l.map(a=>{var d;const n=(d=s==null?void 0:s.value)==null?void 0:d.filter(i=>a.id===i.menuId);if(n&&n.length){let i=n.map(p=>p.id);e.value.permission=e.value.permission.filter(p=>!i.some(C=>C===p))}}),s.value.length==e.value.permission.length&&(e.value.checkAll=!0)};return R({submit(){r.value=!0;const t=X(e.value);return new Promise((l,u)=>{try{t.menuId=f.value.getCheckedKeys(!1);const a=f.value.getCheckedKeys(),n=f.value.getHalfCheckedKeys(),d=a.concat(n);t.menuId=d,e.value.menuId=d,A.value.validate(async i=>{if(!i)return r.value=!1,u(new Error("验证不通过"));try{t.id===""?(await T.create(t),P.success({message:"新增成功",center:!0})):(await T.edit(t),P.success({message:"编辑成功",center:!0})),l()}catch(p){u(p)}finally{r.value=!1}})}catch(a){r.value=!1,u(a)}})}}),(t,l)=>{const u=h("ElInput"),a=h("ElFormItem"),n=h("el-checkbox"),d=h("ElCheckbox"),i=h("ElCheckboxGroup"),p=h("el-tree"),C=h("ElForm"),z=Y("loading");return Z((_(),w("div",{ref_key:"eleDivRef",ref:B,style:{height:"90vh"}},[k(C,{ref_key:"formRef",ref:A,model:o(e),rules:o(D),"label-width":"120px"},{default:v(()=>[k(a,{label:"角色名称",prop:"roleName"},{default:v(()=>[k(u,{modelValue:o(e).roleName,"onUpdate:modelValue":l[0]||(l[0]=m=>o(e).roleName=m),placeholder:"请输入角色名称"},null,8,["modelValue"])]),_:1}),k(a,{label:"备注",prop:"remark"},{default:v(()=>[k(u,{modelValue:o(e).remark,"onUpdate:modelValue":l[1]||(l[1]=m=>o(e).remark=m),placeholder:"请输入备注"},null,8,["modelValue"])]),_:1}),o(r)?V("",!0):(_(),x(a,{key:0,label:"权限"},{default:v(()=>[k(n,{modelValue:o(e).checkAll,"onUpdate:modelValue":l[2]||(l[2]=m=>o(e).checkAll=m),onChange:G},{default:v(()=>[U("全选/取消全选")]),_:1},8,["modelValue"]),o(e).menuId?(_(),x(p,{key:0,ref_key:"treeRef",ref:f,data:o(I),style:{width:"100%"},"default-checked-keys":o(e).menuId,"default-expanded-keys":[],"node-key":"id","show-checkbox":"",onCheckChange:$,"default-expand-all":"",border:""},{default:v(({data:m})=>{var S;return[E("div",ne,[E("div",re,K(m.meta.title),1),E("div",ue,[(S=F(m.id))!=null&&S.length?(_(),w("div",ie,[k(i,{modelValue:o(e).permission,"onUpdate:modelValue":l[3]||(l[3]=b=>o(e).permission=b)},{default:v(()=>[(_(!0),w(j,null,ee(F(m.id),b=>(_(),x(d,{key:b.id,value:b.id},{default:v(()=>[U(K(b.label),1)]),_:2},1032,["value"]))),128))]),_:2},1032,["modelValue"])])):V("",!0)])])]}),_:1},8,["data","default-checked-keys"])):V("",!0)]),_:1}))]),_:1},8,["model","rules"])])),[[z,o(r)]])}}}),ve=te(ce,[["__scopeId","data-v-5e2bc09f"]]);export{ve as default};

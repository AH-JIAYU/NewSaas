
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{d as W,m as U,r as v,u as X,c as Y,n as Z,a as p,q as ee,s as C,i as d,o as f,e as D,w as i,f as n,g as V,b as y,t as k,F as w,v as z,A as ae,aq as le,E as q,M as se}from"./index-CRiLI5We.js";import{a as T}from"./department-DG0uSGnK.js";import{u as te}from"./configuration_manager-DxyzEd4E.js";const oe={class:"mr"},ne={class:"mr checkbox-container"},re={class:"centers mr"},ue=W({__name:"index",props:U({parentId:{default:""},id:{default:""},tree:{},row:{}},{modelValue:{type:Boolean,default:!1},modelModifiers:{}}),emits:U(["getList"],["update:modelValue"]),setup(E,{emit:B}){const F=te(),g=v([]),_=E,M=[{label:"完成计提",value:1},{label:"审核计提",value:2},{label:"结算计提",value:3}],I=v(!1),N=B,S=X(E,"modelValue"),O=Y(()=>_.id===""?"新增部门":"编辑部门"),r=v([]),b=v();v([]);const e=v({parentId:_.parentId,name:"",remark:"",userIdList:[],organizationalStructurePersonList:[]}),R=v({name:[{required:!0,message:"请输入部门名称"}],commissionType:[{required:!0,message:"请选择计提方式",trigger:"change"}]});async function j(){b.value&&b.value.validate(async o=>{if(o){e.value.organizationalStructurePersonList=[],r.value.forEach(a=>{const c={userId:a.id,commission:a.commission,commissionType:a.commissionType,commissionStatus:a.commissionStatus};e.value.organizationalStructurePersonList.push(c)});const l=e.value.organizationalStructurePersonList.reduce((a,c)=>(a.some(L=>L.userId===c.userId)||a.push(c),a),[]);e.value.organizationalStructurePersonList=l;const t={...e.value};if(delete t.userIdList,e.value.id){console.log("params",t),console.log("filteredUsers",r.value);const{status:a}=await T.edit(t);a===1&&q.success({message:"编辑成功",center:!0})}else{console.log("params",t);const{status:a}=await T.create(t);a===1&&q.success({message:"新增成功",center:!0})}await N("getList"),h()}})}const A=o=>{if(o.userId){const a=e.value.userIdList.indexOf(o.userId);a!==-1&&e.value.userIdList.splice(a,1)}else{const a=e.value.userIdList.indexOf(o.id);a!==-1&&e.value.userIdList.splice(a,1)}const l=e.value.organizationalStructurePersonList.findIndex(a=>a.id===o.id||a.userId===o.id);l!==-1&&e.value.organizationalStructurePersonList.splice(l,1);const t=r.value.findIndex(a=>a.id===o.id||a.userId===o.id);t!==-1&&r.value.splice(t,1)},J=o=>{var l;if(e.value.userIdList=o,r.value=g.value.filter(t=>{var a;return(a=e.value)==null?void 0:a.userIdList.includes(t.id)}),(l=e.value)!=null&&l.userIdList.length){const t=[];e.value.organizationalStructurePersonList.forEach(u=>{t.push(u)}),r.value.forEach(u=>{e.value.organizationalStructurePersonList.some(x=>x.userId===u.id)||t.push(u)});const c=Array.from(new Map(t.map(u=>[u.id,u])).values()).filter(u=>o.includes(u.id));r.value=c,e.value.organizationalStructurePersonList=r.value}else r.value=[],e.value.organizationalStructurePersonList=r.value};function h(){Object.assign(e,{parentId:"",name:"",remark:"",userIdList:[],organizationalStructurePersonList:[]}),S.value=!1}const $=()=>g.value.filter(o=>{var l;return(l=e.value)==null?void 0:l.userIdList.includes(o.id)});return Z(async()=>{try{if(I.value=!0,_.id!==""){const{id:o,name:l,remark:t,organizationalStructurePersonList:a}=JSON.parse(_.row);e.value.id=o,e.value.name=l,e.value.remark=t,e.value.organizationalStructurePersonList=a,a.forEach(c=>{e.value.userIdList.push(c.userId)})}g.value=await F.getStaff(),r.value=$(),e.value.id&&(r.value=e.value.organizationalStructurePersonList),I.value=!1}catch{}finally{I.value=!1}}),(o,l)=>{const t=p("ElInput"),a=p("ElFormItem"),c=p("el-option"),u=p("el-select"),L=p("el-tag"),x=p("el-text"),G=p("el-switch"),H=p("ElForm"),P=p("ElButton"),K=p("ElDialog"),Q=ee("loading");return C((f(),D(K,{modelValue:S.value,"onUpdate:modelValue":l[4]||(l[4]=s=>S.value=s),title:d(O),width:"25rem","close-on-click-modal":!1,"append-to-body":"","destroy-on-close":"",onClosed:h},{footer:i(()=>[n(P,{size:"large",onClick:h},{default:i(()=>[V(" 取消 ")]),_:1}),n(P,{type:"primary",size:"large",onClick:j},{default:i(()=>[V(" 确定 ")]),_:1})]),default:i(()=>[n(H,{ref_key:"formRef",ref:b,model:d(e),rules:d(R),"label-width":"7rem"},{default:i(()=>[n(a,{label:"部门名称",prop:"name"},{default:i(()=>[n(t,{modelValue:d(e).name,"onUpdate:modelValue":l[0]||(l[0]=s=>d(e).name=s),placeholder:"请输入部门名称",clearable:""},null,8,["modelValue"])]),_:1}),n(a,{label:"部门主管",prop:""},{default:i(()=>[n(u,{modelValue:d(e).userIdList,"onUpdate:modelValue":l[1]||(l[1]=s=>d(e).userIdList=s),"value-key":"",placeholder:"请选择部门主管",multiple:"","collapse-tags":"","collapse-tags-tooltip":"",clearable:"",filterable:"",onChange:J},{default:i(()=>[(f(!0),y(w,null,k(d(g),s=>(f(),D(c,{key:s.value,label:s.userName,value:s.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),n(a,{label:"备注"},{default:i(()=>[n(t,{modelValue:d(e).remark,"onUpdate:modelValue":l[2]||(l[2]=s=>d(e).remark=s),placeholder:"请输入备注",clearable:""},null,8,["modelValue"])]),_:1}),(f(!0),y(w,null,k(d(r),s=>(f(),y("div",{key:s.id,class:"user"},[z("div",oe,[n(L,{type:"primary",closable:"",onClose:m=>A(s)},{default:i(()=>[V(ae(s.userName),1)]),_:2},1032,["onClose"])]),z("div",ne,[n(x,{style:{width:"4.375rem"}},{default:i(()=>[V("开启提成")]),_:1}),n(G,{modelValue:s.commissionStatus,"onUpdate:modelValue":m=>s.commissionStatus=m,"active-value":1,"inactive-value":2,"inline-prompt":"","active-text":"开启","inactive-text":"关闭"},null,8,["modelValue","onUpdate:modelValue"])]),C(z("div",re,[n(t,{modelValue:s.commission,"onUpdate:modelValue":m=>s.commission=m,placeholder:"请输入提成比例",style:{"max-width":"25rem"},clearable:""},{append:i(()=>[n(u,{class:"select",modelValue:s.commissionType,"onUpdate:modelValue":m=>s.commissionType=m,"value-key":"",placeholder:"请选择计提时间",clearable:"",filterable:"",onChange:l[3]||(l[3]=()=>{})},{default:i(()=>[(f(),y(w,null,k(M,m=>n(c,{key:m.value,label:m.label,value:m.value},null,8,["label","value"])),64))]),_:2},1032,["modelValue","onUpdate:modelValue"])]),_:2},1032,["modelValue","onUpdate:modelValue"])],512),[[le,s.commissionStatus===1]])]))),128))]),_:1},8,["model","rules"])]),_:1},8,["modelValue","title"])),[[Q,d(I)]])}}}),me=se(ue,[["__scopeId","data-v-1d87b883"]]);export{me as default};


/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{d as Y,m as T,r as _,u as Z,c as ee,n as le,a as p,q as ae,s as y,i as d,o as f,e as D,w as c,f as t,g as S,b as g,t as h,F as x,y as I,z as se,aq as E,E as q,L as oe}from"./index-CTDaT2Z5.js";import{a as B}from"./department-DVBzUfez.js";import{u as te}from"./configuration_manager-4_JVXkqt.js";const ne={class:"mr"},re={class:"mr checkbox-container"},ue={class:"centers mr"},ie={class:"center mr"},de={class:"center mr"},ce=Y({__name:"index",props:T({parentId:{default:""},id:{default:""},tree:{},row:{},name:{}},{modelValue:{type:Boolean,default:!1},modelModifiers:{}}),emits:T(["getList"],["update:modelValue"]),setup(P,{emit:F}){const M=te(),b=_([]),v=P,N=[{label:"完成计提",value:1},{label:"审核计提",value:2},{label:"结算计提",value:3}],O=[{label:"按项目价",value:1},{label:"按成本价",value:2},{label:"按毛利润",value:3}],L=_(!1),R=F,k=Z(P,"modelValue"),j=ee(()=>v.id===""?"新增子部门":"编辑子部门"),u=_([]),z=_(),e=_({parentId:v.parentId,name:"",remark:"",userIdList:[],organizationalStructurePersonList:[],superior:""}),A=_({name:[{required:!0,message:"请输入部门名称"}],commissionType:[{required:!0,message:"请选择计提方式",trigger:"change"}]});async function J(){z.value&&z.value.validate(async n=>{if(n){console.log("filteredUsers",u.value),e.value.organizationalStructurePersonList=[],u.value.forEach(l=>{const m={userId:l.userId,commission:l.commission,commissionTime:l.commissionTime,commissionStatus:l.commissionStatus,commissionType:l.commissionType};e.value.organizationalStructurePersonList.push(m)}),console.log("filteredUsers11111111",u.value),console.log("form.value.organizationalStructurePersonList",e.value.organizationalStructurePersonList);const s=e.value.organizationalStructurePersonList.reduce((l,m)=>(l.some(V=>V.userId===m.userId)||l.push(m),l),[]);e.value.organizationalStructurePersonList=s;const o={...e.value};if(delete o.userIdList,delete o.superior,e.value.id){console.log("params",o),console.log("filteredUsers",u.value);const{status:l}=await B.edit(o);l===1&&q.success({message:"编辑成功",center:!0})}else{delete o.userIdList,console.log("params",o);const{status:l}=await B.create(o);l===1&&q.success({message:"新增成功",center:!0})}await R("getList"),U()}})}const $=n=>{if(n.userId){const l=e.value.userIdList.indexOf(n.userId);l!==-1&&e.value.userIdList.splice(l,1)}else{const l=e.value.userIdList.indexOf(n.id);l!==-1&&e.value.userIdList.splice(l,1)}const s=e.value.organizationalStructurePersonList.findIndex(l=>l.id===n.id||l.userId===n.id);s!==-1&&e.value.organizationalStructurePersonList.splice(s,1);const o=u.value.findIndex(l=>l.id===n.id||l.userId===n.id);o!==-1&&u.value.splice(o,1)},G=n=>{var s;if(e.value.userIdList=n,u.value=b.value.filter(o=>{var l;return(l=e.value)==null?void 0:l.userIdList.includes(o.id)}),(s=e.value)!=null&&s.userIdList.length){const o=[];e.value.organizationalStructurePersonList.forEach(i=>{o.push(i)}),u.value.forEach(i=>{e.value.organizationalStructurePersonList.some(w=>w.userId===i.id)||o.push(i)});const m=Array.from(new Map(o.map(i=>[i.id,i])).values()).filter(i=>n.includes(i.id));u.value=m,e.value.organizationalStructurePersonList=u.value}else u.value=[],e.value.organizationalStructurePersonList=u.value};function U(){Object.assign(e,{parentId:"",name:"",remark:"",userIdList:[],organizationalStructurePersonList:[],superior:""}),k.value=!1}const H=()=>b.value.filter(n=>{var s;return(s=e.value)==null?void 0:s.userIdList.includes(n.id)});return v.parentId&&(e.value.superior=v.name),le(async()=>{try{if(L.value=!0,v.id!==""){const{id:n,name:s,remark:o,organizationalStructurePersonList:l}=JSON.parse(v.row);e.value.id=n,e.value.name=s,e.value.remark=o,e.value.organizationalStructurePersonList=l,l.forEach(m=>{e.value.userIdList.push(m.userId)})}b.value=await M.getStaff(),u.value=H(),e.value.id&&(u.value=e.value.organizationalStructurePersonList),L.value=!1}catch{}finally{L.value=!1}}),(n,s)=>{const o=p("ElInput"),l=p("ElFormItem"),m=p("el-option"),i=p("el-select"),V=p("el-tag"),w=p("el-text"),K=p("el-switch"),Q=p("ElForm"),C=p("ElButton"),W=p("ElDialog"),X=ae("loading");return y((f(),D(W,{modelValue:k.value,"onUpdate:modelValue":s[4]||(s[4]=a=>k.value=a),title:d(j),style:{width:"48rem"},"close-on-click-modal":!1,"append-to-body":"","destroy-on-close":"",onClosed:U},{footer:c(()=>[t(C,{size:"large",onClick:U},{default:c(()=>[S(" 取消 ")]),_:1}),t(C,{type:"primary",size:"large",onClick:J},{default:c(()=>[S(" 确定 ")]),_:1})]),default:c(()=>[t(Q,{ref_key:"formRef",ref:z,model:d(e),rules:d(A),"label-width":"7rem"},{default:c(()=>[t(l,{label:"上级部门",prop:""},{default:c(()=>[t(o,{modelValue:d(e).superior,"onUpdate:modelValue":s[0]||(s[0]=a=>d(e).superior=a),disabled:!!v.parentId,placeholder:"请输入部门名称",clearable:""},null,8,["modelValue","disabled"])]),_:1}),t(l,{label:"部门名称",prop:"name"},{default:c(()=>[t(o,{modelValue:d(e).name,"onUpdate:modelValue":s[1]||(s[1]=a=>d(e).name=a),placeholder:"请输入部门名称",clearable:""},null,8,["modelValue"])]),_:1}),t(l,{label:"部门主管",prop:""},{default:c(()=>[t(i,{modelValue:d(e).userIdList,"onUpdate:modelValue":s[2]||(s[2]=a=>d(e).userIdList=a),"value-key":"",placeholder:"请选择部门主管",multiple:"","collapse-tags":"","collapse-tags-tooltip":"",clearable:"",filterable:"",onChange:G},{default:c(()=>[(f(!0),g(x,null,h(d(b),a=>(f(),D(m,{key:a.value,label:a.userName,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(l,{label:"备注"},{default:c(()=>[t(o,{modelValue:d(e).remark,"onUpdate:modelValue":s[3]||(s[3]=a=>d(e).remark=a),placeholder:"请输入备注",clearable:""},null,8,["modelValue"])]),_:1}),(f(!0),g(x,null,h(d(u),a=>(f(),g("div",{key:a.id,class:"user"},[I("div",ne,[t(V,{type:"primary",closable:"",onClose:r=>$(a)},{default:c(()=>[S(se(a.userName),1)]),_:2},1032,["onClose"])]),I("div",re,[t(w,{style:{width:"4.375rem"}},{default:c(()=>[S("开启提成")]),_:1}),t(K,{modelValue:a.commissionStatus,"onUpdate:modelValue":r=>a.commissionStatus=r,"active-value":1,"inactive-value":2,"inline-prompt":"","active-text":"开启","inactive-text":"关闭"},null,8,["modelValue","onUpdate:modelValue"])]),y(I("div",ue,[t(i,{modelValue:a.commissionType,"onUpdate:modelValue":r=>a.commissionType=r,"value-key":"",placeholder:"计提方式",clearable:"",filterable:""},{default:c(()=>[(f(),g(x,null,h(O,r=>t(m,{key:r.value,label:r.label,value:r.value},null,8,["label","value"])),64))]),_:2},1032,["modelValue","onUpdate:modelValue"])],512),[[E,a.commissionStatus===1]]),y(I("div",ie,[t(i,{class:"select",modelValue:a.commissionTime,"onUpdate:modelValue":r=>a.commissionTime=r,"value-key":"",placeholder:"计提时间",clearable:"",filterable:""},{default:c(()=>[(f(),g(x,null,h(N,r=>t(m,{key:r.value,label:r.label,value:r.value},null,8,["label","value"])),64))]),_:2},1032,["modelValue","onUpdate:modelValue"])],512),[[E,a.commissionStatus===1]]),y(I("div",de,[t(o,{modelValue:a.commission,"onUpdate:modelValue":r=>a.commission=r,placeholder:"提成比例",style:{"max-width":"25rem"},clearable:""},null,8,["modelValue","onUpdate:modelValue"])],512),[[E,a.commissionStatus===1]])]))),128))]),_:1},8,["model","rules"])]),_:1},8,["modelValue","title"])),[[X,d(L)]])}}}),fe=oe(ce,[["__scopeId","data-v-2e775a27"]]);export{fe as default};


/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{d as Z,m as M,r as _,u as ee,c as ae,n as le,a as v,q as se,o as p,e as T,w as d,f as r,g as y,s as V,i as m,b,t as S,F as k,y as L,z as oe,aq as U,E as F,L as te}from"./index-DkeSsSat.js";import{a as x}from"./survey_vip_department-CWDVs_YR.js";const ne={class:"mr"},ie={class:"mr checkbox-container"},re={class:"centers mr"},ue={class:"center mr"},de={class:"center mr"},ce=Z({__name:"index",props:M({parentId:{default:""},id:{default:""},tree:{},row:{},isClick:{type:Boolean}},{modelValue:{type:Boolean,default:!1},modelModifiers:{}}),emits:M(["getList","getItmelist"],["update:modelValue"]),setup(D,{emit:N}){const g=_([]),I=D,q=_(!1),O=[{label:"完成计提",value:1},{label:"审核计提",value:2},{label:"结算计提",value:3}],j=[{label:"按项目价",value:1},{label:"按成本价",value:2},{label:"按毛利润",value:3}],f=_(!1),z=N,w=ee(D,"modelValue"),R=ae(()=>I.id===""?"新增部门":"编辑部门"),c=_([]),C=_(),a=_({parentId:I.parentId,name:"",remark:"",userIdList:[],organizationalStructurePersonList:[]}),A=_({name:[{required:!0,message:"请输入部门名称"}],commissionType:[{required:!0,message:"请选择计提方式",trigger:"change"}]}),J=s=>{if(s.userId){const e=a.value.userIdList.indexOf(s.userId);e!==-1&&a.value.userIdList.splice(e,1)}else{const e=a.value.userIdList.indexOf(s.id);e!==-1&&a.value.userIdList.splice(e,1)}const o=a.value.organizationalStructurePersonList.findIndex(e=>e.id===s.id||e.userId===s.id);o!==-1&&a.value.organizationalStructurePersonList.splice(o,1);const t=c.value.findIndex(e=>e.id===s.id||e.userId===s.id);t!==-1&&c.value.splice(t,1)},$=s=>{var o;if(a.value.userIdList=s,c.value=g.value.filter(t=>{var e;return(e=a.value)==null?void 0:e.userIdList.includes(t.id)}),(o=a.value)!=null&&o.userIdList.length){const t=[];a.value.organizationalStructurePersonList.forEach(n=>{t.push(n)}),c.value.forEach(n=>{a.value.organizationalStructurePersonList.some(P=>P.userId===n.id)||t.push(n)});const u=Array.from(new Map(t.map(n=>[n.id,n])).values()).filter(n=>n.userId?s.includes(n.userId):s.includes(n.id));c.value=u,a.value.organizationalStructurePersonList=c.value}else c.value=[],a.value.organizationalStructurePersonList=c.value},G=s=>{};async function H(){try{C.value&&C.value.validate(async s=>{if(s){f.value=!0,a.value.organizationalStructurePersonList=[],c.value.forEach(e=>{if(e.userId){const u={id:e.id,userId:e.userId,commission:e.commission||0,commissionTime:e.commissionTime||1,commissionStatus:e.commissionStatus,commissionType:e.commissionType||1};a.value.organizationalStructurePersonList.push(u)}else{const u={userId:e.id,commission:e.commission||0,commissionTime:e.commissionTime||1,commissionStatus:e.commissionStatus,commissionType:e.commissionType||1};a.value.organizationalStructurePersonList.push(u)}});const o=a.value.organizationalStructurePersonList.reduce((e,u)=>(e.some(h=>h.userId===u.userId)||e.push(u),e),[]);a.value.organizationalStructurePersonList=o;const t={...a.value};if(delete t.userIdList,a.value.id){const{status:e}=await x.edit(t);e===1&&F.success({message:"编辑成功",center:!0}),f.value=!1}else{const{status:e}=await x.create(t);e===1&&F.success({message:"新增成功",center:!0}),f.value=!1}q.value?(await z("getItmelist"),await z("getList")):await z("getList"),E()}})}catch{}finally{f.value=!1}}function E(){Object.assign(a,{parentId:"",name:"",remark:"",userIdList:[],organizationalStructurePersonList:[]}),w.value=!1}const K=()=>g.value.filter(s=>{var o;return(o=a.value)==null?void 0:o.userIdList.includes(s.id)});return le(async()=>{try{if(f.value=!0,I.id){const{id:s,name:o,remark:t,organizationalStructurePersonList:e}=JSON.parse(I.row);a.value.id=s,a.value.name=o,a.value.remark=t,q.value=I.isClick;const{data:u}=await x.queryMemberListByOrganizationIdToUpdate({organizationalStructureId:a.value.id});u&&(g.value=u),e?(a.value.organizationalStructurePersonList=e,e.forEach(n=>{a.value.userIdList.push(n.userId)})):a.value.organizationalStructurePersonList=[]}else{const{data:s}=await x.queryMemberList();s&&(g.value=s)}c.value=K(),a.value.id&&(c.value=a.value.organizationalStructurePersonList)}catch(s){console.error("Error occurred:",s)}finally{f.value=!1}}),(s,o)=>{const t=v("ElInput"),e=v("ElFormItem"),u=v("el-option"),n=v("el-select"),h=v("el-tag"),P=v("el-text"),Q=v("el-switch"),W=v("ElForm"),B=v("ElButton"),X=v("ElDialog"),Y=se("loading");return p(),T(X,{modelValue:w.value,"onUpdate:modelValue":o[3]||(o[3]=l=>w.value=l),title:m(R),style:{width:"48rem"},"close-on-click-modal":!1,"append-to-body":"","destroy-on-close":"",onClosed:E},{footer:d(()=>[r(B,{size:"large",onClick:E},{default:d(()=>[y(" 取消 ")]),_:1}),r(B,{type:"primary",size:"large",onClick:H},{default:d(()=>[y(" 确定 ")]),_:1})]),default:d(()=>[V((p(),T(W,{ref_key:"formRef",ref:C,model:m(a),rules:m(A),"label-width":"7rem"},{default:d(()=>[r(e,{label:"部门名称",prop:"name"},{default:d(()=>[r(t,{modelValue:m(a).name,"onUpdate:modelValue":o[0]||(o[0]=l=>m(a).name=l),placeholder:"请输入部门名称",clearable:""},null,8,["modelValue"])]),_:1}),r(e,{label:"部门主管",prop:""},{default:d(()=>[r(n,{modelValue:m(a).userIdList,"onUpdate:modelValue":o[1]||(o[1]=l=>m(a).userIdList=l),"value-key":"",placeholder:"请选择部门主管",multiple:"","collapse-tags":"","collapse-tags-tooltip":"",clearable:"",filterable:"",onChange:$},{default:d(()=>[(p(!0),b(k,null,S(m(g),l=>(p(),T(u,{key:l.value,label:l.userName,value:l.id,disabled:l.enableChargePerson===1},null,8,["label","value","disabled"]))),128))]),_:1},8,["modelValue"])]),_:1}),r(e,{label:"备注"},{default:d(()=>[r(t,{modelValue:m(a).remark,"onUpdate:modelValue":o[2]||(o[2]=l=>m(a).remark=l),placeholder:"请输入备注",clearable:""},null,8,["modelValue"])]),_:1}),(p(!0),b(k,null,S(m(c),l=>(p(),b("div",{key:l.id,class:"user"},[L("div",ne,[r(h,{type:"primary",style:{},closable:"",onClose:i=>J(l)},{default:d(()=>[y(oe(l.id?l.userName:l.name),1)]),_:2},1032,["onClose"])]),L("div",ie,[r(P,{style:{width:"4.375rem"}},{default:d(()=>[y("开启提成")]),_:1}),r(Q,{modelValue:l.commissionStatus,"onUpdate:modelValue":i=>l.commissionStatus=i,"active-value":1,"inactive-value":2,"inline-prompt":"","active-text":"开启","inactive-text":"关闭",onChange:G},null,8,["modelValue","onUpdate:modelValue"])]),V(L("div",re,[r(n,{modelValue:l.commissionType,"onUpdate:modelValue":i=>l.commissionType=i,"value-key":"",placeholder:"计提方式",clearable:"",filterable:""},{default:d(()=>[(p(),b(k,null,S(j,i=>r(u,{key:i.value,label:i.label,value:i.value},null,8,["label","value"])),64))]),_:2},1032,["modelValue","onUpdate:modelValue"])],512),[[U,l.commissionStatus===1]]),V(L("div",ue,[r(n,{class:"select",modelValue:l.commissionTime,"onUpdate:modelValue":i=>l.commissionTime=i,"value-key":"",placeholder:"计提时间",clearable:"",filterable:""},{default:d(()=>[(p(),b(k,null,S(O,i=>r(u,{key:i.value,label:i.label,value:i.value},null,8,["label","value"])),64))]),_:2},1032,["modelValue","onUpdate:modelValue"])],512),[[U,l.commissionStatus===1]]),V(L("div",de,[r(t,{modelValue:l.commission,"onUpdate:modelValue":i=>l.commission=i,placeholder:"提成比例",style:{"max-width":"25rem"},clearable:""},{append:d(()=>[y("%")]),_:2},1032,["modelValue","onUpdate:modelValue"])],512),[[U,l.commissionStatus===1]])]))),128))]),_:1},8,["model","rules"])),[[Y,m(f)]])]),_:1},8,["modelValue","title"])}}}),pe=te(ce,[["__scopeId","data-v-d8261460"]]);export{pe as default};

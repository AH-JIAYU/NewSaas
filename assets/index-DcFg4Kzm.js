
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{d as $,aD as G,l as J,r as n,X as h,Z as y,n as K,a as x,q as W,o as C,b as Y,f as u,w as p,y as ee,s as I,ao as k,g,z as te,i as L,e as ae,j as oe,N as re,ap as f,E as d,_ as ie,L as se}from"./index-Bvr2J8E-.js";import ne from"./index-s03G-BgR.js";import{u as le}from"./projectManagement_list-DAyI-u19.js";import{u as ce}from"./stagedData-D3p5mBXG.js";import{u as ue}from"./user_customer-BPpVrL2_.js";import{a as j}from"./projectManagement-zgzO8cK3.js";import"./index-FxS5nCf8.js";import"./user_customer-CMveXHGt.js";import"./file-pmHbX1hT.js";import"./index-Dhg4EKFC.js";import"./zh_Hans-B0qaAPDm.js";import"./zh_Hans-B39mJ-rS.js";import"./index-CqwuwULC.js";import"./index.vue_vue_type_script_setup_true_lang-DOoPURFU.js";import"./index-BzdZ1w-y.js";import"./index-B3WSsJF3.js";import"./index-Dl5awInf.js";import"./index-S67X3Vuq.js";import"./department-BRxeEdOQ.js";import"./position_manage-CiPH0BYa.js";import"./configuration_role-D-NPBbNV.js";import"./tenant_role-BfxLIqMu.js";import"./configuration_manager-CWETi4b2.js";import"./configuration_siteSetting-CiSC3pIP.js";import"./configuration_site_setting-oRRTN0XS.js";import"./apiLoading-Cz8URuy5.js";import"./index.vue_vue_type_script_setup_true_lang-wwiCTwCA.js";const pe={class:"flex-c"},de=$({name:"ProjeckEdit",__name:"index",emits:["fetch-data"],setup(me,{expose:S,emit:V}){G();const v=le(),b=ce(),U=J(),E=ue(),M=V,m=n(!1),s=n(""),i=n(!1),l=n([]),T=n(""),c=n([]);function A(e){l.value.push(e)}function R(e){T.value=e}h("validateTopTabs",A),h("currentProjectTimeline",R);let r=y([]);const P=n();async function Q(e){try{if(i.value=!0,e)if(s.value="编辑",e.projectType===2)_(e);else{const t=await j.detail({projectId:e.projectId});t.data&&(t.data.projectType=e.projectType,t.data.projectType=e.projectType,t.data.projectType===2&&(t.data.doMoneyPrice=e.doMoneyPrice),_(t.data))}else{s.value="新增";const t=f(v.initialTopTabsData);r=b.projectManagementList||y([t])}m.value=!0,c.value=[],l.value=[],i.value=!1}catch{}finally{i.value=!1}}function _(e){e.data={configurationInformation:{initialProblem:{countryId:null,projectProblemCategoryId:null,projectQuotaQuestionType:null,projectProblemId:null,keyValue:"",questionType:null,answerValueList:[],projectAnswerIdList:[]},configurationCountryList:null,projectCategoryList:null,ProjectProblemInfoList:[]}},r=[];const{projectInfoList:t,...a}=f(e);a.descriptionUrl?a.descriptionUrl=a.descriptionUrl.split(","):a.descriptionUrl=[],r.push(a),t&&t.length&&t.forEach(o=>{o.data={configurationInformation:{initialProblem:{countryId:null,projectProblemCategoryId:null,projectQuotaQuestionType:null,projectProblemId:null,keyValue:"",questionType:null,answerValueList:[],projectAnswerIdList:[]},configurationCountryList:null,projectCategoryList:null,ProjectProblemInfoList:[]}},o.descriptionUrl=o.descriptionUrl.split(","),r.push({...o})}),v.dataBeforeEditing=f(r)}function B(){b.projectManagementList=f(r),r=y([]),m.value=!1,l.value=[]}async function w(){const e=[];l.value.forEach(a=>{e.push(a.validate())});const t=await Promise.allSettled(e);c.value=t.map(a=>a.status)}function N(e){const t=new Set;for(const a of e){if(t.has(a.name))return!0;t.add(a.name)}return!1}const O=async()=>{const e=f(r);await v.compareProjectData(v.dataBeforeEditing,e),await e.forEach(a=>{a.descriptionUrl=a.descriptionUrl.join(","),(!a.data.configurationInformation.ProjectProblemInfoList||!a.data.configurationInformation.ProjectProblemInfoList.length)&&(a.isProfile=2),a.data&&delete a.data,a.projectQuotaInfoList=a.projectQuotaInfoList.map(o=>(Array.isArray(o.answerValueList)||(o.answerValueList=[]),Array.isArray(o.projectAnswerIdList)||(o.projectAnswerIdList=[]),o))});let t=e[0];return t.projectInfoList=e.slice(1),t},z=e=>({projectOutsideInfoId:e.projectOutsideInfoId??null,projectId:e.projectId,doMoneyPrice:e.doMoneyPrice,currencyType:e.currencyType,exchangeRate:e.exchangeRate,memberPrice:e.memberPrice,num:e.num,minimumDuration:e.minimumDuration,ir:e.ir,mutualExclusionId:e.mutualExclusionId,remark:e.remark,descriptionUrl:e.descriptionUrl,richText:e.richText,ipDifferenceDetection:e.ipDifferenceDetection,limitedQuantity:e.limitedQuantity,preNum:e.preNum});async function q(){if(i.value=!0,await w(),c.value.every(e=>e==="fulfilled"))if(N(r))d({message:"项目名称重复",center:!0});else{const e=await O();setTimeout(async()=>{if(s.value==="新增"){if(e.memberPrice=(e.doMoneyPrice*e.exchangeRate).toFixed(2),e.minimumDuration=+e.minimumDuration,!e.exchangeRate){d.warning({message:"请设置汇率",center:!0});return}const{status:t}=await j.create(e);t===1&&d.success({message:"新增成功",center:!0})}else if(e.projectType===2){const t=z(e),{status:a}=await j.addOrUpdateProjectOutsideInfo(t);a===1&&d.success({message:"编辑成功",center:!0})}else{const{status:t}=await j.edit(e);t===1&&d.success({message:"编辑成功",center:!0})}M("fetch-data"),D()},1e3)}else P.value.activeLeftTab=c.value.indexOf("rejected"),d.warning({message:"请完善表单",center:!0});i.value=!1}function D(){r=y([]),c.value=[],l.value=[],m.value=!1,s.value==="新增"&&(b.projectManagementList=null)}const F=async()=>{await E.getCustomerList(),await U.getCountry()};return K(async()=>{await F()}),S({showEdit:Q}),(e,t)=>{const a=ie,o=x("el-button"),H=x("el-drawer"),X=W("loading");return C(),Y("div",null,[u(H,{modelValue:m.value,"onUpdate:modelValue":t[0]||(t[0]=Z=>m.value=Z),class:re(s.value==="新增"||L(r).length>1?"hide-drawer-header":"edit-drawer"),"append-to-body":"","close-on-click-modal":!1,"destroy-on-close":"",draggable:"",size:"70%"},{footer:p(()=>[ee("div",pe,[I(u(o,{link:""},{default:p(()=>[u(a,{name:"ant-design:clock-circle-outlined"}),g("   "+te(T.value),1)]),_:1},512),[[k,T.value]]),u(o,{type:"primary",onClick:q,disabled:i.value},{default:p(()=>[g(" 发布项目 ")]),_:1},8,["disabled"]),I(u(o,{type:"warning",onClick:B,disabled:i.value},{default:p(()=>[g(" 暂存 ")]),_:1},8,["disabled"]),[[k,s.value!=="编辑"]]),u(o,{onClick:D,disabled:i.value},{default:p(()=>[g(" 取消 ")]),_:1},8,["disabled"])])]),default:p(()=>[L(r).length?I((C(),ae(ne,{key:0,onValidate:w,ref_key:"LeftTabsRef",ref:P,"left-tabs-data":L(r),"validate-top-tabs":l.value,"validate-all":c.value,title:s.value},null,8,["left-tabs-data","validate-top-tabs","validate-all","title"])),[[X,i.value]]):oe("",!0)]),_:1},8,["modelValue","class"])])}}}),Oe=se(de,[["__scopeId","data-v-d900f72f"]]);export{Oe as default};

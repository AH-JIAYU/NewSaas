
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{d as Z,r as i,aE as $,aD as G,l as J,X as D,Z as v,n as K,a as C,q as W,o as x,b as ee,f as u,w as d,y as te,s as w,ao as S,g,z as ae,i as _,e as oe,j as se,N as re,ap as f,E as y,_ as ie,L as ne}from"./index-D_G0Q2kt.js";import le from"./index-DnkqXabk.js";import{u as ce}from"./projectManagement_list-D20rpJaG.js";import{u as ue}from"./stagedData-C1CZyZ57.js";import{u as de}from"./user_customer-CJR-U-ni.js";import{a as T}from"./projectManagement-CAxyurAP.js";import"./index-DKbR7a6n.js";import"./user_customer-DKtzSDKs.js";import"./file-Dsa55QT5.js";import"./index-CmQN6WqP.js";import"./zh_Hans-CouOoY7E.js";import"./zh_Hans-B39mJ-rS.js";import"./index-B956F5Lk.js";import"./index.vue_vue_type_script_setup_true_lang-Cwxj0wez.js";import"./index-CBitMyP5.js";import"./index-CAXRxdi9.js";import"./index-Vq8ZNA-n.js";import"./index-BWegxNcN.js";import"./department-CcKVWrqY.js";import"./position_manage-B4nTxrCs.js";import"./configuration_role-CH40J63B.js";import"./tenant_role-DXnGjAOp.js";import"./configuration_manager-Xfy4JR4F.js";import"./configuration_siteSetting-DORFQu4C.js";import"./configuration_site_setting-BDGT_NpR.js";import"./apiLoading-CWVrsejE.js";import"./index.vue_vue_type_script_setup_true_lang-ClWjiLar.js";const pe={class:"flex-c"},fe=Z({name:"ProjeckEdit",__name:"index",emits:["fetch-data"],setup(me,{expose:k,emit:V}){const b=i();b.value=$.local.get("currencyTypeRes"),G();const m=ce(),j=ue(),E=J(),R=de(),U=V,p=i(!1),n=i(""),r=i(!1),l=i([]),L=i(""),c=i([]);function A(e){l.value.push(e)}function M(e){L.value=e}D("validateTopTabs",A),D("currentProjectTimeline",M);let s=v([]);const I=i();async function B(e){try{if(r.value=!0,e){n.value="编辑";const a=await T.detail({projectId:e.projectId});N(a.data)}else{n.value="新增";const a=f(m.initialTopTabsData);s=j.projectManagementList||v([a])}p.value=!0,c.value=[],l.value=[],r.value=!1}catch{}finally{r.value=!1}}function N(e){e.data={configurationInformation:{initialProblem:{countryId:null,projectProblemCategoryId:null,projectQuotaQuestionType:null,projectProblemId:null,keyValue:"",questionType:null,answerValueList:[],projectAnswerIdList:[]},configurationCountryList:null,projectCategoryList:null,ProjectProblemInfoList:[]}},s=[];const{projectInfoList:a,...t}=f(e);t.descriptionUrl?t.descriptionUrl=t.descriptionUrl.split(","):t.descriptionUrl=[],s.push(t),a&&a.length&&a.forEach(o=>{o.data={configurationInformation:{initialProblem:{countryId:null,projectProblemCategoryId:null,projectQuotaQuestionType:null,projectProblemId:null,keyValue:"",questionType:null,answerValueList:[],projectAnswerIdList:[]},configurationCountryList:null,projectCategoryList:null,ProjectProblemInfoList:[]}},o.descriptionUrl=o.descriptionUrl.split(","),s.push({...o})}),m.dataBeforeEditing=f(s)}function Q(){j.projectManagementList=f(s),s=v([]),p.value=!1,l.value=[]}async function P(){const e=[];l.value.forEach(t=>{e.push(t.validate())});const a=await Promise.allSettled(e);c.value=a.map(t=>t.status)}function z(e){const a=new Set;for(const t of e){if(a.has(t.name))return!0;a.add(t.name)}return!1}const q=async()=>{const e=f(s);await m.compareProjectData(m.dataBeforeEditing,e),await e.forEach(t=>{t.descriptionUrl=t.descriptionUrl.join(","),(!t.data.configurationInformation.ProjectProblemInfoList||!t.data.configurationInformation.ProjectProblemInfoList.length)&&(t.isProfile=2),t.data&&delete t.data,t.projectQuotaInfoList=t.projectQuotaInfoList.map(o=>(Array.isArray(o.answerValueList)||(o.answerValueList=[]),Array.isArray(o.projectAnswerIdList)||(o.projectAnswerIdList=[]),o))});let a=e[0];return a.projectInfoList=e.slice(1),a};async function F(){if(r.value=!0,await P(),c.value.every(e=>e==="fulfilled"))if(z(s))y({message:"项目名称重复",center:!0});else{const e=await q();setTimeout(async()=>{if(n.value==="新增"){e.currencyType==="CNY"?(e.exchangeRate=(1/b.value).toFixed(2),e.memberPrice=(e.doMoneyPrice*e.exchangeRate).toFixed(2)):(e.exchangeRate=b.value,e.memberPrice=(e.doMoneyPrice*e.exchangeRate).toFixed(2)),e.minimumDuration=+e.minimumDuration;const{status:a}=await T.create(e);a===1&&y.success({message:"新增成功",center:!0})}else{const{status:a}=await T.edit(e);a===1&&y.success({message:"编辑成功",center:!0})}U("fetch-data"),h()},1e3)}else I.value.activeLeftTab=c.value.indexOf("rejected"),y.warning({message:"请完善表单",center:!0});r.value=!1}function h(){s=v([]),c.value=[],l.value=[],p.value=!1,n.value==="新增"&&(j.projectManagementList=null)}const H=async()=>{await R.getCustomerList(),await E.getCountry()};return K(async()=>{await H()}),k({showEdit:B}),(e,a)=>{const t=ie,o=C("el-button"),O=C("el-drawer"),X=W("loading");return x(),ee("div",null,[u(O,{modelValue:p.value,"onUpdate:modelValue":a[0]||(a[0]=Y=>p.value=Y),class:re(n.value==="新增"||_(s).length>1?"hide-drawer-header":"edit-drawer"),"append-to-body":"","close-on-click-modal":!1,"destroy-on-close":"",draggable:"",size:"70%"},{footer:d(()=>[te("div",pe,[w(u(o,{link:""},{default:d(()=>[u(t,{name:"ant-design:clock-circle-outlined"}),g("   "+ae(L.value),1)]),_:1},512),[[S,L.value]]),u(o,{type:"primary",onClick:F,disabled:r.value},{default:d(()=>[g(" 发布项目 ")]),_:1},8,["disabled"]),w(u(o,{type:"warning",onClick:Q,disabled:r.value},{default:d(()=>[g(" 暂存 ")]),_:1},8,["disabled"]),[[S,n.value!=="编辑"]]),u(o,{onClick:h,disabled:r.value},{default:d(()=>[g(" 取消 ")]),_:1},8,["disabled"])])]),default:d(()=>[_(s).length?w((x(),oe(le,{key:0,onValidate:P,ref_key:"LeftTabsRef",ref:I,"left-tabs-data":_(s),"validate-top-tabs":l.value,"validate-all":c.value,title:n.value},null,8,["left-tabs-data","validate-top-tabs","validate-all","title"])),[[X,r.value]]):se("",!0)]),_:1},8,["modelValue","class"])])}}}),qe=ne(fe,[["__scopeId","data-v-279e7b2a"]]);export{qe as default};

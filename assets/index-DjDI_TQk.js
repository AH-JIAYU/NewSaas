
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{d as Z,aC as $,l as J,r as n,X as D,Z as v,n as K,a as h,q as W,o as x,b as Y,f as p,w as d,y as ee,s as I,aG as S,g as y,z as te,i as C,e as ae,j as oe,ao as f,E as s,_ as re,L as ie}from"./index-BIHh3pBK.js";import ne from"./index-R6d_daX2.js";import{u as se}from"./projectManagement_list-Ci_i53u5.js";import{u as le}from"./stagedData-7Mfsf77Z.js";import{u as ce}from"./user_customer-BFHnR5Rc.js";import{a as b}from"./projectManagement-YCKZ3s1q.js";import"./index-BcPh5BFo.js";import"./user_customer-D4ZSKTZX.js";import"./file-Cpjzjblr.js";import"./zh_Hans-CrfEz-Jr.js";import"./index-iJRjh0Y-.js";import"./index-CGjquLZA.js";import"./index.vue_vue_type_script_setup_true_lang-BUbxYLLG.js";import"./index-Bmwk-kKR.js";import"./index-DTg_0g86.js";import"./index-BA9V0BSB.js";import"./clipboard-xnQ4SdNC.js";import"./index-CwXf6GZU.js";import"./department-DCTOcyWO.js";import"./position_manage-BcW1iqxZ.js";import"./configuration_role-BdMAphI-.js";import"./tenant_role-a1ZABdkx.js";import"./configuration_manager-DZ7OGOga.js";import"./configuration_siteSetting-Cl5fQOzV.js";import"./configuration_site_setting-BwJP4HFn.js";import"./apiLoading-BVJcbJLo.js";import"./index.vue_vue_type_script_setup_true_lang-DH4XJi-7.js";import"./otherFunctions_screenLibrary-DlClS25B.js";import"./index.vue_vue_type_script_setup_true_lang-BloQ37dP.js";const ue={class:"flex-c"},pe=Z({name:"ProjeckEdit",__name:"index",emits:["fetch-data"],setup(de,{expose:k,emit:V}){$();const g=se(),j=le(),U=J(),E=ce(),M=V,m=n(!1),l=n(""),i=n(!1),c=n([]),w=n(""),u=n([]);function A(e){c.value.push(e)}function R(e){w.value=e}D("validateTopTabs",A),D("currentProjectTimeline",R);let r=v([]);const L=n();async function Q(e){try{if(i.value=!0,e)if(l.value="编辑",e.projectType===2)P(e);else{const a=await b.detail({projectId:e.projectId});a.data&&P(a.data)}else{l.value="新增";const a=f(g.initialTopTabsData);r=j.projectManagementList||v([a])}m.value=!0,u.value=[],c.value=[],i.value=!1}catch{}finally{i.value=!1}}function P(e){e.data={configurationInformation:{initialProblem:{countryId:null,projectProblemCategoryId:null,projectQuotaQuestionType:null,projectProblemId:null,keyValue:"",questionType:null,answerValueList:[],projectAnswerIdList:[]},configurationCountryList:null,projectCategoryList:null,ProjectProblemInfoList:[]}},r=[];const{projectInfoList:a,...t}=f(e);t.descriptionUrl?t.descriptionUrl=t.descriptionUrl.split(","):t.descriptionUrl=[],r.push(t),a&&a.length&&a.forEach(o=>{o.data={configurationInformation:{initialProblem:{countryId:null,projectProblemCategoryId:null,projectQuotaQuestionType:null,projectProblemId:null,keyValue:"",questionType:null,answerValueList:[],projectAnswerIdList:[]},configurationCountryList:null,projectCategoryList:null,ProjectProblemInfoList:[]}},o.descriptionUrl=o.descriptionUrl.split(","),r.push({...o})}),g.dataBeforeEditing=f(r)}function B(){j.projectManagementList=f(r),r=v([]),m.value=!1,c.value=[]}async function T(){const e=[];c.value.forEach(t=>{e.push(t.validate())});const a=await Promise.allSettled(e);u.value=a.map(t=>t.status)}function N(e){const a=new Set;for(const t of e){if(a.has(t.name))return!0;a.add(t.name)}return!1}const O=async()=>{const e=f(r);await g.compareProjectData(g.dataBeforeEditing,e),await e.forEach(t=>{t.descriptionUrl=t.descriptionUrl.join(","),(!t.data.configurationInformation.ProjectProblemInfoList||!t.data.configurationInformation.ProjectProblemInfoList.length)&&(t.isProfile=2),t.data&&delete t.data,t.projectQuotaInfoList=t.projectQuotaInfoList.map(o=>(Array.isArray(o.answerValueList)||(o.answerValueList=[]),Array.isArray(o.projectAnswerIdList)||(o.projectAnswerIdList=[]),o))});let a=e[0];return a.projectInfoList=e.slice(1).map(t=>(t.browser=t.browser.join(","),t.operatingSystem=t.operatingSystem.join(","),{...t,memberPrice:(t.doMoneyPrice*t.exchangeRate).toFixed(2)})),a},q=e=>({projectOutsideInfoId:e.projectOutsideInfoId??null,projectId:e.projectId,doMoneyPrice:e.doMoneyPrice,currencyType:e.currencyType,exchangeRate:e.exchangeRate,memberPrice:e.memberPrice,num:e.num,minimumDuration:e.minimumDuration,ir:e.ir,mutualExclusionId:e.mutualExclusionId,remark:e.remark,descriptionUrl:e.descriptionUrl,richText:e.richText,ipDifferenceDetection:e.ipDifferenceDetection,limitedQuantity:e.limitedQuantity,preNum:e.preNum});async function z(){if(i.value=!0,await T(),u.value.every(e=>e==="fulfilled"))if(N(r))s({message:"项目名称重复",center:!0});else{const e=await O();e.browser=e.browser.join(","),e.operatingSystem=e.operatingSystem.join(","),setTimeout(async()=>{if(!e.endAge||!e.startAge){s.warning({message:"年龄区间未填写完整",center:!0});return}if(l.value==="新增"){if(e.memberPrice=(e.doMoneyPrice*e.exchangeRate).toFixed(2),e.minimumDuration=+e.minimumDuration,!e.exchangeRate){s.warning({message:"请设置汇率",center:!0});return}const{status:a}=await b.create(e);a===1&&s.success({message:"新增成功",center:!0})}else if(e.projectType===2){e.memberPrice=(e.doMoneyPrice*e.exchangeRate).toFixed(2);const a=q(e),{status:t}=await b.addOrUpdateProjectOutsideInfo(a);t===1&&s.success({message:"编辑成功",center:!0})}else{const{status:a}=await b.edit(e);a===1&&s.success({message:"编辑成功",center:!0})}M("fetch-data"),_()},1e3)}else L.value.activeLeftTab=u.value.indexOf("rejected"),s.warning({message:"请完善表单",center:!0});i.value=!1}function _(){r=v([]),u.value=[],c.value=[],m.value=!1,l.value==="新增"&&(j.projectManagementList=null)}const F=async()=>{await E.getCustomerList(),await U.getCountry()};return K(async()=>{await F()}),k({showEdit:Q}),(e,a)=>{const t=re,o=h("el-button"),G=h("el-drawer"),H=W("loading");return x(),Y("div",null,[p(G,{modelValue:m.value,"onUpdate:modelValue":a[0]||(a[0]=X=>m.value=X),class:"hide-drawer-header","append-to-body":"","close-on-click-modal":!1,"destroy-on-close":"",draggable:"",size:"70%"},{footer:d(()=>[ee("div",ue,[I(p(o,{link:""},{default:d(()=>[p(t,{name:"ant-design:clock-circle-outlined"}),y("   "+te(w.value),1)]),_:1},512),[[S,w.value]]),p(o,{type:"primary",onClick:z,disabled:i.value},{default:d(()=>[y(" 发布项目 ")]),_:1},8,["disabled"]),I(p(o,{type:"warning",onClick:B,disabled:i.value},{default:d(()=>[y(" 暂存 ")]),_:1},8,["disabled"]),[[S,l.value!=="编辑"]]),p(o,{onClick:_,disabled:i.value},{default:d(()=>[y(" 取消 ")]),_:1},8,["disabled"])])]),default:d(()=>[C(r).length?I((x(),ae(ne,{key:0,onValidate:T,ref_key:"LeftTabsRef",ref:L,"left-tabs-data":C(r),"validate-top-tabs":c.value,"validate-all":u.value,title:l.value},null,8,["left-tabs-data","validate-top-tabs","validate-all","title"])),[[H,i.value]]):oe("",!0)]),_:1},8,["modelValue"])])}}}),qe=ie(pe,[["__scopeId","data-v-cfeef4dc"]]);export{qe as default};


/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{_ as R}from"./index.vue_vue_type_script_setup_true_lang-39t_ijWr.js";import{d as $,r as c,aj as M,Z as O,$ as g,a as T,o as k,b as U,f,w as d,v as P,g as _,A as b,i as v,e as Z,j as q,O as F,ai as w,ap as G,E as n,M as H}from"./index-puGejJ6c.js";import{o as J,s as S}from"./apiLoading-Do9_i-IR.js";import{u as K}from"./stagedData-A7GL_opg.js";import{u as Q}from"./user_customer-DvOINNsm.js";import"./index-BUCbtqtY.js";import"./index-CUmVAZCa.js";import"./index-SAQW-vwF.js";import"./clipboard-H53ocpNK.js";import"./index-CFfB7R5X.js";import"./department-seGLeyJu.js";import"./position_manage-Cb_w8K_K.js";import"./configuration_role-CgE4XECS.js";import"./tenant_role-DD26ESSk.js";import"./configuration_manager-wNI0w8HH.js";import"./configuration_siteSetting-BNl6df_X.js";import"./configuration_site_setting-C_W066o8.js";const W={class:"flex-c"},X=$({__name:"index",emits:["fetch-data"],setup(Y,{expose:x,emit:A}){const p=K(),C=Q(),D=A,i=c(!1),r=c(""),{t:o}=M(),h=c(),l=c([]),u=c([]);function L(e){u.value.push(e)}O("validateTopTabs",L);let t=g([]);async function V(e){if(!e)r.value="新增",t=p.userCustomer||[{...C.initialTopTabsData}];else{r.value="编辑";const{data:s}=await J(w.detail({tenantCustomerId:e.tenantCustomerId}));j(s)}l.value=[],i.value=!0}function j(e){t.length=0,t.push({...e})}function I(e){const s=new Set;for(const a of e){if(s.has(a.customerAccord))return!0;s.add(a.customerAccord)}return!1}function N(){p.userCustomer=G(t),t=g([]),i.value=!1,u.value=[]}function E(){t=g([]),i.value=!1,u.value=[],r.value==="新增"&&(p.userCustomer=null)}async function y(){const e=[];u.value.forEach(a=>{e.push(a.validate())});const s=await Promise.allSettled(e);l.value=s.map(a=>a.status)}async function B(){if(await y(),l.value.every(e=>e==="fulfilled")){for(const e of t){let s=e.rateAudit,a=e.turnover;const m=/^[1-9]\d*$/;if(e.riskControl==2){if(!e.turnover&&!e.rateAudit){n.warning({message:"风险控制必填一项，且是正整数",center:!0});return}if(e.turnover&&!m.test(a)){n.warning({message:"营业限额必须是大于0的正整数",center:!0});return}if(e.rateAudit&&!m.test(s)){n.warning({message:"审核率必须是大于0的正整数",center:!0});return}}}if(I(t))n.warning({message:o("customerEdit.sameName"),center:!0});else{if(r.value==="新增"){const e={tenantCustomerInfoList:t};t.turnover&&t.turnover.length&&t.turnover.forEach(a=>{a.turnover=a.turnover==0?null:a.turnover});const{status:s}=await S(w.create(e));s===1&&n.success({message:o("customerEdit.addSuccess"),center:!0})}else{t[0].riskControl===1&&(t[0].turnover=null,t[0].rateAudit=null),t[0].turnover=t[0].turnover==0?null:t[0].turnover;const{status:e}=await S(w.edit(t[0]));e===1&&n.success({message:o("customerEdit.changeSuccess"),center:!0})}C.customer=null,D("fetch-data"),E()}}else h.value.activeLeftTab=l.value.indexOf("rejected"),n.warning({message:o("customerEdit.perfect"),center:!0})}return x({showEdit:V}),(e,s)=>{const a=T("el-button"),m=T("el-drawer");return k(),U("div",null,[f(m,{modelValue:i.value,"onUpdate:modelValue":s[0]||(s[0]=z=>i.value=z),class:F(r.value==="新增"?"hide-drawer-header":"edit-drawer"),"append-to-body":"","close-on-click-modal":!1,"destroy-on-close":"",draggable:"",size:"70%"},{footer:d(()=>[P("div",W,[f(a,{onClick:E},{default:d(()=>[_(b(v(o)("projectEdit.cancel")),1)]),_:1}),r.value==="新增"?(k(),Z(a,{key:0,type:"warning",onClick:N},{default:d(()=>[_(b(v(o)("projectEdit.temporaryStorage")),1)]),_:1})):q("",!0),f(a,{type:"primary",onClick:B},{default:d(()=>[_(b(v(o)("projectEdit.confirm")),1)]),_:1})])]),default:d(()=>[f(R,{onValidate:y,ref_key:"LeftTabsRef",ref:h,title:r.value,"left-tabs-data":v(t),"validate-top-tabs":u.value,"validate-all":l.value},null,8,["title","left-tabs-data","validate-top-tabs","validate-all"])]),_:1},8,["modelValue","class"])])}}}),_e=H(X,[["__scopeId","data-v-9fa79386"]]);export{_e as default};

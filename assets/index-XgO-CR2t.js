
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{d as $,r as i,aE as G,aD as J,l as K,X as D,Z as g,n as W,a as x,q as ee,o as C,b as te,f as u,w as d,y as ae,s as L,ao as S,g as y,z as oe,i as w,e as re,j as se,N as ie,ap as f,E as m,_ as ne,L as le}from"./index-DT0nCSrF.js";import ce from"./index-BNHTzGO2.js";import{u as ue}from"./projectManagement_list-DjErfz4x.js";import{u as de}from"./stagedData-MOa_TYnf.js";import{u as pe}from"./user_customer-ruKWUUDy.js";import{a as _}from"./projectManagement-j7Rx1QKq.js";import"./index-CEF80ZiG.js";import"./user_customer-DJWm9WJ4.js";import"./file-CmUW3XO6.js";import"./index-DeHkaBaz.js";import"./zh_Hans-yHXnMbMF.js";import"./zh_Hans-B39mJ-rS.js";import"./index-CBaWRRFt.js";import"./index.vue_vue_type_script_setup_true_lang-Cp6bvs7O.js";import"./index-DMOozWmR.js";import"./index-B-kDrKeP.js";import"./index-BW3AIUlM.js";import"./index-BdH7-3fg.js";import"./department-D5DuygAB.js";import"./position_manage-lluigKOX.js";import"./configuration_role-BBx7Bvug.js";import"./tenant_role-XfoNmnay.js";import"./configuration_manager-pgLuSWaY.js";import"./configuration_siteSetting-BGFzqKSi.js";import"./configuration_site_setting-Bhuyuu0x.js";import"./apiLoading-RFWKUxmh.js";import"./index.vue_vue_type_script_setup_true_lang-BMzuZs5U.js";const fe={class:"flex-c"},me=$({name:"ProjeckEdit",__name:"index",emits:["fetch-data"],setup(ve,{expose:k,emit:V}){const E=i();E.value=G.local.get("currencyTypeRes");const T=J(),v=ue(),b=de(),R=K(),U=pe(),A=V,p=i(!1),n=i(""),s=i(!1),l=i([]),j=i(""),c=i([]);function M(e){l.value.push(e)}function B(e){j.value=e}D("validateTopTabs",M),D("currentProjectTimeline",B);let r=g([]);const h=i();async function N(e){try{if(s.value=!0,e){n.value="编辑";const a=await _.detail({projectId:e.projectId});Q(a.data)}else{n.value="新增";const a=f(v.initialTopTabsData);r=b.projectManagementList||g([a])}p.value=!0,c.value=[],l.value=[],s.value=!1}catch{}finally{s.value=!1}}function Q(e){e.data={configurationInformation:{initialProblem:{countryId:null,projectProblemCategoryId:null,projectQuotaQuestionType:null,projectProblemId:null,keyValue:"",questionType:null,answerValueList:[],projectAnswerIdList:[]},configurationCountryList:null,projectCategoryList:null,ProjectProblemInfoList:[]}},r=[];const{projectInfoList:a,...t}=f(e);t.descriptionUrl?t.descriptionUrl=t.descriptionUrl.split(","):t.descriptionUrl=[],r.push(t),a&&a.length&&a.forEach(o=>{o.data={configurationInformation:{initialProblem:{countryId:null,projectProblemCategoryId:null,projectQuotaQuestionType:null,projectProblemId:null,keyValue:"",questionType:null,answerValueList:[],projectAnswerIdList:[]},configurationCountryList:null,projectCategoryList:null,ProjectProblemInfoList:[]}},o.descriptionUrl=o.descriptionUrl.split(","),r.push({...o})}),v.dataBeforeEditing=f(r)}function z(){b.projectManagementList=f(r),r=g([]),p.value=!1,l.value=[]}async function I(){const e=[];l.value.forEach(t=>{e.push(t.validate())});const a=await Promise.allSettled(e);c.value=a.map(t=>t.status)}function q(e){const a=new Set;for(const t of e){if(a.has(t.name))return!0;a.add(t.name)}return!1}const F=async()=>{const e=f(r);await v.compareProjectData(v.dataBeforeEditing,e),await e.forEach(t=>{t.descriptionUrl=t.descriptionUrl.join(","),(!t.data.configurationInformation.ProjectProblemInfoList||!t.data.configurationInformation.ProjectProblemInfoList.length)&&(t.isProfile=2),t.data&&delete t.data,t.projectQuotaInfoList=t.projectQuotaInfoList.map(o=>(Array.isArray(o.answerValueList)||(o.answerValueList=[]),Array.isArray(o.projectAnswerIdList)||(o.projectAnswerIdList=[]),o))});let a=e[0];return a.projectInfoList=e.slice(1),a};async function H(){if(s.value=!0,await I(),c.value.every(e=>e==="fulfilled"))if(q(r))m({message:"项目名称重复",center:!0});else{const e=await F();setTimeout(async()=>{if(n.value==="新增"){e.currencyType==="CNY"?(e.exchangeRate=(1/T.originalExchangeRate).toFixed(2),e.memberPrice=(e.doMoneyPrice*e.exchangeRate).toFixed(2)):(e.exchangeRate=T.originalExchangeRate,e.memberPrice=(e.doMoneyPrice*e.exchangeRate).toFixed(2)),e.minimumDuration=+e.minimumDuration,e.exchangeRate||m.warning({message:"请设置汇率",center:!0});const{status:a}=await _.create(e);a===1&&m.success({message:"新增成功",center:!0})}else{const{status:a}=await _.edit(e);a===1&&m.success({message:"编辑成功",center:!0})}A("fetch-data"),P()},1e3)}else h.value.activeLeftTab=c.value.indexOf("rejected"),m.warning({message:"请完善表单",center:!0});s.value=!1}function P(){r=g([]),c.value=[],l.value=[],p.value=!1,n.value==="新增"&&(b.projectManagementList=null)}const O=async()=>{await U.getCustomerList(),await R.getCountry()};return W(async()=>{await O()}),k({showEdit:N}),(e,a)=>{const t=ne,o=x("el-button"),X=x("el-drawer"),Y=ee("loading");return C(),te("div",null,[u(X,{modelValue:p.value,"onUpdate:modelValue":a[0]||(a[0]=Z=>p.value=Z),class:ie(n.value==="新增"||w(r).length>1?"hide-drawer-header":"edit-drawer"),"append-to-body":"","close-on-click-modal":!1,"destroy-on-close":"",draggable:"",size:"70%"},{footer:d(()=>[ae("div",fe,[L(u(o,{link:""},{default:d(()=>[u(t,{name:"ant-design:clock-circle-outlined"}),y("   "+oe(j.value),1)]),_:1},512),[[S,j.value]]),u(o,{type:"primary",onClick:H,disabled:s.value},{default:d(()=>[y(" 发布项目 ")]),_:1},8,["disabled"]),L(u(o,{type:"warning",onClick:z,disabled:s.value},{default:d(()=>[y(" 暂存 ")]),_:1},8,["disabled"]),[[S,n.value!=="编辑"]]),u(o,{onClick:P,disabled:s.value},{default:d(()=>[y(" 取消 ")]),_:1},8,["disabled"])])]),default:d(()=>[w(r).length?L((C(),re(ce,{key:0,onValidate:I,ref_key:"LeftTabsRef",ref:h,"left-tabs-data":w(r),"validate-top-tabs":l.value,"validate-all":c.value,title:n.value},null,8,["left-tabs-data","validate-top-tabs","validate-all","title"])),[[Y,s.value]]):se("",!0)]),_:1},8,["modelValue","class"])])}}}),Fe=le(me,[["__scopeId","data-v-30663045"]]);export{Fe as default};

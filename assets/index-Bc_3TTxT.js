
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{_ as R}from"./index.vue_vue_type_script_setup_true_lang-CEUq8RoA.js";import{a as g}from"./user_customer-D2JbUfDT.js";import{o as M,s as E}from"./apiLoading-Ck1InyLC.js";import{u as U}from"./stagedData-DK-vqQxj.js";import{u as $}from"./user_customer-gZBCLrqP.js";import{d as O,r as c,ae as P,M as q,N as _,a3 as T,b as S,j as F,g as f,w as d,f as G,h as b,t as w,i as p,c as H,k as J,B as K,ak as Q,ai as n,z as W}from"./index-mJqsIMw-.js";import"./index-tEMvdODh.js";import"./index-BeaBUBqL.js";import"./index-BoZt1Db4.js";import"./clipboard-BP3U3eyp.js";import"./index-D8sc6Ibu.js";import"./department-Dtv_2BGp.js";import"./position_manage-BxYdaog_.js";import"./configuration_role-icY-vblN.js";import"./tenant_role-BtxbcMsu.js";import"./configuration_manager-DrUxDc7Q.js";import"./configuration_siteSetting-B16HAb84.js";import"./configuration_site_setting-I_mKCAgO.js";const X={class:"flex-c"},Y=O({__name:"index",emits:["fetch-data"],setup(Z,{expose:x,emit:D}){const v=U(),h=$(),A=D,i=c(!1),s=c(""),{t:o}=P(),C=c(),l=c([]),u=c([]);function L(e){u.value.push(e)}q("validateTopTabs",L);let t=_([]);async function V(e){if(!e)s.value="新增",t=v.userCustomer||[{...h.initialTopTabsData}];else{s.value="编辑";const{data:r}=await M(g.detail({tenantCustomerId:e.tenantCustomerId}));N(r)}l.value=[],i.value=!0}function N(e){t.length=0,t.push({...e})}function j(e){const r=new Set;for(const a of e){if(r.has(a.customerAccord))return!0;r.add(a.customerAccord)}return!1}function B(){v.userCustomer=Q(t),t=_([]),i.value=!1,u.value=[]}function k(){t=_([]),i.value=!1,u.value=[],s.value==="新增"&&(v.userCustomer=null)}async function y(){const e=[];u.value.forEach(a=>{e.push(a.validate())});const r=await Promise.allSettled(e);l.value=r.map(a=>a.status)}async function I(){if(await y(),l.value.every(e=>e==="fulfilled")){for(const e of t){let r=e.rateAudit,a=e.turnover;const m=/^[1-9]\d*$/;if(e.riskControl==2){if(!e.turnover&&!e.rateAudit){n.warning({message:"风险控制必填一项，且是正整数",center:!0});return}if(e.turnover&&!m.test(a)){n.warning({message:"营业限额必须是大于0的正整数",center:!0});return}if(e.rateAudit&&!m.test(r)){n.warning({message:"审核率必须是大于0的正整数",center:!0});return}}}if(j(t))n.warning({message:o("customerEdit.sameName"),center:!0});else{if(s.value==="新增"){const e={tenantCustomerInfoList:t};t.turnover&&t.turnover.length&&t.turnover.forEach(a=>{a.turnover=a.turnover==0?null:a.turnover});const{status:r}=await E(g.create(e));r===1&&n.success({message:o("customerEdit.addSuccess"),center:!0})}else{t[0].riskControl===1&&(t[0].turnover=null,t[0].rateAudit=null),t[0].turnover=t[0].turnover==0?null:t[0].turnover;const{status:e}=await E(g.edit(t[0]));e===1&&n.success({message:o("customerEdit.changeSuccess"),center:!0})}h.customer=null,A("fetch-data"),k()}}else C.value.activeLeftTab=l.value.indexOf("rejected"),n.warning({message:o("customerEdit.perfect"),center:!0})}return x({showEdit:V}),(e,r)=>{const a=T("el-button"),m=T("el-drawer");return S(),F("div",null,[f(m,{modelValue:i.value,"onUpdate:modelValue":r[0]||(r[0]=z=>i.value=z),class:K(s.value==="新增"?"hide-drawer-header":"edit-drawer"),"append-to-body":"","close-on-click-modal":!1,"destroy-on-close":"",draggable:"",size:"70%"},{footer:d(()=>[G("div",X,[f(a,{onClick:k},{default:d(()=>[b(w(p(o)("projectEdit.cancel")),1)]),_:1}),s.value==="新增"?(S(),H(a,{key:0,type:"warning",onClick:B},{default:d(()=>[b(w(p(o)("projectEdit.temporaryStorage")),1)]),_:1})):J("",!0),f(a,{type:"primary",onClick:I},{default:d(()=>[b(w(p(o)("projectEdit.confirm")),1)]),_:1})])]),default:d(()=>[f(R,{onValidate:y,ref_key:"LeftTabsRef",ref:C,title:s.value,"left-tabs-data":p(t),"validate-top-tabs":u.value,"validate-all":l.value},null,8,["title","left-tabs-data","validate-top-tabs","validate-all"])]),_:1},8,["modelValue","class"])])}}}),be=W(Y,[["__scopeId","data-v-9fa79386"]]);export{be as default};


/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{_ as I}from"./index.vue_vue_type_script_setup_true_lang-BEYxzqOT.js";import{a as v}from"./user_customer-BKfab0DM.js";import{o as z,s as h}from"./apiLoading-BkWD-BgA.js";import{u as R}from"./stagedData-DWKmZV4v.js";import{u as j}from"./user_customer-B93FXzVn.js";import{d as U,r as i,X as $,Z as p,a as y,o as T,b as M,f,w as c,y as O,g,e as P,j as X,i as Z,N as q,ao as F,E as o,L as G}from"./index-C3YtDUn5.js";import"./index-BzJTD4R0.js";import"./index-ByfbK2gu.js";import"./index-pSdFSvOL.js";import"./clipboard-CZvtegm2.js";import"./index-BnSdldoB.js";import"./department-iU4_OEie.js";import"./position_manage-BJo_0Ekr.js";import"./configuration_role-DOZyp22B.js";import"./tenant_role-kIJOcYlm.js";import"./configuration_manager-iT9AcaGf.js";import"./configuration_siteSetting-C7qY9bdj.js";import"./configuration_site_setting-eXhx02jH.js";const H={class:"flex-c"},J=U({__name:"index",emits:["fetch-data"],setup(K,{expose:k,emit:x}){const m=R(),_=j(),L=x,n=i(!1),s=i(""),b=i(),l=i([]),u=i([]);function A(e){u.value.push(e)}$("validateTopTabs",A);let t=p([]);async function D(e){if(!e)s.value="新增",t=m.userCustomer||[{..._.initialTopTabsData}];else{s.value="编辑";const{data:r}=await z(v.detail({tenantCustomerId:e.tenantCustomerId}));V(r)}l.value=[],n.value=!0}function V(e){t.length=0,t.push({...e})}function E(e){const r=new Set;for(const a of e){if(r.has(a.customerAccord))return!0;r.add(a.customerAccord)}return!1}function S(){m.userCustomer=F(t),t=p([]),n.value=!1,u.value=[]}function w(){t=p([]),n.value=!1,u.value=[],s.value==="新增"&&(m.userCustomer=null)}async function C(){const e=[];u.value.forEach(a=>{e.push(a.validate())});const r=await Promise.allSettled(e);l.value=r.map(a=>a.status)}async function N(){if(await C(),l.value.every(e=>e==="fulfilled")){for(const e of t){let r=e.rateAudit,a=e.turnover;const d=/^[1-9]\d*$/;if(e.riskControl==2){if(!e.turnover&&!e.rateAudit){o.warning({message:"风险控制必填一项，且是正整数",center:!0});return}if(e.turnover&&!d.test(a)){o.warning({message:"营业限额必须是大于0的正整数",center:!0});return}if(e.rateAudit&&!d.test(r)){o.warning({message:"审核率必须是大于0的正整数",center:!0});return}}}if(E(t))o.warning({message:"客户名称重复",center:!0});else{if(s.value==="新增"){const e={tenantCustomerInfoList:t};t.turnover&&t.turnover.length&&t.turnover.forEach(a=>{a.turnover=a.turnover==0?null:a.turnover});const{status:r}=await h(v.create(e));r===1&&o.success({message:"新增成功",center:!0})}else{t[0].riskControl===1&&(t[0].turnover=null,t[0].rateAudit=null),t[0].turnover=t[0].turnover==0?null:t[0].turnover;const{status:e}=await h(v.edit(t[0]));e===1&&o.success({message:"修改成功",center:!0})}_.customer=null,L("fetch-data"),w()}}else b.value.activeLeftTab=l.value.indexOf("rejected"),o.warning({message:"请完善表单",center:!0})}return k({showEdit:D}),(e,r)=>{const a=y("el-button"),d=y("el-drawer");return T(),M("div",null,[f(d,{modelValue:n.value,"onUpdate:modelValue":r[0]||(r[0]=B=>n.value=B),class:q(s.value==="新增"?"hide-drawer-header":"edit-drawer"),"append-to-body":"","close-on-click-modal":!1,"destroy-on-close":"",draggable:"",size:"70%"},{footer:c(()=>[O("div",H,[f(a,{onClick:w},{default:c(()=>[g(" 取消 ")]),_:1}),s.value==="新增"?(T(),P(a,{key:0,type:"warning",onClick:S},{default:c(()=>[g(" 暂存 ")]),_:1})):X("",!0),f(a,{type:"primary",onClick:N},{default:c(()=>[g(" 确定 ")]),_:1})])]),default:c(()=>[f(I,{onValidate:C,ref_key:"LeftTabsRef",ref:b,title:s.value,"left-tabs-data":Z(t),"validate-top-tabs":u.value,"validate-all":l.value},null,8,["title","left-tabs-data","validate-top-tabs","validate-all"])]),_:1},8,["modelValue","class"])])}}}),pe=G(J,[["__scopeId","data-v-8fa6cea3"]]);export{pe as default};

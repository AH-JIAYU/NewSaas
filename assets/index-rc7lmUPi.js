
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{_ as I}from"./index.vue_vue_type_script_setup_true_lang-BPb8v1Xe.js";import{a as m}from"./user_customer-CPCvM_Jn.js";import{o as z,s as w}from"./apiLoading-_KwNLxuw.js";import{u as R}from"./stagedData-BXU5BRmt.js";import{u as j}from"./user_customer-ytAkXSuq.js";import{d as U,r as i,X as $,Z as v,a as h,o as y,b as M,f as d,w as u,y as O,g as p,e as P,j as X,i as Z,N as q,ao as F,E as c,L as G}from"./index-1eibXPOg.js";import"./index-D-a17TnJ.js";import"./index-BmIiZeRI.js";import"./index-BJn0i__G.js";import"./clipboard-BLwZa5Fc.js";import"./index-DZFRsvt4.js";import"./department-BpHf2sH_.js";import"./position_manage-1JAnuUrp.js";import"./configuration_role--G1niVAo.js";import"./tenant_role-CUn_qUo-.js";import"./configuration_manager-BBgkl3pt.js";import"./configuration_siteSetting-Dx6zqUpn.js";import"./configuration_site_setting-B0Fvht8I.js";const H={class:"flex-c"},J=U({__name:"index",emits:["fetch-data"],setup(K,{expose:T,emit:k}){const f=R(),_=j(),x=k,r=i(!1),o=i(""),g=i(),n=i([]),l=i([]);function L(e){l.value.push(e)}$("validateTopTabs",L);let t=v([]);async function D(e){if(!e)o.value="新增",t=f.userCustomer||[{..._.initialTopTabsData}];else{o.value="编辑";const{data:s}=await z(m.detail({tenantCustomerId:e.tenantCustomerId}));V(s)}n.value=[],r.value=!0}function V(e){t.length=0,t.push({...e})}function E(e){const s=new Set;for(const a of e){if(s.has(a.customerAccord))return!0;s.add(a.customerAccord)}return!1}function S(){f.userCustomer=F(t),t=v([]),r.value=!1,l.value=[]}function b(){t=v([]),r.value=!1,l.value=[],o.value==="新增"&&(f.userCustomer=null)}async function C(){const e=[];l.value.forEach(a=>{e.push(a.validate())});const s=await Promise.allSettled(e);n.value=s.map(a=>a.status)}async function A(){if(await C(),n.value.every(e=>e==="fulfilled")){for(const e of t){let s=e.rateAudit;if(!/^[1-9]\d*$/.test(s)&&e.riskControl==2){c.warning({message:"审核率必须是大于0的正整数",center:!0});return}}if(E(t))c.warning({message:"客户名称重复",center:!0});else{if(o.value==="新增"){const e={tenantCustomerInfoList:t};t.turnover&&t.turnover.length&&t.turnover.forEach(a=>{a.turnover=a.turnover==0?null:a.turnover});const{status:s}=await w(m.create(e));s===1&&c.success({message:"新增成功",center:!0})}else{t[0].riskControl===1&&(t[0].turnover=null,t[0].rateAudit=null),t[0].turnover=t[0].turnover==0?null:t[0].turnover;const{status:e}=await w(m.edit(t[0]));e===1&&c.success({message:"修改成功",center:!0})}_.customer=null,x("fetch-data"),b()}}else g.value.activeLeftTab=n.value.indexOf("rejected"),c.warning({message:"请完善表单",center:!0})}return T({showEdit:D}),(e,s)=>{const a=h("el-button"),N=h("el-drawer");return y(),M("div",null,[d(N,{modelValue:r.value,"onUpdate:modelValue":s[0]||(s[0]=B=>r.value=B),class:q(o.value==="新增"?"hide-drawer-header":"edit-drawer"),"append-to-body":"","close-on-click-modal":!1,"destroy-on-close":"",draggable:"",size:"70%"},{footer:u(()=>[O("div",H,[d(a,{onClick:b},{default:u(()=>[p(" 取消 ")]),_:1}),o.value==="新增"?(y(),P(a,{key:0,type:"warning",onClick:S},{default:u(()=>[p(" 暂存 ")]),_:1})):X("",!0),d(a,{type:"primary",onClick:A},{default:u(()=>[p(" 确定 ")]),_:1})])]),default:u(()=>[d(I,{onValidate:C,ref_key:"LeftTabsRef",ref:g,title:o.value,"left-tabs-data":Z(t),"validate-top-tabs":l.value,"validate-all":n.value},null,8,["title","left-tabs-data","validate-top-tabs","validate-all"])]),_:1},8,["modelValue","class"])])}}}),pe=G(J,[["__scopeId","data-v-90220db9"]]);export{pe as default};

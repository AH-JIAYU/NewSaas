
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import N from"./index-fBsTXHVK.js";import{o as R}from"./apiLoading-DUZm31YG.js";import{u as z,a as y}from"./index-By9cxPVj.js";import{u as U}from"./stagedData-CcolcJQm.js";import{u as G}from"./otherFunctions_basicDictionary-BPMnqCZl.js";import{u as H}from"./user_customer-BA7LapcC.js";import{d as O,r as u,a3 as F,a4 as f,G as J,a as I,o as T,b as K,f as p,w as d,g,i as _,e as W,j as X,an as m,ak as L,_ as Y}from"./index-LooN7LAT.js";import"./index.vue_vue_type_script_setup_true_lang-Cu6CY5Pd.js";import"./index-PaHEmWxv.js";import"./index-DFJLODe7.js";import"./basicDictionary-CN5sUaNN.js";import"./user_customer-D-OWd7Ke.js";const Z=O({name:"ProjeckEdit",__name:"index",emits:["fetch-data"],setup($,{expose:A,emit:h}){const V=z(),j=U(),C=G(),D=H(),k=h,n=u(!1),l=u(""),i=u([]);function P(a){i.value.push(a)}F("validateTopTabs",P);const c=u([]);let s=f([]);const v=u();async function S(a){if(a){l.value="编辑";const e=await R(y.detail({projectId:a.projectId}));console.log("res.data",e.data),E(e.data)}else{l.value="添加";const e=m(V.initialTopTabsData);s=j.projectManagementList||f([e])}n.value=!0}function E(a){a.data={configurationInformation:{initialProblem:{countryId:null,projectProblemCategoryId:null,projectQuotaQuestionType:null,projectProblemId:null,keyValue:"",questionType:null,answerValueList:[],projectAnswerIdList:[]},configurationCountryList:null,projectCategoryList:null,ProjectProblemInfoList:[]}},s=[];const{projectInfoList:e,...t}=m(a);s.push(t),e&&e.length&&e.forEach(o=>{o.data={configurationInformation:{initialProblem:{countryId:null,projectProblemCategoryId:null,projectQuotaQuestionType:null,projectProblemId:null,keyValue:"",questionType:null,answerValueList:[],projectAnswerIdList:[]},configurationCountryList:null,projectCategoryList:null,ProjectProblemInfoList:[]}},s.push({...o})}),s.forEach(o=>{o.projectQuotaInfoList.forEach(r=>{r.projectAnswerIdList=r.questionType===2?r.projectAnswerIdList[0]:r.projectAnswerIdList})})}function Q(){j.projectManagementList=m(s),s=f([]),n.value=!1,i.value=[]}async function w(){const a=[];i.value.forEach(t=>{a.push(t.validate())});const e=await Promise.allSettled(a);c.value=e.map(t=>t.status)}function x(a){const e=new Set;for(const t of a){if(e.has(t.name))return!0;e.add(t.name)}return!1}const M=()=>{const a=m(s);let e=a[0];return e.projectInfoList=a.slice(1),e.data&&delete e.data,e.projectQuotaInfoList=e.projectQuotaInfoList.map(t=>(Array.isArray(t.answerValueList)||(t.answerValueList=[t.answerValueList]),Array.isArray(t.projectAnswerIdList)||(t.projectAnswerIdList=[t.projectAnswerIdList]),t)),e.projectInfoList.forEach(t=>{t.data&&delete t.data,t.projectQuotaInfoList=t.projectQuotaInfoList.map(o=>(Array.isArray(o.answerValueList)||(o.answerValueList=[o.answerValueList]),Array.isArray(o.projectAnswerIdList)||(o.projectAnswerIdList=[o.projectAnswerIdList]),o))}),console.log("masterData",e),e};async function B(){if(await w(),c.value.every(a=>a==="fulfilled"))if(x(s))L.warning({message:"项目名称重复",center:!0});else{const a=M();if(l.value==="添加"){const{status:e}=await y.create(a);e===1&&L.success({message:"新增成功",center:!0})}else{const{status:e}=await y.edit(a);e===1&&L.success({message:"编辑成功",center:!0})}b(),k("fetch-data")}else v.value.activeLeftTab=c.value.indexOf("rejected"),L.warning({message:"请完善表单",center:!0})}function b(){s=f([]),c.value=[],n.value=!1,i.value=[],l.value==="添加"&&(j.projectManagementList=null)}const q=async()=>{await D.getCustomerList(),await C.getCountry()};return J(async()=>{await q()}),A({showEdit:S}),(a,e)=>{const t=I("el-button"),o=I("el-drawer");return T(),K("div",null,[p(o,{modelValue:n.value,"onUpdate:modelValue":e[0]||(e[0]=r=>n.value=r),class:"hide-drawer-header","append-to-body":"","close-on-click-modal":!1,"destroy-on-close":"",draggable:"",size:"70%"},{footer:d(()=>[p(t,{onClick:b},{default:d(()=>[g(" 取消 ")]),_:1}),p(t,{type:"warning",onClick:Q},{default:d(()=>[g(" 暂存 ")]),_:1}),p(t,{type:"primary",onClick:B},{default:d(()=>[g(" 确定 ")]),_:1})]),default:d(()=>[_(s).length?(T(),W(N,{key:0,onValidate:w,ref_key:"LeftTabsRef",ref:v,"left-tabs-data":_(s),"validate-top-tabs":i.value,"validate-all":c.value,title:l.value},null,8,["left-tabs-data","validate-top-tabs","validate-all","title"])):X("",!0)]),_:1},8,["modelValue"])])}}}),fe=Y(Z,[["__scopeId","data-v-7d24f52f"]]);export{fe as default};

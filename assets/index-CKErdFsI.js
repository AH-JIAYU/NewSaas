
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import q from"./index-DWxs5lCP.js";import{o as z,s as I}from"./apiLoading-CrxRh83D.js";import{u as U}from"./index-5zbZRUWx.js";import{u as H}from"./stagedData-D70JL1tK.js";import{u as O}from"./otherFunctions_basicDictionary-CRwPcrub.js";import{u as F}from"./user_customer-D78qkQvh.js";import{a as v}from"./projectManagement-B8zhJttK.js";import{d as G,r as l,a1 as J,a2 as f,D as K,a as _,o as T,b as W,f as d,w as u,g as y,i as h,e as X,j as Y,an as p,ak as m,_ as Z}from"./index-YfzbGMdb.js";import"./index.vue_vue_type_script_setup_true_lang-CHtIYP1D.js";import"./index-DtQ0a6Ro.js";import"./zh_Hans-B39mJ-rS.js";import"./file-B9lNIavo.js";import"./basicDictionary-CUmlckKQ.js";import"./user_customer-DP3Ptcu_.js";const $=G({name:"ProjeckEdit",__name:"index",emits:["fetch-data"],setup(ee,{expose:C,emit:D}){const V=U(),L=H(),A=O(),k=F(),P=D,i=l(!1),c=l(""),r=l([]);function S(a){r.value.push(a)}J("validateTopTabs",S);const n=l([]);let o=f([]);const g=l();async function E(a){if(a){c.value="编辑";const e=await z(v.detail({projectId:a.projectId}));Q(e.data)}else{c.value="添加";const e=p(V.initialTopTabsData);o=L.projectManagementList||f([e])}i.value=!0,n.value=[],r.value=[]}function Q(a){a.data={configurationInformation:{initialProblem:{countryId:null,projectProblemCategoryId:null,projectQuotaQuestionType:null,projectProblemId:null,keyValue:"",questionType:null,answerValueList:[],projectAnswerIdList:[]},configurationCountryList:null,projectCategoryList:null,ProjectProblemInfoList:[]}},o=[];const{projectInfoList:e,...t}=p(a);o.push(t),e&&e.length&&e.forEach(s=>{s.data={configurationInformation:{initialProblem:{countryId:null,projectProblemCategoryId:null,projectQuotaQuestionType:null,projectProblemId:null,keyValue:"",questionType:null,answerValueList:[],projectAnswerIdList:[]},configurationCountryList:null,projectCategoryList:null,ProjectProblemInfoList:[]}},o.push({...s})}),o.forEach(s=>{s.projectQuotaInfoList.forEach(w=>{})})}function x(){L.projectManagementList=p(o),o=f([]),i.value=!1,r.value=[]}async function j(){const a=[];r.value.forEach(t=>{a.push(t.validate())});const e=await Promise.allSettled(a);n.value=e.map(t=>t.status)}function M(a){const e=new Set;for(const t of a){if(e.has(t.name))return!0;e.add(t.name)}return!1}const B=()=>{const a=p(o);let e=a[0];return e.projectInfoList=a.slice(1),e.data&&delete e.data,e.projectQuotaInfoList=e.projectQuotaInfoList.map(t=>(Array.isArray(t.answerValueList)||(t.answerValueList=[]),Array.isArray(t.projectAnswerIdList)||(t.projectAnswerIdList=[]),t)),e.projectInfoList.forEach(t=>{t.data&&delete t.data,t.projectQuotaInfoList=t.projectQuotaInfoList.map(s=>(Array.isArray(s.answerValueList)||(s.answerValueList=[]),Array.isArray(s.projectAnswerIdList)||(s.projectAnswerIdList=[]),s))}),e};async function N(){if(await j(),n.value.every(a=>a==="fulfilled"))if(M(o))m({message:"项目名称重复",center:!0});else{const a=B();if(c.value==="添加"){const{status:e}=await I(v.create(a));e===1&&m.success({message:"新增成功",center:!0})}else{const{status:e}=await I(v.edit(a));e===1&&m.success({message:"编辑成功",center:!0})}P("fetch-data"),b()}else g.value.activeLeftTab=n.value.indexOf("rejected"),m.warning({message:"请完善表单",center:!0})}function b(){o=f([]),n.value=[],r.value=[],i.value=!1,c.value==="添加"&&(L.projectManagementList=null)}const R=async()=>{await k.getCustomerList(),await A.getCountry()};return K(async()=>{await R()}),C({showEdit:E}),(a,e)=>{const t=_("el-button"),s=_("el-drawer");return T(),W("div",null,[d(s,{modelValue:i.value,"onUpdate:modelValue":e[0]||(e[0]=w=>i.value=w),class:"hide-drawer-header","append-to-body":"","close-on-click-modal":!1,"destroy-on-close":"",draggable:"",size:"70%"},{footer:u(()=>[d(t,{onClick:b},{default:u(()=>[y(" 取消 ")]),_:1}),d(t,{type:"warning",onClick:x},{default:u(()=>[y(" 暂存 ")]),_:1}),d(t,{type:"primary",onClick:N},{default:u(()=>[y(" 确定 ")]),_:1})]),default:u(()=>[h(o).length?(T(),X(q,{key:0,onValidate:j,ref_key:"LeftTabsRef",ref:g,"left-tabs-data":h(o),"validate-top-tabs":r.value,"validate-all":n.value},null,8,["left-tabs-data","validate-top-tabs","validate-all"])):Y("",!0)]),_:1},8,["modelValue"])])}}}),Le=Z($,[["__scopeId","data-v-83e14e9d"]]);export{Le as default};

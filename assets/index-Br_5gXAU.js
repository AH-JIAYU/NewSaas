
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import N from"./index-DbKEE7n1.js";import{o as R,s as I}from"./apiLoading-jtBT__Py.js";import{u as q}from"./index-9wJhxEal.js";import{u as H}from"./stagedData-N45aJp0P.js";import{u as O}from"./otherFunctions_basicDictionary-Du3cf_mZ.js";import{u as F}from"./user_customer-DoVXLjLb.js";import{a as g}from"./projectManagement-CODubgU_.js";import{d as G,r as c,a2 as J,a3 as d,l as K,a as T,o as _,b as W,f as p,w as u,g as b,i as y,e as X,j as Y,Q as Z,an as f,E as m,P as $}from"./index-BV7R4jFg.js";import"./index.vue_vue_type_script_setup_true_lang-qIBlMCux.js";import"./index-BTwe22ki.js";import"./zh_Hans-B39mJ-rS.js";import"./file-Daczv_K0.js";import"./basicDictionary-CavQGtqw.js";import"./user_customer-DznD2EzY.js";const ee=G({name:"ProjeckEdit",__name:"index",emits:["fetch-data"],setup(te,{expose:C,emit:h}){const D=q(),v=H(),P=O(),V=F(),k=h,l=c(!1),r=c(""),n=c([]),i=c([]);function S(e){n.value.push(e)}J("validateTopTabs",S);let o=d([]);const L=c();async function A(e){if(e){r.value="编辑";const t=await R(g.detail({projectId:e.projectId}));E(t.data)}else{r.value="新增";const t=f(D.initialTopTabsData);o=v.projectManagementList||d([t])}l.value=!0,i.value=[],n.value=[]}function E(e){e.data={configurationInformation:{initialProblem:{countryId:null,projectProblemCategoryId:null,projectQuotaQuestionType:null,projectProblemId:null,keyValue:"",questionType:null,answerValueList:[],projectAnswerIdList:[]},configurationCountryList:null,projectCategoryList:null,ProjectProblemInfoList:[]}},o=[];const{projectInfoList:t,...a}=f(e);a.descriptionUrl=a.descriptionUrl.split(","),o.push(a),t&&t.length&&t.forEach(s=>{s.data={configurationInformation:{initialProblem:{countryId:null,projectProblemCategoryId:null,projectQuotaQuestionType:null,projectProblemId:null,keyValue:"",questionType:null,answerValueList:[],projectAnswerIdList:[]},configurationCountryList:null,projectCategoryList:null,ProjectProblemInfoList:[]}},s.descriptionUrl=s.descriptionUrl.split(","),o.push({...s})})}function x(){v.projectManagementList=f(o),o=d([]),l.value=!1,n.value=[]}async function j(){const e=[];n.value.forEach(a=>{e.push(a.validate())});const t=await Promise.allSettled(e);i.value=t.map(a=>a.status)}function U(e){const t=new Set;for(const a of e){if(t.has(a.name))return!0;t.add(a.name)}return!1}const M=()=>{const e=f(o);e.forEach(a=>{a.descriptionUrl=a.descriptionUrl.join(","),a.data&&delete a.data,a.projectQuotaInfoList=a.projectQuotaInfoList.map(s=>(Array.isArray(s.answerValueList)||(s.answerValueList=[]),Array.isArray(s.projectAnswerIdList)||(s.projectAnswerIdList=[]),s))});let t=e[0];return t.projectInfoList=e.slice(1),t};async function Q(){if(await j(),i.value.every(e=>e==="fulfilled"))if(U(o))m({message:"项目名称重复",center:!0});else{const e=M();if(r.value==="新增"){const{status:t}=await I(g.create(e));t===1&&m.success({message:"新增成功",center:!0})}else{const{status:t}=await I(g.edit(e));t===1&&m.success({message:"编辑成功",center:!0})}k("fetch-data"),w()}else L.value.activeLeftTab=i.value.indexOf("rejected"),m.warning({message:"请完善表单",center:!0})}function w(){o=d([]),i.value=[],n.value=[],l.value=!1,r.value==="新增"&&(v.projectManagementList=null)}const B=async()=>{await V.getCustomerList(),await P.getCountry()};return K(async()=>{await B()}),C({showEdit:A}),(e,t)=>{const a=T("el-button"),s=T("el-drawer");return _(),W("div",null,[p(s,{modelValue:l.value,"onUpdate:modelValue":t[0]||(t[0]=z=>l.value=z),class:Z(r.value==="新增"||y(o).length>1?"hide-drawer-header":"edit-drawer"),"append-to-body":"","close-on-click-modal":!1,"destroy-on-close":"",draggable:"",size:"70%"},{footer:u(()=>[p(a,{onClick:w},{default:u(()=>[b(" 取消 ")]),_:1}),p(a,{type:"warning",onClick:x},{default:u(()=>[b(" 暂存 ")]),_:1}),p(a,{type:"primary",onClick:Q},{default:u(()=>[b(" 确定 ")]),_:1})]),default:u(()=>[y(o).length?(_(),X(N,{key:0,onValidate:j,ref_key:"LeftTabsRef",ref:L,"left-tabs-data":y(o),"validate-top-tabs":n.value,"validate-all":i.value,title:r.value},null,8,["left-tabs-data","validate-top-tabs","validate-all","title"])):Y("",!0)]),_:1},8,["modelValue","class"])])}}}),ge=$(ee,[["__scopeId","data-v-cfd8cb82"]]);export{ge as default};


/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{o as k,s as X}from"./apiLoading-CLJ-8bWY.js";import{a as j}from"./projectManagement-voiV3NHe.js";import{a as Y}from"./user_cooperation-DdL4vE-_.js";import{a as Z}from"./survey_vip_department-r9v5CC0P.js";import{U as ee}from"./user_supplier-v3mOkSmD.js";import{u as le}from"./survey_vipGroup-BqyQQd54.js";import{d as te,r as m,n as ae,a as i,q as oe,o as s,b as V,f as n,w as t,y as re,g as d,s as ne,i as l,e as c,j as h,F as N,t as U,A as ie,E as se,L as ue}from"./index-NZXF151a.js";import"./user_supplier-DzW9vZVZ.js";import"./survey_vipGroup-v8FGxSHE.js";const pe={style:{flex:"auto"}},de=te({name:"AllocationEdit",__name:"index",emits:["fetch-data"],setup(ce,{expose:E,emit:B}){const K=ee();le();const R=B,S=m(!1),I=m(!1),L=m(),y=m(),v=m([]),z={children:"children",label:"name"},x=m([]),e=m({title:"分配",list:[],tenantSupplierList:[],departmentList:[],tenantList:[],form:{projectId:"",allocationType:1,groupSupplierIdList:[],deleteSet:[]},selectAll:{supplier:!1,member:!1,tenant:!1}}),F=m({groupSupplierIdList:[{type:"array",required:!0,trigger:"change",message:"请选择分配目标"}]});async function O(r,a){if(e.value.list=[{...r}],a==="reassign"){e.value.title="重新分配";const f=await k(j.getProjectAllocation({projectId:r.projectId})),{groupSupplierIdSet:_,...p}=f.data;e.value.form=p,e.value.form.groupSupplierIdList=_,x.value=JSON.parse(JSON.stringify(_))}else e.value.title="分配",e.value.form.projectId=r.projectId;e.value.tenantSupplierList=await k(K.getTenantSupplierList(r.projectId));const u=await Z.list({name:""});e.value.departmentList=u.data;const g=await k(Y.getAllocationBindList({projectId:r.projectId}));v.value=[],e.value.form.groupSupplierIdList&&e.value.form.allocationType===3&&(v.value=e.value.form.groupSupplierIdList),e.value.tenantList=g.data.allocationBindInfoList,I.value=!0}function q(){e.value.form.groupSupplierIdList=[]}function D(){e.value.form.groupSupplierIdList=[],e.value.selectAll.tenant&&e.value.tenantList.map(r=>{e.value.form.groupSupplierIdList.push(r.beInvitationTenantId)})}function H(){e.value.form.groupSupplierIdList=[],e.value.selectAll.supplier&&e.value.tenantSupplierList.map(r=>{e.value.form.groupSupplierIdList.push(r.tenantSupplierId)})}const J=(r,a)=>{a?(y.value.getCheckedKeys().forEach(p=>{p!==r.id&&y.value.setChecked(p,!1)}),v.value=[r.id]):v.value=v.value.filter(_=>_!==r.id),v.value=y.value.getCheckedKeys(!1);const u=y.value.getCheckedKeys(),g=y.value.getHalfCheckedKeys(),f=u.concat(g);e.value.form.groupSupplierIdList=f};function b(){L.value.resetFields(),Object.assign(e.value.form,{projectId:"",allocationType:1,groupSupplierIdList:[],deleteSet:[]}),I.value=!1}function M(){L.value.validate(async r=>{if(r)try{S.value=!0;const a=x.value.filter(g=>!e.value.form.groupSupplierIdList.includes(g));e.value.form.deleteSet=a;const{status:u}=await X(j.allocation(e.value.form));S.value=!1,u===1&&se.success({message:"分配成功",center:!0}),b(),R("fetch-data")}catch{}finally{S.value=!1}})}return ae(async()=>{}),E({showEdit:O}),(r,a)=>{const u=i("el-table-column"),g=i("el-table"),f=i("el-radio"),_=i("el-radio-group"),p=i("el-form-item"),T=i("el-checkbox"),w=i("el-option"),C=i("el-select"),P=i("el-tree"),G=i("el-text"),$=i("el-form"),A=i("el-button"),Q=i("el-dialog"),W=oe("loading");return s(),V("div",null,[n(Q,{modelValue:l(I),"onUpdate:modelValue":a[5]||(a[5]=o=>ie(I)?I.value=o:null),title:"分配",width:"700","before-close":b},{footer:t(()=>[re("div",pe,[n(A,{onClick:b},{default:t(()=>[d(" 取消 ")]),_:1}),n(A,{type:"primary",onClick:M},{default:t(()=>[d(" 确定 ")]),_:1})])]),default:t(()=>[ne((s(),c(g,{data:l(e).list,"row-key":"id"},{default:t(()=>[n(u,{align:"left","show-overflow-tooltip":"",label:"项目名称",prop:"name"}),n(u,{align:"left","show-overflow-tooltip":"",label:"项目编码",prop:"projectId"}),n(u,{align:"left","show-overflow-tooltip":"",label:"客户简称",width:"100",prop:"clientName"})]),_:1},8,["data"])),[[W,l(S)]]),n($,{ref_key:"formRef",ref:L,"label-width":"80px",rules:l(F),model:l(e).form,inline:!1},{default:t(()=>[n(p,{label:"分配目标"},{default:t(()=>[n(_,{modelValue:l(e).form.allocationType,"onUpdate:modelValue":a[0]||(a[0]=o=>l(e).form.allocationType=o),class:"ml-4",onChange:q},{default:t(()=>[n(f,{value:2,size:"large"},{default:t(()=>[d(" 供应商 ")]),_:1}),n(f,{value:3,size:"large"},{default:t(()=>[d(" 内部站 ")]),_:1}),n(f,{value:4,size:"large"},{default:t(()=>[d("合作商 ")]),_:1}),l(e).title==="重新分配"?(s(),c(f,{key:0,value:5,size:"large"},{default:t(()=>[d(" 取消分配 ")]),_:1})):h("",!0)]),_:1},8,["modelValue"])]),_:1}),l(e).form.allocationType===2&&l(e).form.allocationType!==5?(s(),c(p,{key:0,label:"供应商",prop:"groupSupplierIdList"},{default:t(()=>[n(C,{modelValue:l(e).form.groupSupplierIdList,"onUpdate:modelValue":a[2]||(a[2]=o=>l(e).form.groupSupplierIdList=o),placeholder:"请选择供应商",clearable:"",filterable:"",multiple:"","collapse-tags":""},{header:t(()=>[n(T,{modelValue:l(e).selectAll.supplier,"onUpdate:modelValue":a[1]||(a[1]=o=>l(e).selectAll.supplier=o),onChange:H,style:{display:"flex",height:"unset"}},{default:t(()=>[d("全选")]),_:1},8,["modelValue"])]),default:t(()=>[(s(!0),V(N,null,U(l(e).tenantSupplierList,o=>(s(),c(w,{label:o.supplierAccord,value:o.tenantSupplierId},null,8,["label","value"]))),256))]),_:1},8,["modelValue"])]),_:1})):h("",!0),l(e).form.allocationType===3&&l(e).form.allocationType!==5?(s(),c(p,{key:1,label:"部门",prop:"groupSupplierIdList"},{default:t(()=>[l(e).departmentList.length>0?(s(),c(P,{key:0,style:{"max-width":"600px"},ref_key:"treeRef",ref:y,data:l(e).departmentList,"show-checkbox":"","check-strictly":"","node-key":"id","default-expanded-keys":[],"default-checked-keys":l(v),"default-expand-all":"",props:z,onCheckChange:J},null,8,["data","default-checked-keys"])):(s(),c(G,{key:1},{default:t(()=>[d("暂无数据")]),_:1}))]),_:1})):h("",!0),l(e).form.allocationType===4&&l(e).form.allocationType!==5?(s(),c(p,{key:2,label:"合作商",prop:"groupSupplierIdList"},{default:t(()=>[n(C,{modelValue:l(e).form.groupSupplierIdList,"onUpdate:modelValue":a[4]||(a[4]=o=>l(e).form.groupSupplierIdList=o),placeholder:"请选择合作商",clearable:"",filterable:"",multiple:"","collapse-tags":""},{header:t(()=>[n(T,{modelValue:l(e).selectAll.tenant,"onUpdate:modelValue":a[3]||(a[3]=o=>l(e).selectAll.tenant=o),onChange:D,style:{display:"flex",height:"unset"}},{default:t(()=>[d("全选")]),_:1},8,["modelValue"])]),default:t(()=>[(s(!0),V(N,null,U(l(e).tenantList,o=>(s(),c(w,{label:o.beInvitationTenantName,value:o.beInvitationTenantId},null,8,["label","value"]))),256))]),_:1},8,["modelValue"])]),_:1})):h("",!0)]),_:1},8,["rules","model"])]),_:1},8,["modelValue"])])}}}),Le=ue(de,[["__scopeId","data-v-dd5e21ef"]]);export{Le as default};

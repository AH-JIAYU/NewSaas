
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{d as W,B as M,ae as X,r as b,C as Y,E as Z,o as ee,aj as ae,a2 as v,al as te,a3 as h,h as a,a as y,c as B,w as c,f as s,g as V,t as P,i as x,O as E,N as z,b as _,aG as D,ai as U,y as oe}from"./index-Ciz6FZao.js";import{a as q}from"./department-CNJDG_gC.js";const le={class:"user"},ne={class:"mr checkbox-container"},se={class:"centers mr"},ie={class:"center mr"},re={class:"center mr"},ue=W({__name:"index",props:M({parentId:{default:""},id:{default:""},tree:{},row:{},name:{}},{modelValue:{type:Boolean,default:!1},modelModifiers:{}}),emits:M(["getList"],["update:modelValue"]),setup(C,{emit:F}){const{t}=X(),S=b([]),f=C,j=[{label:t("configuration.department.new.completeProvision"),value:1},{label:t("configuration.department.new.auditAccrual"),value:2},{label:t("configuration.department.new.settlementProvision"),value:3}],A=[{label:t("configuration.department.new.atProjectPrice"),value:1},{label:t("configuration.department.new.atcostPrice"),value:2},{label:t("configuration.department.new.grossProfit"),value:3}],d=b(!1),O=F,L=Y(C,"modelValue"),R=Z(()=>f.id===""?t("configuration.department.new.addSubdepartment"):t("configuration.department.new.editSubdepartment")),p=b([]),I=b(),e=b({parentId:f.parentId,name:"",remark:"",userIdList:[],organizationalStructurePersonList:[],superior:"",commission:null,commissionTime:null,commissionStatus:2,commissionType:null}),G=b({name:[{required:!0,message:t("configuration.department.new.enterDepartmentName")}],commissionType:[{required:!0,message:t("configuration.department.new.selectAccrualMethod"),trigger:"change"}]});async function J(){try{I.value&&I.value.validate(async u=>{if(u){if(d.value=!0,e.value.organizationalStructurePersonList=[],e.value.commissionStatus===1&&!/^[1-9]\d*$/.test(e.value.commission)){U.warning({message:t("configuration.department.new.rate"),center:!0}),d.value=!1;return}p.value.forEach(n=>{if(n.userId){const m={id:n.id,userId:n.userId};e.value.organizationalStructurePersonList.push(m)}else{const m={userId:n.id};e.value.organizationalStructurePersonList.push(m)}}),e.value.commission=e.value.commission?e.value.commission:0,e.value.commissionTime=e.value.commissionTime?e.value.commissionTime:1,e.value.commissionType=e.value.commissionType?e.value.commissionType:1;const l=e.value.organizationalStructurePersonList.reduce((n,m)=>(n.some(g=>g.userId===m.userId)||n.push(m),n),[]);e.value.organizationalStructurePersonList=l;const i={...e.value};if(delete i.userIdList,delete i.superior,e.value.id){const{status:n}=await q.edit(i);n===1&&U.success({message:t("common.editSuccess"),center:!0}),d.value=!1}else{const{status:n}=await q.create(i);n===1&&U.success({message:t("common.addSuccess"),center:!0}),d.value=!1}await O("getList"),k()}})}catch{}finally{d.value=!1}}const $=u=>{var l;if(e.value.userIdList=u,p.value=S.value.filter(i=>{var n;return(n=e.value)==null?void 0:n.userIdList.includes(i.id)}),(l=e.value)!=null&&l.userIdList.length){const i=[];e.value.organizationalStructurePersonList.forEach(r=>{i.push(r)}),p.value.forEach(r=>{e.value.organizationalStructurePersonList.some(w=>w.userId===r.id)||i.push(r)});const m=Array.from(new Map(i.map(r=>[r.id,r])).values()).filter(r=>u.includes(r.id));p.value=m,e.value.organizationalStructurePersonList=p.value}else p.value=[],e.value.organizationalStructurePersonList=p.value};function k(){Object.assign(e,{parentId:"",name:"",remark:"",userIdList:[],organizationalStructurePersonList:[],superior:"",commission:null,commissionTime:null,commissionStatus:2,commissionType:null}),L.value=!1}const H=()=>S.value.filter(u=>{var l;return(l=e.value)==null?void 0:l.userIdList.includes(u.id)});return f.parentId&&(e.value.superior=f.name),ee(async()=>{try{if(d.value=!0,f.id!==""){const{id:u,name:l,remark:i,organizationalStructurePersonList:n,commission:m,commissionTime:r,commissionStatus:g,commissionType:w}=JSON.parse(f.row);e.value.id=u,e.value.name=l,e.value.remark=i,e.value.commission=m,e.value.commissionTime=r,e.value.commissionStatus=g,e.value.commissionType=w,e.value.organizationalStructurePersonList=n,n.forEach(T=>{e.value.userIdList.push(T.userId)})}else{const{data:u}=await ae.queryAllNotEnableStaffList();u&&(S.value=u)}p.value=H(),e.value.id&&(p.value=e.value.organizationalStructurePersonList),d.value=!1}catch{}finally{d.value=!1}}),(u,l)=>{const i=v("ElInput"),n=v("ElFormItem"),m=v("el-option"),r=v("el-select"),g=v("el-text"),w=v("el-switch"),T=v("ElForm"),N=v("ElButton"),K=v("ElDialog"),Q=te("loading");return h((y(),B(K,{modelValue:L.value,"onUpdate:modelValue":l[8]||(l[8]=o=>L.value=o),title:a(R),style:{width:"48rem"},"close-on-click-modal":!1,"append-to-body":"","destroy-on-close":"",onClosed:k},{footer:c(()=>[s(N,{size:"large",onClick:k},{default:c(()=>[V(P(a(t)("common.cancel")),1)]),_:1}),s(N,{type:"primary",size:"large",onClick:J},{default:c(()=>[V(P(a(t)("common.confirm")),1)]),_:1})]),default:c(()=>[s(T,{ref_key:"formRef",ref:I,model:a(e),rules:a(G),"label-width":"7rem"},{default:c(()=>[s(n,{label:a(t)("configuration.department.new.superiorDepartment"),prop:""},{default:c(()=>[s(i,{modelValue:a(e).superior,"onUpdate:modelValue":l[0]||(l[0]=o=>a(e).superior=o),disabled:!!f.parentId,placeholder:a(t)("configuration.department.new.enterDepartmentName"),clearable:""},null,8,["modelValue","disabled","placeholder"])]),_:1},8,["label"]),s(n,{label:a(t)("configuration.department.new.departmentName"),prop:"name"},{default:c(()=>[s(i,{modelValue:a(e).name,"onUpdate:modelValue":l[1]||(l[1]=o=>a(e).name=o),placeholder:a(t)("configuration.department.new.enterDepartmentName"),clearable:""},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),s(n,{label:a(t)("configuration.department.new.departmentSupervisor"),prop:""},{default:c(()=>[s(r,{modelValue:a(e).userIdList,"onUpdate:modelValue":l[2]||(l[2]=o=>a(e).userIdList=o),"value-key":"",placeholder:a(t)("configuration.department.new.selectDepartmentSupervisor"),multiple:"","collapse-tags":"","collapse-tags-tooltip":"",clearable:"",filterable:"",onChange:$},{default:c(()=>[(y(!0),x(z,null,E(a(S),o=>(y(),B(m,{key:o.value,label:o.userName,value:o.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder"])]),_:1},8,["label"]),s(n,{label:a(t)("common.remark")},{default:c(()=>[s(i,{modelValue:a(e).remark,"onUpdate:modelValue":l[3]||(l[3]=o=>a(e).remark=o),placeholder:a(t)("configuration.department.new.enterRemark"),clearable:""},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),_("div",le,[_("div",ne,[s(g,{style:{width:"4.375rem"}},{default:c(()=>[V(P(a(t)("configuration.department.new.openCommission")),1)]),_:1}),s(w,{modelValue:a(e).commissionStatus,"onUpdate:modelValue":l[4]||(l[4]=o=>a(e).commissionStatus=o),"active-value":1,"inactive-value":2,"inline-prompt":"","active-text":a(t)("common.on"),"inactive-text":a(t)("common.off")},null,8,["modelValue","active-text","inactive-text"])]),h(_("div",se,[s(r,{modelValue:a(e).commissionType,"onUpdate:modelValue":l[5]||(l[5]=o=>a(e).commissionType=o),"value-key":"",placeholder:a(t)("configuration.department.new.accrualMethod"),clearable:"",filterable:""},{default:c(()=>[(y(),x(z,null,E(A,o=>s(m,{key:o.value,label:o.label,value:o.value},null,8,["label","value"])),64))]),_:1},8,["modelValue","placeholder"])],512),[[D,a(e).commissionStatus===1]]),h(_("div",ie,[s(r,{class:"select",modelValue:a(e).commissionTime,"onUpdate:modelValue":l[6]||(l[6]=o=>a(e).commissionTime=o),"value-key":"",placeholder:a(t)("configuration.department.new.accrualTime"),clearable:"",filterable:""},{default:c(()=>[(y(),x(z,null,E(j,o=>s(m,{key:o.value,label:o.label,value:o.value},null,8,["label","value"])),64))]),_:1},8,["modelValue","placeholder"])],512),[[D,a(e).commissionStatus===1]]),h(_("div",re,[s(i,{modelValue:a(e).commission,"onUpdate:modelValue":l[7]||(l[7]=o=>a(e).commission=o),placeholder:a(t)("configuration.department.new.percentageOfCommissions"),style:{"max-width":"25rem"},clearable:""},{append:c(()=>[V("%")]),_:1},8,["modelValue","placeholder"])],512),[[D,a(e).commissionStatus===1]])])]),_:1},8,["model","rules"])]),_:1},8,["modelValue","title"])),[[Q,a(d)]])}}}),de=oe(ue,[["__scopeId","data-v-001c3b22"]]);export{de as default};

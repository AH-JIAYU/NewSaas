
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import R from"./index-QaUMHCNM.js";import{o as q,s as w}from"./apiLoading-BEADuyWx.js";import{u as U}from"./index-6m-nyZLW.js";import{u as H}from"./stagedData-kU6xXepA.js";import{u as O}from"./otherFunctions_basicDictionary-CXeOo5sL.js";import{u as F}from"./user_customer-hw7gvGc-.js";import{a as L}from"./projectManagement-4qhN1AxB.js";import{d as G,r as u,a2 as J,a3 as d,l as K,a as I,o as T,b as W,f,w as c,g as y,i as _,e as X,j as Y,Q as Z,an as p,E as m,P as $}from"./index-BXQCfZB9.js";import"./index.vue_vue_type_script_setup_true_lang-C3zFf8_c.js";import"./index-Vy0hzkRs.js";import"./zh_Hans-B39mJ-rS.js";import"./file-ARdcytrj.js";import"./basicDictionary-CNsb4Izq.js";import"./user_customer-CyNOUXXF.js";const ee=G({name:"ProjeckEdit",__name:"index",emits:["fetch-data"],setup(te,{expose:C,emit:h}){const V=U(),v=H(),A=O(),D=F(),P=h,l=u(!1),r=u(""),n=u([]),i=u([]);function k(a){n.value.push(a)}J("validateTopTabs",k);let o=d([]);const g=u();async function S(a){if(a){r.value="编辑";const e=await q(L.detail({projectId:a.projectId}));E(e.data)}else{r.value="新增";const e=p(V.initialTopTabsData);o=v.projectManagementList||d([e])}l.value=!0,i.value=[],n.value=[]}function E(a){a.data={configurationInformation:{initialProblem:{countryId:null,projectProblemCategoryId:null,projectQuotaQuestionType:null,projectProblemId:null,keyValue:"",questionType:null,answerValueList:[],projectAnswerIdList:[]},configurationCountryList:null,projectCategoryList:null,ProjectProblemInfoList:[]}},o=[];const{projectInfoList:e,...t}=p(a);o.push(t),e&&e.length&&e.forEach(s=>{s.data={configurationInformation:{initialProblem:{countryId:null,projectProblemCategoryId:null,projectQuotaQuestionType:null,projectProblemId:null,keyValue:"",questionType:null,answerValueList:[],projectAnswerIdList:[]},configurationCountryList:null,projectCategoryList:null,ProjectProblemInfoList:[]}},o.push({...s})})}function Q(){v.projectManagementList=p(o),o=d([]),l.value=!1,n.value=[]}async function b(){const a=[];n.value.forEach(t=>{a.push(t.validate())});const e=await Promise.allSettled(a);i.value=e.map(t=>t.status)}function x(a){const e=new Set;for(const t of a){if(e.has(t.name))return!0;e.add(t.name)}return!1}const M=()=>{const a=p(o);let e=a[0];return e.projectInfoList=a.slice(1),e.data&&delete e.data,e.projectQuotaInfoList=e.projectQuotaInfoList.map(t=>(Array.isArray(t.answerValueList)||(t.answerValueList=[]),Array.isArray(t.projectAnswerIdList)||(t.projectAnswerIdList=[]),t)),e.projectInfoList.forEach(t=>{t.data&&delete t.data,t.projectQuotaInfoList=t.projectQuotaInfoList.map(s=>(Array.isArray(s.answerValueList)||(s.answerValueList=[]),Array.isArray(s.projectAnswerIdList)||(s.projectAnswerIdList=[]),s))}),e};async function B(){if(await b(),i.value.every(a=>a==="fulfilled"))if(x(o))m({message:"项目名称重复",center:!0});else{const a=M();if(r.value==="新增"){const{status:e}=await w(L.create(a));e===1&&m.success({message:"新增成功",center:!0})}else{const{status:e}=await w(L.edit(a));e===1&&m.success({message:"编辑成功",center:!0})}P("fetch-data"),j()}else g.value.activeLeftTab=i.value.indexOf("rejected"),m.warning({message:"请完善表单",center:!0})}function j(){o=d([]),i.value=[],n.value=[],l.value=!1,r.value==="新增"&&(v.projectManagementList=null)}const z=async()=>{await D.getCustomerList(),await A.getCountry()};return K(async()=>{await z()}),C({showEdit:S}),(a,e)=>{const t=I("el-button"),s=I("el-drawer");return T(),W("div",null,[f(s,{modelValue:l.value,"onUpdate:modelValue":e[0]||(e[0]=N=>l.value=N),class:Z(r.value==="新增"?"hide-drawer-header":"edit-drawer"),"append-to-body":"","close-on-click-modal":!1,"destroy-on-close":"",draggable:"",size:"70%"},{footer:c(()=>[f(t,{onClick:j},{default:c(()=>[y(" 取消 ")]),_:1}),f(t,{type:"warning",onClick:Q},{default:c(()=>[y(" 暂存 ")]),_:1}),f(t,{type:"primary",onClick:B},{default:c(()=>[y(" 确定 ")]),_:1})]),default:c(()=>[_(o).length?(T(),X(R,{key:0,onValidate:b,ref_key:"LeftTabsRef",ref:g,"left-tabs-data":_(o),"validate-top-tabs":n.value,"validate-all":i.value,title:r.value},null,8,["left-tabs-data","validate-top-tabs","validate-all","title"])):Y("",!0)]),_:1},8,["modelValue","class"])])}}}),Le=$(ee,[["__scopeId","data-v-d592a1c7"]]);export{Le as default};

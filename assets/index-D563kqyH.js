
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{a as F}from"./configuration_role-DtaW0Y9f.js";import{k as z,ag as H,r as v,d as J,bv as O,n as D,ap as Q,E as S,a as h,q as W,s as X,i as t,o as g,b as w,f as k,w as m,e as x,g as P,y as E,z as U,F as Y,t as Z,j as V,L as j}from"./index-i6ANmCxK.js";const ee={list:()=>z.get("role/getRoleButton")},le=H("buttonPermission",()=>{const _=v([]);return{permissions:_,getPermissions:async()=>{if(_.value.length)return _.value;const{data:y}=await ee.list();return _.value=y,y}}}),oe=le,te={class:"custom-tree-node"},se={class:"menu"},ae={class:"permission"},ne={key:0,class:"permissions"},re=J({__name:"index",props:["id","row"],setup(_,{expose:N}){const y=_,R=O(),K=oe(),r=v(!1),A=v(),f=v(),C=v([]),s=v([]),e=v({id:y.id??null,menuId:[],permission:[],roleName:"",remark:"",checkAll:!1}),q=v({roleName:[{required:!0,message:"请输入角色名称",trigger:"blur"}]});D(async()=>{try{r.value=!0,s.value=await K.getPermissions(),C.value=R.routesRaw,e.value.id!==""?await M():(e.value.menuId=[],e.value.permission=[],e.value.checkAll=!1),r.value=!1}catch{}finally{r.value=!1}});const G=()=>{e.value.checkAll?(e.value.menuId=[],e.value.permission=[],C.value.length&&C.value.forEach(o=>{e.value.menuId.push(o.id)}),s.value.length&&s.value.forEach(o=>{e.value.permission.push(o.id)}),f.value.setCheckedNodes([...e.value.permission,...e.value.menuId])):(e.value.checkAll=!1,e.value.menuId=[],e.value.permission=[],f.value.setCheckedNodes([]))};async function M(){r.value=!0;const{menuId:o,...l}=JSON.parse(y.row);e.value=l;const u=await R.obtainLevel1AndLevel2Routing();e.value.menuId=o.filter(a=>!u.some(n=>n.id===a)),s.value.length==e.value.permission.length&&(e.value.checkAll=!0),r.value=!1}function L(o){var l;return(l=s==null?void 0:s.value)==null?void 0:l.filter(u=>o===u.menuId)}const T=o=>{const l=[];l.push(o),f.value.getNode(o.id).checked?l.map(a=>{var d;const n=(d=s==null?void 0:s.value)==null?void 0:d.filter(i=>a.id===i.menuId);n&&n.length&&n.forEach(i=>{e.value.permission.push(i.id)})}):l.map(a=>{var d;const n=(d=s==null?void 0:s.value)==null?void 0:d.filter(i=>a.id===i.menuId);if(n&&n.length){let i=n.map(p=>p.id);e.value.permission=e.value.permission.filter(p=>!i.some(b=>b===p))}})};return N({submit(){r.value=!0;const o=Q(e.value);return new Promise((l,u)=>{try{o.menuId=f.value.getCheckedKeys(!1);const a=f.value.getCheckedKeys(),n=f.value.getHalfCheckedKeys(),d=a.concat(n);o.menuId=d,e.value.menuId=d,A.value.validate(async i=>{if(!i)return r.value=!1,u(new Error("验证不通过"));try{o.id===""?(await F.create(o),S.success({message:"新增成功",center:!0})):(await F.edit(o),S.success({message:"编辑成功",center:!0})),l()}catch(p){u(p)}finally{r.value=!1}})}catch(a){r.value=!1,u(a)}})}}),(o,l)=>{const u=h("ElInput"),a=h("ElFormItem"),n=h("el-checkbox"),d=h("ElCheckbox"),i=h("ElCheckboxGroup"),p=h("el-tree"),b=h("ElForm"),$=W("loading");return X((g(),w("div",null,[k(b,{ref_key:"formRef",ref:A,model:t(e),rules:t(q),"label-width":"120px"},{default:m(()=>[k(a,{label:"角色名称",prop:"roleName"},{default:m(()=>[k(u,{modelValue:t(e).roleName,"onUpdate:modelValue":l[0]||(l[0]=c=>t(e).roleName=c),placeholder:"请输入角色名称"},null,8,["modelValue"])]),_:1}),k(a,{label:"备注",prop:"remark"},{default:m(()=>[k(u,{modelValue:t(e).remark,"onUpdate:modelValue":l[1]||(l[1]=c=>t(e).remark=c),placeholder:"请输入备注"},null,8,["modelValue"])]),_:1}),t(r)?V("",!0):(g(),x(a,{key:0,label:"权限"},{default:m(()=>[k(n,{modelValue:t(e).checkAll,"onUpdate:modelValue":l[2]||(l[2]=c=>t(e).checkAll=c),onChange:G},{default:m(()=>[P("全选/取消全选")]),_:1},8,["modelValue"]),t(e).menuId?(g(),x(p,{key:0,ref_key:"treeRef",ref:f,data:t(C),style:{width:"100%"},"default-checked-keys":t(e).menuId,"default-expanded-keys":[],"node-key":"id","show-checkbox":"",onCheckChange:T,"default-expand-all":"",border:""},{default:m(({data:c})=>{var B;return[E("div",te,[E("div",se,U(c.meta.title),1),E("div",ae,[(B=L(c.id))!=null&&B.length?(g(),w("div",ne,[k(i,{modelValue:t(e).permission,"onUpdate:modelValue":l[3]||(l[3]=I=>t(e).permission=I)},{default:m(()=>[(g(!0),w(Y,null,Z(L(c.id),I=>(g(),x(d,{key:I.id,value:I.id},{default:m(()=>[P(U(I.label),1)]),_:2},1032,["value"]))),128))]),_:2},1032,["modelValue"])])):V("",!0)])])]}),_:1},8,["data","default-checked-keys"])):V("",!0)]),_:1}))]),_:1},8,["model","rules"])])),[[$,t(r)]])}}}),de=j(re,[["__scopeId","data-v-add58673"]]);export{de as default};

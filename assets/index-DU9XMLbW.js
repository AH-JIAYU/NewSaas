
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{_ as Z,a as ee}from"./jiantou-BFtAGxsy.js";import{o as le,s as te}from"./apiLoading-TYyty7gZ.js";import{a as K}from"./projectManagement-OQPtdICB.js";import{a as oe}from"./survey_vip_department-BHp7gfif.js";import{u as ae}from"./survey_vipGroup-DBQ17xfA.js";import{d as se,r as i,n as re,a as f,q as ie,o as h,b as w,f as u,w as r,y as k,g as m,s as ne,e as V,z as P,i as a,j as L,A as ue,E as R,aH as ce,aI as pe,L as de}from"./index-C6kbZRUu.js";import"./survey_vipGroup-D_C0ceq7.js";const O=b=>(ce("data-v-18359a92"),b=b(),pe(),b),fe=O(()=>k("span",{class:"icon-class"},[k("img",{src:Z,alt:"",style:{"margin-right":"0.25rem"}}),m(" 部门")],-1)),me=O(()=>k("img",{src:ee,alt:"",style:{"margin-left":"0.25rem"}},null,-1)),ve={key:1},ge={style:{flex:"auto"}},he=se({name:"AllocationEdit",__name:"index",emits:["fetch-data"],setup(b,{expose:B,emit:H}){ae();const v=i([]),g=i(),S=i([]),M={children:"children",label:"name"},U=H,_=i(!1),j=i(),l=i({list:[],title:null,vipGroupList:[],form:{projectId:"",allocationType:3,groupSupplierIdList:[]},selectAll:{member:!1}}),A=i([]),q=i({groupSupplierIdList:[{type:"array",required:!0,trigger:"change",message:"请选择至少一项"}]});async function z(t,e){l.value.list=[{...t}],l.value.form.projectId=t.projectId,o.value.projectId=t.projectId;const s=await le(K.getProjectAllocation({projectId:t.projectId})),{getProjectAllocationInfoList:c}=s.data;c==null||c.forEach(d=>{d.allocationType===3&&(o.value={allocationType:d.allocationType,projectId:d.projectId,groupSupplierIdList:d.groupSupplierIdSet})});const p=JSON.parse(JSON.stringify(v.value));A.value=T(p),A.value.length==o.value.groupSupplierIdList.length?l.value.selectAll.member=!0:l.value.selectAll.member=!1,e==="reassign"?l.value.title="重新分配":l.value.title="分配",_.value=!0}const T=t=>t.reduce((e,s)=>{const{children:c,...p}=s;return e.push(p),s.children&&s.children.length>0&&(e=e.concat(T(s.children))),e},[]);function C(){j.value.resetFields(),Object.assign(l.value.form,{projectId:"",groupSupplierIdList:[]}),_.value=!1,Object.assign(o.value,{projectId:null,allocationType:3,groupSupplierIdList:[],deleteSet:[]}),I.value=!1,y.value=!1,l.value.selectAll.member=!1}const o=i({projectId:null,allocationType:3,groupSupplierIdList:[],deleteSet:[]}),D=()=>{o.value.groupSupplierIdList=[],v.value.forEach(t=>{E(t)}),g.value.setCheckedKeys(o.value.groupSupplierIdList)};function E(t){o.value.groupSupplierIdList.push(t.id),t.children&&t.children.length&&t.children.forEach(e=>{E(e)})}function G(){o.value.groupSupplierIdList=[],l.value.selectAll.member?(D(),g.value.setCheckedKeys(o.value.groupSupplierIdList)):(l.value.selectAll.member=!1,o.value.groupSupplierIdList=[],g.value.setCheckedKeys([]))}const J=(t,e)=>{e?S.value.includes(t.id)||S.value.push(t.id):S.value=S.value.filter(d=>d!==t.id);const s=g.value.getCheckedKeys(),c=g.value.getHalfCheckedKeys(),p=[...s,...c];o.value.groupSupplierIdList=p,A.value.length==p.length?l.value.selectAll.member=!0:l.value.selectAll.member=!1};function $(){j.value.validate(async t=>{if(t){let e={addProjectAllocationInfoList:[]};if(o.value.groupSupplierIdList.length&&(o.value.projectId=l.value.form.projectId,e.addProjectAllocationInfoList.push(o.value)),l.value.form.groupSupplierIdList=o.value.groupSupplierIdList,l.value.title!=="分配")e.addProjectAllocationInfoList.length||(I.value=!0);else if(!e.addProjectAllocationInfoList.length){R.warning({message:"至少选择一个分配目标",center:!0});return}I.value&&(e={addProjectAllocationInfoList:[{projectId:l.value.form.projectId,allocationType:5,groupSupplierIdList:[],deleteSet:[]}]});const{status:s}=await te(K.allocation(e));s===1&&R.success({message:"分配成功",center:!0}),C(),U("fetch-data")}})}re(async()=>{const t=await oe.list({name:""});t.data&&(v.value=t.data)});const I=i(!1),y=i(!1),F=()=>{y.value=!y.value,y.value?I.value=!0:I.value=!1},Q=t=>{};return B({showEdit:z}),(t,e)=>{const s=f("el-table-column"),c=f("el-table"),p=f("el-checkbox"),d=f("el-tree-select"),N=f("el-form-item"),x=f("el-button"),W=f("el-form"),X=f("el-dialog"),Y=ie("loading");return h(),w("div",null,[u(X,{modelValue:a(_),"onUpdate:modelValue":e[4]||(e[4]=n=>ue(_)?_.value=n:null),title:a(l).title,width:"700","before-close":C},{footer:r(()=>[k("div",ge,[u(x,{onClick:C},{default:r(()=>[m(" 取消 ")]),_:1}),u(x,{type:"primary",onClick:$},{default:r(()=>[m(" 确定 ")]),_:1})])]),default:r(()=>[ne((h(),V(c,{data:a(l).list,"row-key":"id"},{default:r(()=>[u(s,{align:"left","show-overflow-tooltip":"",label:"项目编码",prop:"projectId"}),u(s,{align:"left","show-overflow-tooltip":"",label:"项目名称",prop:"projectName"}),u(s,{align:"left","show-overflow-tooltip":"",label:"配额/限量",prop:"name"},{default:r(({row:n})=>[m(P(n.limitedQuantity||0)+"/ "+P(n.num||0),1)]),_:1})]),_:1},8,["data"])),[[Y,!1]]),a(l).form.allocationType===3&&a(l).form.allocationType!==5?(h(),V(W,{key:0,ref_key:"formRef",ref:j,"label-width":"90px",rules:a(q),model:a(l).form,inline:!1,"label-position":"left",style:{"margin-top":"1.25rem"}},{default:r(()=>[u(N,null,{label:r(()=>[fe]),default:r(()=>[u(d,{ref_key:"treeRef",ref:g,modelValue:a(o).groupSupplierIdList,"onUpdate:modelValue":e[2]||(e[2]=n=>a(o).groupSupplierIdList=n),data:a(v),"show-checkbox":"","default-expand-all":"","node-key":"id",props:M,onCheckChange:J,"check-strictly":!0,"check-on-click-node":!0,multiple:!0,"expand-on-click-node":!1,style:{width:"37.625rem"},clearable:"",placeholder:""},{header:r(()=>[u(p,{modelValue:a(l).selectAll.member,"onUpdate:modelValue":e[0]||(e[0]=n=>a(l).selectAll.member=n),onChange:G,style:{display:"flex",height:"unset"}},{default:r(()=>[m("全选")]),_:1},8,["modelValue"])]),prefix:r(()=>[a(v).length==0?(h(),w("span",{key:0,class:"prefix-class",onClick:e[1]||(e[1]=n=>Q("部门"))},[m(" 请先维护部门数据 "),me])):L("",!0),!a(o).groupSupplierIdList.length&&a(v).length!=0?(h(),w("span",ve,"请先选择部门数据")):L("",!0)]),_:1},8,["modelValue","data"])]),_:1}),a(l).title=="重新分配"?(h(),V(N,{key:0},{label:r(()=>[u(x,{type:a(y)?"primary":"",onClick:e[3]||(e[3]=n=>F()),style:{"border-radius":"1.875rem"}},{default:r(()=>[m(" 取消分配 ")]),_:1},8,["type"])]),_:1})):L("",!0)]),_:1},8,["rules","model"])):L("",!0)]),_:1},8,["modelValue","title"])])}}}),je=de(he,[["__scopeId","data-v-18359a92"]]);export{je as default};


/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{k as A,d as D,r as p,n as N,E as u,a as d,q as U,s as z,i as n,o as c,b,f as a,w as m,g as B,F as v,t as M,e as C,y as P,z as y,L as q}from"./index-Dz_36XCL.js";const V={list:s=>A.post("bill/getMemberBillList",s),create:s=>A.post("bill/addMemberSettlement",s),getMemberBillAvailableBalance:s=>A.post("bill/getMemberBillAvailableBalance",s),changestatus:s=>A.post("bill/updateMemberBill",s)},R=D({__name:"index",props:{id:{default:""}},setup(s,{expose:w}){const f=p(!1),S=p(),e=p({minimumAmount:"",settlementType:2,settlementAmount:"",addMemberSettlementInfoList:[],memberSettlementInfoSelect:[]}),I=p({memberSettlementInfoList:[],memberSettlementInfoSelect:[]}),L=p({settlementAmount:[{required:!0,message:"请输入正数，且最多两位小数",trigger:"blur"},{pattern:/^(?!0(\.0+)?$)(\d+(\.\d{1,2})?)$/,message:"请输入有效的正数，且最多两位小数",trigger:"blur"}],memberSettlementInfoSelect:[{required:!0,message:"请选择会员",trigger:"change"}]}),h=async()=>{try{f.value=!0;const r=await V.getMemberBillAvailableBalance({});r.data&&(I.value.memberSettlementInfoList=r.data.memberBillAvailableBalanceInfoList,e.value.minimumAmount=r.data.minimumAmount),f.value=!1}catch{}finally{f.value=!1}},x=r=>{e.value.addMemberSettlementInfoList=[];const o=I.value.memberSettlementInfoList.filter(t=>r.includes(t.id));for(let t=0;t<o.length;t++)e.value.addMemberSettlementInfoList.push(o[t])};return N(async()=>{await h()}),w({submit(){return new Promise(r=>{S.value&&S.value.validate(async o=>{if(e.value.settlementType===2){for(let t of e.value.addMemberSettlementInfoList){t.settlementAmount||(t.settlementAmount=null);const g=/^(?!0(\.0+)?$)(\d+(\.\d{1,2})?)$/;if(t.settlementAmount){if(!g.test(t.settlementAmount)){u.warning({message:"请输入有效的正数，且最多两位小数",center:!0});return}if(!g.test(t.settlementAmount)){u.warning({message:"请输入有效的正数，且最多两位小数",center:!0});return}if(t.settlementAmount<e.value.minimumAmount){u.warning({message:"结算金额 必须大于等于 最低结算金额",center:!0});return}if(t.settlementAmount>t.availableBalance){u.warning({message:"可用余额小于结算金额，不支持结算",center:!0});return}}else{if(t.availableBalance==0){u.warning({message:"可用余额为0，不支持结算",center:!0});return}if(t.availableBalance<e.value.minimumAmount){u.warning({message:"可用余额 必须大于等于 最低结算金额",center:!0});return}}}e.value.settlementAmount=""}else{const t=/^(?!0(\.0+)?$)(\d+(\.\d{1,2})?)$/;if(e.value.addMemberSettlementInfoList=[],e.value.settlementAmount||(e.value.settlementAmount=null),delete e.value.memberSettlementInfoSelect,e.value.settlementAmount&&!t.test(e.value.settlementAmount)){u.warning({message:"请输入有效的正数，且最多两位小数",center:!0});return}}if(o)try{f.value=!0;const{status:t}=await V.create(e.value);t===1&&(u.success({message:"结算账单已生成",center:!0}),r())}catch{}finally{f.value=!1}})})}}),(r,o)=>{const t=d("el-radio"),g=d("el-radio-group"),i=d("ElFormItem"),_=d("ElInput"),E=d("el-option"),k=d("el-select"),F=d("ElForm"),T=U("loading");return z((c(),b("div",null,[a(F,{ref_key:"formRef",ref:S,model:n(e),rules:n(L),"label-width":"9rem"},{default:m(()=>[a(i,{label:"结算方式"},{default:m(()=>[a(g,{modelValue:n(e).settlementType,"onUpdate:modelValue":o[0]||(o[0]=l=>n(e).settlementType=l)},{default:m(()=>[a(t,{value:2,size:"large"},{default:m(()=>[B(" 指定结算 ")]),_:1}),a(t,{value:1,size:"large"},{default:m(()=>[B(" 全部结算 ")]),_:1})]),_:1},8,["modelValue"])]),_:1}),n(e).settlementType===1?(c(),b(v,{key:0},[a(i,{label:"最低结算额度"},{default:m(()=>[a(_,{disabled:"",placeholder:"",value:n(e).minimumAmount},null,8,["value"])]),_:1}),a(i,{label:"结算金额",prop:""},{default:m(()=>[a(_,{modelValue:n(e).settlementAmount,"onUpdate:modelValue":o[1]||(o[1]=l=>n(e).settlementAmount=l),placeholder:""},null,8,["modelValue"])]),_:1})],64)):(c(),b(v,{key:1},[a(i,{label:"指定会员",prop:"memberSettlementInfoSelect"},{default:m(()=>[a(k,{placeholder:"Select",modelValue:n(e).memberSettlementInfoSelect,"onUpdate:modelValue":o[2]||(o[2]=l=>n(e).memberSettlementInfoSelect=l),clearable:"",filterable:"",multiple:"","collapse-tags":"",onChange:x},{default:m(()=>[(c(!0),b(v,null,M(n(I).memberSettlementInfoList,l=>(c(),C(E,{key:l.id,value:l.id,label:l.memberName},null,8,["value","label"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(i,{label:"最低结算额度"},{default:m(()=>[a(_,{disabled:"",placeholder:"",value:n(e).minimumAmount},null,8,["value"])]),_:1}),(c(!0),b(v,null,M(n(e).addMemberSettlementInfoList,l=>(c(),b(v,null,[a(i,{label:""},{default:m(()=>[P("p",null,y(l.memberId)+" - "+y(l.memberName)+" - 可用余额："+y(l.availableBalance),1)]),_:2},1024),a(i,{label:"结算金额"},{default:m(()=>[a(_,{modelValue:l.settlementAmount,"onUpdate:modelValue":$=>l.settlementAmount=$,max:l.availableBalance,placeholder:""},null,8,["modelValue","onUpdate:modelValue","max"])]),_:2},1024)],64))),256))],64))]),_:1},8,["model","rules"])])),[[T,n(f)]])}}}),j=q(R,[["__scopeId","data-v-729b1ae3"]]),G=Object.freeze(Object.defineProperty({__proto__:null,default:j},Symbol.toStringTag,{value:"Module"}));export{j as D,V as a,G as i};

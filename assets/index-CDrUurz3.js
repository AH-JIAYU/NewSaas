
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{d as K,aj as W,aB as X,l as Y,r as s,Z as x,$ as j,n as ee,a as k,q as te,o as C,b as ae,f as p,w as d,v as oe,s as T,aH as E,g as b,A as w,i as f,e as re,j as ie,ap as g,E as n,_ as se,M as ne}from"./index-BEosAuiF.js";import le from"./index-D0qfV7Up.js";import{u as ce}from"./projectManagement_list-ClTZop_C.js";import{u as ue}from"./stagedData-DGBtxE04.js";import{u as pe}from"./user_customer-DhlTkx3u.js";import{a as I}from"./projectManagement-Rcxb7prf.js";import"./index-pWeQfcXG.js";import"./download-CBu3Lq9Z.js";import"./zh_Hans-BiAfgf-k.js";import"./index-Bmb2yTfB.js";/* empty css              */import"./index-BQR4Knl8.js";import"./index.vue_vue_type_script_setup_true_lang-BBiiN0Qo.js";import"./index-Ce_jnD0j.js";import"./index-CmG7O5Qt.js";import"./index-D1e3hJMR.js";import"./clipboard-BQDNkKGb.js";import"./index-DCHgYRwu.js";import"./department-Dcsm7tgZ.js";import"./position_manage-_zFFxBRV.js";import"./configuration_role-miWEX7qk.js";import"./tenant_role-BgZNEIlT.js";import"./configuration_manager-BIt1fygM.js";import"./configuration_siteSetting-TRhKnNoi.js";import"./configuration_site_setting-TgboqlNm.js";import"./apiLoading-Yhjvm445.js";import"./index.vue_vue_type_script_setup_true_lang-SUYSmOlA.js";import"./otherFunctions_screenLibrary-CjEjG95P.js";import"./pdf-BhHCHn5I.js";import"./index.vue_vue_type_script_setup_true_lang-CxKCMPPb.js";const de={class:"flex-c"},me=K({name:"ProjeckEdit",__name:"index",emits:["fetch-data"],setup(fe,{expose:V,emit:U}){const{t:v}=W();X();const y=ce(),P=ue(),M=Y(),A=pe(),R=U,m=s(!1),l=s(""),i=s(!1),c=s([]),L=s(""),u=s([]);function Q(e){c.value.push(e)}function B(e){L.value=e}x("validateTopTabs",Q),x("currentProjectTimeline",B);let r=j([]);const _=s();async function N(e){try{if(i.value=!0,e)if(l.value="编辑",e.projectType===2)D(e);else{const a=await I.detail({projectId:e.projectId});a.data&&D(a.data)}else{l.value="新增";const a=g(y.initialTopTabsData);r=P.projectManagementList||j([a])}m.value=!0,u.value=[],c.value=[],i.value=!1}catch{}finally{i.value=!1}}function D(e){e.data={configurationInformation:{initialProblem:{countryId:null,projectProblemCategoryId:null,projectQuotaQuestionType:null,projectProblemId:null,keyValue:"",questionType:null,answerValueList:[],projectAnswerIdList:[]},configurationCountryList:null,projectCategoryList:null,ProjectProblemInfoList:[]}},r=[];const{projectInfoList:a,...t}=g(e);t.browser&&(t.browser=t.browser.split(",")),t.operatingSystem&&(t.operatingSystem=t.operatingSystem.split(",")),t.descriptionUrl?t.descriptionUrl=t.descriptionUrl.split(","):t.descriptionUrl=[],r.push(t),a&&a.length&&a.forEach(o=>{o.data={configurationInformation:{initialProblem:{countryId:null,projectProblemCategoryId:null,projectQuotaQuestionType:null,projectProblemId:null,keyValue:"",questionType:null,answerValueList:[],projectAnswerIdList:[]},configurationCountryList:null,projectCategoryList:null,ProjectProblemInfoList:[]}},o.descriptionUrl=o.descriptionUrl.split(","),r.push({...o})}),y.dataBeforeEditing=g(r)}function O(){P.projectManagementList=g(r),r=j([]),m.value=!1,c.value=[]}async function h(){const e=[];c.value.forEach(t=>{e.push(t.validate())});const a=await Promise.allSettled(e);u.value=a.map(t=>t.status)}function q(e){const a=new Set;for(const t of e){if(a.has(t.name))return!0;a.add(t.name)}return!1}const F=async()=>{const e=g(r);await y.compareProjectData(y.dataBeforeEditing,e),await e.forEach(t=>{t.descriptionUrl=t.descriptionUrl.join(","),(!t.data.configurationInformation.ProjectProblemInfoList||!t.data.configurationInformation.ProjectProblemInfoList.length)&&(t.isProfile=2),t.data&&delete t.data,t.isProfile==2?t.projectQuotaInfoList=[]:t.projectQuotaInfoList=t.projectQuotaInfoList.map(o=>(Array.isArray(o.answerValueList)||(o.answerValueList=[]),Array.isArray(o.projectAnswerIdList)||(o.projectAnswerIdList=[]),o))});let a=e[0];return a.projectInfoList=e.slice(1).map(t=>(t.browser=t.browser.join(","),t.operatingSystem=t.operatingSystem.join(","),{...t,memberPrice:(t.doMoneyPrice*t.exchangeRate).toFixed(2)})),a},z=e=>({projectOutsideInfoId:e.projectOutsideInfoId??null,projectId:e.projectId,doMoneyPrice:e.doMoneyPrice,currencyType:e.currencyType,exchangeRate:e.exchangeRate,memberPrice:e.memberPrice,num:e.num,minimumDuration:e.minimumDuration,ir:e.ir,mutualExclusionId:e.mutualExclusionId,remark:e.remark,descriptionUrl:e.descriptionUrl,richText:e.richText,ipDifferenceDetection:e.ipDifferenceDetection,limitedQuantity:e.limitedQuantity,preNum:e.preNum});async function H(){if(i.value=!0,await h(),u.value.every(e=>e==="fulfilled"))if(q(r))n({message:"项目名称重复",center:!0});else{const e=await F();e.browser=e.browser.join(","),e.operatingSystem=e.operatingSystem.join(","),setTimeout(async()=>{if(!e.endAge||!e.startAge){n.warning({message:"年龄区间未填写完整",center:!0});return}if(l.value==="新增"){if(e.memberPrice=(e.doMoneyPrice*e.exchangeRate).toFixed(2),e.minimumDuration=+e.minimumDuration,!e.exchangeRate){n.warning({message:"请设置汇率",center:!0});return}const{status:a}=await I.create(e);a===1&&n.success({message:"新增成功",center:!0})}else if(e.projectType===2){e.memberPrice=(e.doMoneyPrice*e.exchangeRate).toFixed(2);const a=z(e),{status:t}=await I.addOrUpdateProjectOutsideInfo(a);t===1&&n.success({message:"编辑成功",center:!0})}else{const{status:a}=await I.edit(e);a===1&&n.success({message:"编辑成功",center:!0})}R("fetch-data"),S()},1e3)}else _.value.activeLeftTab=u.value.indexOf("rejected"),n.warning({message:v("projectEdit.perfect"),center:!0});i.value=!1}function S(){r=j([]),u.value=[],c.value=[],m.value=!1,l.value==="新增"&&(P.projectManagementList=null)}const $=async()=>{await A.getCustomerList(),await M.getCountry()};return ee(async()=>{await $()}),V({showEdit:N}),(e,a)=>{const t=se,o=k("el-button"),Z=k("el-drawer"),G=te("loading");return C(),ae("div",null,[p(Z,{modelValue:m.value,"onUpdate:modelValue":a[0]||(a[0]=J=>m.value=J),class:"hide-drawer-header","append-to-body":"","close-on-click-modal":!1,"destroy-on-close":"",draggable:"",size:"70%"},{footer:d(()=>[oe("div",de,[T(p(o,{link:""},{default:d(()=>[p(t,{name:"ant-design:clock-circle-outlined"}),b("   "+w(L.value),1)]),_:1},512),[[E,L.value]]),p(o,{type:"primary",onClick:H,disabled:i.value},{default:d(()=>[b(w(f(v)("projectEdit.releaseProject")),1)]),_:1},8,["disabled"]),T(p(o,{type:"warning",onClick:O,disabled:i.value},{default:d(()=>[b(w(f(v)("projectEdit.temporaryStorage")),1)]),_:1},8,["disabled"]),[[E,l.value!=="编辑"]]),p(o,{onClick:S,disabled:i.value},{default:d(()=>[b(w(f(v)("projectEdit.cancel")),1)]),_:1},8,["disabled"])])]),default:d(()=>[f(r).length?T((C(),re(le,{key:0,onValidate:h,ref_key:"LeftTabsRef",ref:_,"left-tabs-data":f(r),"validate-top-tabs":c.value,"validate-all":u.value,title:l.value},null,8,["left-tabs-data","validate-top-tabs","validate-all","title"])),[[G,i.value]]):ie("",!0)]),_:1},8,["modelValue"])])}}}),He=ne(me,[["__scopeId","data-v-a040109f"]]);export{He as default};

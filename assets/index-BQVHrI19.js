
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{d as Y,m as D,r as I,u as Z,c as ee,n as le,p as ae,a as p,q as se,s as h,i as c,o as _,e as q,w as d,f as r,g,b as y,t as S,F as x,y as L,z as oe,ao as U,E as P,L as te}from"./index-CXFVBcla.js";import{a as B}from"./department-tQqyR6gG.js";const ne={class:"mr"},ue={class:"mr checkbox-container"},re={class:"centers mr"},ie={class:"center mr"},de={class:"center mr"},ce=Y({__name:"index",props:D({parentId:{default:""},id:{default:""},tree:{},row:{},name:{}},{modelValue:{type:Boolean,default:!1},modelModifiers:{}}),emits:D(["getList"],["update:modelValue"]),setup(T,{emit:F}){const V=I([]),f=T,M=[{label:"完成计提",value:1},{label:"审核计提",value:2},{label:"结算计提",value:3}],N=[{label:"按项目价",value:1},{label:"按成本价",value:2},{label:"按毛利润",value:3}],v=I(!1),O=F,k=Z(T,"modelValue"),j=ee(()=>f.id===""?"新增子部门":"编辑子部门"),m=I([]),z=I(),e=I({parentId:f.parentId,name:"",remark:"",userIdList:[],organizationalStructurePersonList:[],superior:""}),R=I({name:[{required:!0,message:"请输入部门名称"}],commissionType:[{required:!0,message:"请选择计提方式",trigger:"change"}]});function A(t){for(const o of t){const u=o.commission,l=o.commissionStatus;if(l!==2&&l===1&&!/^[1-9]\d*$/.test(u))return!1}return!0}async function $(){try{z.value&&z.value.validate(async t=>{if(t){if(v.value=!0,e.value.organizationalStructurePersonList=[],!A(m.value)){P.warning({message:"提成比例必须是正整数",center:!0}),v.value=!1;return}m.value.forEach(a=>{if(a.userId){const n={id:a.id,userId:a.userId,commission:a.commission||0,commissionTime:a.commissionTime||1,commissionStatus:a.commissionStatus,commissionType:a.commissionType||1};e.value.organizationalStructurePersonList.push(n)}else{const n={userId:a.id,commission:a.commission||0,commissionTime:a.commissionTime||1,commissionStatus:a.commissionStatus,commissionType:a.commissionType||1};e.value.organizationalStructurePersonList.push(n)}});const u=e.value.organizationalStructurePersonList.reduce((a,n)=>(a.some(b=>b.userId===n.userId)||a.push(n),a),[]);e.value.organizationalStructurePersonList=u;const l={...e.value};if(delete l.userIdList,delete l.superior,e.value.id){const{status:a}=await B.edit(l);a===1&&P.success({message:"编辑成功",center:!0}),v.value=!1}else{const{status:a}=await B.create(l);a===1&&P.success({message:"新增成功",center:!0}),v.value=!1}await O("getList"),w()}})}catch{}finally{v.value=!1}}const J=t=>{if(t.userId){const l=e.value.userIdList.indexOf(t.userId);l!==-1&&e.value.userIdList.splice(l,1)}else{const l=e.value.userIdList.indexOf(t.id);l!==-1&&e.value.userIdList.splice(l,1)}const o=e.value.organizationalStructurePersonList.findIndex(l=>l.id===t.id||l.userId===t.id);o!==-1&&e.value.organizationalStructurePersonList.splice(o,1);const u=m.value.findIndex(l=>l.id===t.id||l.userId===t.id);u!==-1&&m.value.splice(u,1)},G=t=>{var o;if(e.value.userIdList=t,m.value=V.value.filter(u=>{var l;return(l=e.value)==null?void 0:l.userIdList.includes(u.id)}),(o=e.value)!=null&&o.userIdList.length){const u=[];e.value.organizationalStructurePersonList.forEach(n=>{u.push(n)}),m.value.forEach(n=>{e.value.organizationalStructurePersonList.some(b=>b.userId===n.id)||u.push(n)});const a=Array.from(new Map(u.map(n=>[n.id,n])).values()).filter(n=>t.includes(n.id));m.value=a,e.value.organizationalStructurePersonList=m.value}else m.value=[],e.value.organizationalStructurePersonList=m.value};function w(){Object.assign(e,{parentId:"",name:"",remark:"",userIdList:[],organizationalStructurePersonList:[],superior:""}),k.value=!1}const H=()=>V.value.filter(t=>{var o;return(o=e.value)==null?void 0:o.userIdList.includes(t.id)});return f.parentId&&(e.value.superior=f.name),le(async()=>{try{if(v.value=!0,f.id!==""){const{id:t,name:o,remark:u,organizationalStructurePersonList:l}=JSON.parse(f.row);e.value.id=t,e.value.name=o,e.value.remark=u,e.value.organizationalStructurePersonList=l,l.forEach(a=>{e.value.userIdList.push(a.userId)})}else{const{data:t}=await ae.queryAllNotEnableStaffList();t&&(V.value=t)}m.value=H(),e.value.id&&(m.value=e.value.organizationalStructurePersonList),v.value=!1}catch{}finally{v.value=!1}}),(t,o)=>{const u=p("ElInput"),l=p("ElFormItem"),a=p("el-option"),n=p("el-select"),E=p("el-tag"),b=p("el-text"),K=p("el-switch"),Q=p("ElForm"),C=p("ElButton"),W=p("ElDialog"),X=se("loading");return h((_(),q(W,{modelValue:k.value,"onUpdate:modelValue":o[4]||(o[4]=s=>k.value=s),title:c(j),style:{width:"48rem"},"close-on-click-modal":!1,"append-to-body":"","destroy-on-close":"",onClosed:w},{footer:d(()=>[r(C,{size:"large",onClick:w},{default:d(()=>[g(" 取消 ")]),_:1}),r(C,{type:"primary",size:"large",onClick:$},{default:d(()=>[g(" 确定 ")]),_:1})]),default:d(()=>[r(Q,{ref_key:"formRef",ref:z,model:c(e),rules:c(R),"label-width":"7rem"},{default:d(()=>[r(l,{label:"上级部门",prop:""},{default:d(()=>[r(u,{modelValue:c(e).superior,"onUpdate:modelValue":o[0]||(o[0]=s=>c(e).superior=s),disabled:!!f.parentId,placeholder:"请输入部门名称",clearable:""},null,8,["modelValue","disabled"])]),_:1}),r(l,{label:"部门名称",prop:"name"},{default:d(()=>[r(u,{modelValue:c(e).name,"onUpdate:modelValue":o[1]||(o[1]=s=>c(e).name=s),placeholder:"请输入部门名称",clearable:""},null,8,["modelValue"])]),_:1}),r(l,{label:"部门主管",prop:""},{default:d(()=>[r(n,{modelValue:c(e).userIdList,"onUpdate:modelValue":o[2]||(o[2]=s=>c(e).userIdList=s),"value-key":"",placeholder:"请选择部门主管",multiple:"","collapse-tags":"","collapse-tags-tooltip":"",clearable:"",filterable:"",onChange:G},{default:d(()=>[(_(!0),y(x,null,S(c(V),s=>(_(),q(a,{key:s.value,label:s.userName,value:s.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),r(l,{label:"备注"},{default:d(()=>[r(u,{modelValue:c(e).remark,"onUpdate:modelValue":o[3]||(o[3]=s=>c(e).remark=s),placeholder:"请输入备注",clearable:""},null,8,["modelValue"])]),_:1}),(_(!0),y(x,null,S(c(m),s=>(_(),y("div",{key:s.id,class:"user"},[L("div",ne,[r(E,{type:"primary",closable:"",onClose:i=>J(s)},{default:d(()=>[g(oe(s.userName),1)]),_:2},1032,["onClose"])]),L("div",ue,[r(b,{style:{width:"4.375rem"}},{default:d(()=>[g("开启提成")]),_:1}),r(K,{modelValue:s.commissionStatus,"onUpdate:modelValue":i=>s.commissionStatus=i,"active-value":1,"inactive-value":2,"inline-prompt":"","active-text":"开启","inactive-text":"关闭"},null,8,["modelValue","onUpdate:modelValue"])]),h(L("div",re,[r(n,{modelValue:s.commissionType,"onUpdate:modelValue":i=>s.commissionType=i,"value-key":"",placeholder:"计提方式",clearable:"",filterable:""},{default:d(()=>[(_(),y(x,null,S(N,i=>r(a,{key:i.value,label:i.label,value:i.value},null,8,["label","value"])),64))]),_:2},1032,["modelValue","onUpdate:modelValue"])],512),[[U,s.commissionStatus===1]]),h(L("div",ie,[r(n,{class:"select",modelValue:s.commissionTime,"onUpdate:modelValue":i=>s.commissionTime=i,"value-key":"",placeholder:"计提时间",clearable:"",filterable:""},{default:d(()=>[(_(),y(x,null,S(M,i=>r(a,{key:i.value,label:i.label,value:i.value},null,8,["label","value"])),64))]),_:2},1032,["modelValue","onUpdate:modelValue"])],512),[[U,s.commissionStatus===1]]),h(L("div",de,[r(u,{modelValue:s.commission,"onUpdate:modelValue":i=>s.commission=i,placeholder:"提成比例",style:{"max-width":"25rem"},clearable:""},{append:d(()=>[g("%")]),_:2},1032,["modelValue","onUpdate:modelValue"])],512),[[U,s.commissionStatus===1]])]))),128))]),_:1},8,["model","rules"])]),_:1},8,["modelValue","title"])),[[X,c(v)]])}}}),ve=te(ce,[["__scopeId","data-v-7f38a2ac"]]);export{ve as default};

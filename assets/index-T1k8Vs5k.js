
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{d as ee,m as F,r as _,u as se,c as ae,n as le,a as v,q as oe,o as f,e as T,w as d,f as u,g,z as N,i as m,s as V,b as L,t as S,F as k,y as h,aq as U,E as D,L as te}from"./index-CCggbm1Q.js";import{a as x}from"./survey_vip_department-C6SsBd5d.js";const ne={class:"mr"},ie={class:"mr checkbox-container"},re={class:"centers mr"},ue={class:"center mr"},de={class:"center mr"},ce=ee({__name:"index",props:F({parentId:{default:""},id:{default:""},tree:{},row:{},isClick:{type:Boolean}},{modelValue:{type:Boolean,default:!1},modelModifiers:{}}),emits:F(["getList","getItmelist"],["update:modelValue"]),setup(q,{emit:O}){const I=_([]),y=q,B=_(!1),j=[{label:"完成计提",value:1},{label:"审核计提",value:2}],R=[{label:"按项目价",value:1},{label:"按成本价",value:2},{label:"按毛利润",value:3}],p=_(!1),w=O,z=se(q,"modelValue"),$=ae(()=>y.id===""?"新增部门":"编辑部门"),c=_([]),E=_(),e=_({parentId:y.parentId,name:"",remark:"",userIdList:[],organizationalStructurePersonList:[]}),A=_({name:[{required:!0,message:"请输入部门名称"}],commissionType:[{required:!0,message:"请选择计提方式",trigger:"change"}]}),J=o=>{if(o.userId){const s=e.value.userIdList.indexOf(o.userId);s!==-1&&e.value.userIdList.splice(s,1)}else{const s=e.value.userIdList.indexOf(o.id);s!==-1&&e.value.userIdList.splice(s,1)}const n=e.value.organizationalStructurePersonList.findIndex(s=>s.id===o.id||s.userId===o.id);n!==-1&&e.value.organizationalStructurePersonList.splice(n,1);const i=c.value.findIndex(s=>s.id===o.id||s.userId===o.id);i!==-1&&c.value.splice(i,1)},G=o=>{var n;if(e.value.userIdList=o,c.value=I.value.filter(i=>{var s;return(s=e.value)==null?void 0:s.userIdList.includes(i.id)}),(n=e.value)!=null&&n.userIdList.length){const i=[];e.value.organizationalStructurePersonList.forEach(t=>{i.push(t)}),c.value.forEach(t=>{e.value.organizationalStructurePersonList.some(b=>b.userId===t.id)||i.push(t)});const a=Array.from(new Map(i.map(t=>[t.id,t])).values()).filter(t=>t.userId?o.includes(t.userId):o.includes(t.id));c.value=a,e.value.organizationalStructurePersonList=c.value}else c.value=[],e.value.organizationalStructurePersonList=c.value};function H(o){for(const n of o){const i=n.commission,s=n.commissionStatus;if(s!==2&&s===1&&!/^[1-9]\d*$/.test(i))return!1}return!0}async function K(){try{E.value&&await E.value.validate(async o=>{if(o){if(p.value=!0,e.value.organizationalStructurePersonList=[],!H(c.value)){D.warning({message:"提成比例必须是正整数",center:!0}),p.value=!1;return}c.value.forEach(a=>{if(a.userId){const t={id:a.id,userId:a.userId,commission:a.commission||0,commissionTime:a.commissionTime||1,commissionStatus:a.commissionStatus,commissionType:a.commissionType||1};e.value.organizationalStructurePersonList.push(t)}else{const t={userId:a.id,commission:a.commission||0,commissionTime:a.commissionTime||1,commissionStatus:a.commissionStatus,commissionType:a.commissionType||1};e.value.organizationalStructurePersonList.push(t)}});const i=e.value.organizationalStructurePersonList.reduce((a,t)=>(a.some(b=>b.userId===t.userId)||a.push(t),a),[]);e.value.organizationalStructurePersonList=i;const s={...e.value};if(delete s.userIdList,e.value.id){const{status:a}=await x.edit(s);a===1&&D.success({message:"编辑成功",center:!0})}else{const{status:a}=await x.create(s);a===1&&D.success({message:"新增成功",center:!0})}p.value=!1,B.value?(await w("getItmelist"),await w("getList")):await w("getList"),P()}})}catch{}finally{p.value=!1}}function P(){Object.assign(e,{parentId:"",name:"",remark:"",userIdList:[],organizationalStructurePersonList:[]}),z.value=!1}const Q=()=>I.value.filter(o=>{var n;return(n=e.value)==null?void 0:n.userIdList.includes(o.id)});return le(async()=>{try{if(p.value=!0,y.id){const{id:o,name:n,remark:i,organizationalStructurePersonList:s}=JSON.parse(y.row);e.value.id=o,e.value.name=n,e.value.remark=i,B.value=y.isClick;const{data:a}=await x.queryMemberListByOrganizationIdToUpdate({organizationalStructureId:e.value.id});a&&(I.value=a),s?(e.value.organizationalStructurePersonList=s,s.forEach(t=>{e.value.userIdList.push(t.userId)})):e.value.organizationalStructurePersonList=[]}else{const{data:o}=await x.queryMemberList();o&&(I.value=o)}c.value=Q(),e.value.id&&(c.value=e.value.organizationalStructurePersonList)}catch(o){console.error("Error occurred:",o)}finally{p.value=!1}}),(o,n)=>{const i=v("ElInput"),s=v("ElFormItem"),a=v("el-option"),t=v("el-select"),C=v("el-tag"),b=v("el-text"),W=v("el-switch"),X=v("ElForm"),M=v("ElButton"),Y=v("ElDialog"),Z=oe("loading");return f(),T(Y,{modelValue:z.value,"onUpdate:modelValue":n[3]||(n[3]=l=>z.value=l),title:m($),style:{width:"48rem"},"close-on-click-modal":!1,"append-to-body":"","destroy-on-close":"",onClosed:P},{footer:d(()=>[u(M,{size:"large",onClick:P},{default:d(()=>[g(" 取消 ")]),_:1}),u(M,{type:"primary",size:"large",onClick:K},{default:d(()=>[g(" 确定 ")]),_:1})]),default:d(()=>[g(N(m(p))+" ",1),V((f(),T(X,{ref_key:"formRef",ref:E,model:m(e),rules:m(A),"label-width":"7rem"},{default:d(()=>[u(s,{label:"部门名称",prop:"name"},{default:d(()=>[u(i,{modelValue:m(e).name,"onUpdate:modelValue":n[0]||(n[0]=l=>m(e).name=l),placeholder:"请输入部门名称",clearable:""},null,8,["modelValue"])]),_:1}),u(s,{label:"部门主管",prop:""},{default:d(()=>[u(t,{modelValue:m(e).userIdList,"onUpdate:modelValue":n[1]||(n[1]=l=>m(e).userIdList=l),"value-key":"",placeholder:"请选择部门主管",multiple:"","collapse-tags":"","collapse-tags-tooltip":"",clearable:"",filterable:"",onChange:G},{default:d(()=>[(f(!0),L(k,null,S(m(I),l=>(f(),T(a,{key:l.value,label:l.userName,value:l.id,disabled:l.enableChargePerson===1},null,8,["label","value","disabled"]))),128))]),_:1},8,["modelValue"])]),_:1}),u(s,{label:"备注"},{default:d(()=>[u(i,{modelValue:m(e).remark,"onUpdate:modelValue":n[2]||(n[2]=l=>m(e).remark=l),placeholder:"请输入备注",clearable:""},null,8,["modelValue"])]),_:1}),(f(!0),L(k,null,S(m(c),l=>(f(),L("div",{key:l.id,class:"user"},[h("div",ne,[u(C,{type:"primary",style:{},closable:"",onClose:r=>J(l)},{default:d(()=>[g(N(l.id?l.userName:l.name),1)]),_:2},1032,["onClose"])]),h("div",ie,[u(b,{style:{width:"4.375rem"}},{default:d(()=>[g("开启提成")]),_:1}),u(W,{modelValue:l.commissionStatus,"onUpdate:modelValue":r=>l.commissionStatus=r,"active-value":1,"inactive-value":2,"inline-prompt":"","active-text":"开启","inactive-text":"关闭"},null,8,["modelValue","onUpdate:modelValue"])]),V(h("div",re,[u(t,{modelValue:l.commissionType,"onUpdate:modelValue":r=>l.commissionType=r,"value-key":"",placeholder:"计提方式",clearable:"",filterable:""},{default:d(()=>[(f(),L(k,null,S(R,r=>u(a,{key:r.value,label:r.label,value:r.value},null,8,["label","value"])),64))]),_:2},1032,["modelValue","onUpdate:modelValue"])],512),[[U,l.commissionStatus===1]]),V(h("div",ue,[u(t,{class:"select",modelValue:l.commissionTime,"onUpdate:modelValue":r=>l.commissionTime=r,"value-key":"",placeholder:"计提时间",clearable:"",filterable:""},{default:d(()=>[(f(),L(k,null,S(j,r=>u(a,{key:r.value,label:r.label,value:r.value},null,8,["label","value"])),64))]),_:2},1032,["modelValue","onUpdate:modelValue"])],512),[[U,l.commissionStatus===1]]),V(h("div",de,[u(i,{modelValue:l.commission,"onUpdate:modelValue":r=>l.commission=r,placeholder:"提成比例",style:{"max-width":"25rem"},clearable:""},{append:d(()=>[g("%")]),_:2},1032,["modelValue","onUpdate:modelValue"])],512),[[U,l.commissionStatus===1]])]))),128))]),_:1},8,["model","rules"])),[[Z,m(p)]])]),_:1},8,["modelValue","title"])}}}),pe=te(ce,[["__scopeId","data-v-bed9651e"]]);export{pe as default};


/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{ad as H,ab as J,r as c,d as z,bx as Q,o as W,ak as X,ai as P,a2 as h,al as Y,a3 as Z,h as a,a as _,i as w,f as k,w as v,c as x,g as U,b as E,t as K,N as j,O as ee,j as V,by as le,y as te}from"./index-o59bYei-.js";import{a as T}from"./configuration_role-CLgNITG2.js";const ae={list:()=>H.get("role/getRoleButton")},oe=J("buttonPermission",()=>{const g=c([]);return{permissions:g,getPermissions:async()=>{if(g.value.length)return g.value;const{data:y}=await ae.list();return g.value=y,y}}}),se=oe,ne={class:"custom-tree-node"},re={class:"menu"},ue={class:"permission"},ie={key:0,class:"permissions"},ce=z({__name:"index",props:["id","row"],setup(g,{expose:N}){const y=g,R=Q(),D=se(),r=c(!1);c(!1);const A=c(),f=c(),I=c([]),o=c([]),e=c({id:y.id??null,menuId:[],permission:[],roleName:"",remark:"",checkAll:!1}),G=c({roleName:[{required:!0,message:"请输入角色名称",trigger:"blur"}]}),L=c(null);W(async()=>{try{r.value=!0,o.value=await D.getPermissions(),I.value=R.routesRaw,e.value.id!==""?await O():(e.value.menuId=[],e.value.permission=[],e.value.checkAll=!1),r.value=!1}catch{}finally{r.value=!1}o.value.length==e.value.permission.length&&(e.value.checkAll=!0)});const B=c(),M=()=>{L.value=le.service({target:B.value,text:"请稍后...",spinner:"el-icon-loading",background:"rgba(0, 0, 0, 0.7)",customClass:"custom-target-loading",lock:!0}),setTimeout(()=>{e.value.checkAll?(e.value.menuId=[],e.value.permission=[],I.value.length&&I.value.forEach(t=>{e.value.menuId.push(t.id)}),o.value.length&&o.value.forEach(t=>{e.value.permission.push(t.id)}),f.value.setCheckedNodes([...e.value.permission,...e.value.menuId])):(e.value.checkAll=!1,e.value.menuId=[],e.value.permission=[],f.value.setCheckedNodes([])),L.value.close()},2e3)};async function O(){r.value=!0;const{menuId:t,...l}=JSON.parse(y.row);e.value=l;const u=await R.obtainLevel1AndLevel2Routing();e.value.menuId=t.filter(s=>!u.some(n=>n.id===s)),r.value=!1}function F(t){var l;return(l=o==null?void 0:o.value)==null?void 0:l.filter(u=>t===u.menuId)}const $=t=>{const l=[];l.push(t),f.value.getNode(t.id).checked?l.map(s=>{var d;const n=(d=o==null?void 0:o.value)==null?void 0:d.filter(i=>s.id===i.menuId);n&&n.length&&n.forEach(i=>{e.value.permission.push(i.id)})}):l.map(s=>{var d;const n=(d=o==null?void 0:o.value)==null?void 0:d.filter(i=>s.id===i.menuId);if(n&&n.length){let i=n.map(p=>p.id);e.value.permission=e.value.permission.filter(p=>!i.some(C=>C===p))}}),o.value.length==e.value.permission.length&&(e.value.checkAll=!0)};return N({submit(){r.value=!0;const t=X(e.value);return new Promise((l,u)=>{try{t.menuId=f.value.getCheckedKeys(!1);const s=f.value.getCheckedKeys(),n=f.value.getHalfCheckedKeys(),d=s.concat(n);t.menuId=d,e.value.menuId=d,A.value.validate(async i=>{if(!i)return r.value=!1,u(new Error("验证不通过"));try{t.id===""?(await T.create(t),P.success({message:"新增成功",center:!0})):(await T.edit(t),P.success({message:"编辑成功",center:!0})),l()}catch(p){u(p)}finally{r.value=!1}})}catch(s){r.value=!1,u(s)}})}}),(t,l)=>{const u=h("ElInput"),s=h("ElFormItem"),n=h("el-checkbox"),d=h("ElCheckbox"),i=h("ElCheckboxGroup"),p=h("el-tree"),C=h("ElForm"),q=Y("loading");return Z((_(),w("div",{ref_key:"eleDivRef",ref:B,style:{height:"90vh"}},[k(C,{ref_key:"formRef",ref:A,model:a(e),rules:a(G),"label-width":"120px"},{default:v(()=>[k(s,{label:"角色名称",prop:"roleName"},{default:v(()=>[k(u,{modelValue:a(e).roleName,"onUpdate:modelValue":l[0]||(l[0]=m=>a(e).roleName=m),placeholder:"请输入角色名称"},null,8,["modelValue"])]),_:1}),k(s,{label:"备注",prop:"remark"},{default:v(()=>[k(u,{modelValue:a(e).remark,"onUpdate:modelValue":l[1]||(l[1]=m=>a(e).remark=m),placeholder:"请输入备注"},null,8,["modelValue"])]),_:1}),a(r)?V("",!0):(_(),x(s,{key:0,label:"权限"},{default:v(()=>[k(n,{modelValue:a(e).checkAll,"onUpdate:modelValue":l[2]||(l[2]=m=>a(e).checkAll=m),onChange:M},{default:v(()=>[U("全选/取消全选")]),_:1},8,["modelValue"]),a(e).menuId?(_(),x(p,{key:0,ref_key:"treeRef",ref:f,data:a(I),style:{width:"100%"},"default-checked-keys":a(e).menuId,"default-expanded-keys":[],"node-key":"id","show-checkbox":"",onCheckChange:$,"default-expand-all":"",border:""},{default:v(({data:m})=>{var S;return[E("div",ne,[E("div",re,K(m.meta.title),1),E("div",ue,[(S=F(m.id))!=null&&S.length?(_(),w("div",ie,[k(i,{modelValue:a(e).permission,"onUpdate:modelValue":l[3]||(l[3]=b=>a(e).permission=b)},{default:v(()=>[(_(!0),w(j,null,ee(F(m.id),b=>(_(),x(d,{key:b.id,value:b.id},{default:v(()=>[U(K(b.label),1)]),_:2},1032,["value"]))),128))]),_:2},1032,["modelValue"])])):V("",!0)])])]}),_:1},8,["data","default-checked-keys"])):V("",!0)]),_:1}))]),_:1},8,["model","rules"])])),[[q,a(r)]])}}}),ve=te(ce,[["__scopeId","data-v-5e2bc09f"]]);export{ve as default};

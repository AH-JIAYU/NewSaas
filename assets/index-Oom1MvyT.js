
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{d as Y,B,r as I,C as Z,E as ee,o as le,a2 as p,al as ae,a3 as V,h as d,a as _,c as M,w as c,f as r,g as h,i as b,O as S,N as x,b as y,t as se,aG as P,ai as U,y as oe}from"./index-Ciz6FZao.js";import{a as T}from"./survey_vip_department-BQj27WXx.js";const te={class:"mr"},ne={class:"mr checkbox-container"},ue={class:"centers mr"},re={class:"center mr"},ie={class:"center mr"},de=Y({__name:"index",props:B({parentId:{default:""},id:{default:""},tree:{},row:{},name:{}},{modelValue:{type:Boolean,default:!1},modelModifiers:{}}),emits:B(["getList"],["update:modelValue"]),setup(C,{emit:q}){const L=I([]),f=C,N=[{label:"完成计提",value:1},{label:"审核计提",value:2}],F=[{label:"按项目价",value:1},{label:"按成本价",value:2},{label:"按毛利润",value:3}],v=I(!1),O=q,k=Z(C,"modelValue"),j=ee(()=>f.id===""?"新增子部门":"编辑子部门"),m=I([]),w=I(),e=I({parentId:f.parentId,name:"",remark:"",userIdList:[],organizationalStructurePersonList:[],superior:""}),R=I({name:[{required:!0,message:"请输入部门名称"}],commissionType:[{required:!0,message:"请选择计提方式",trigger:"change"}]});function $(t){for(const o of t){const u=o.commission,l=o.commissionStatus;if(l!==2&&l===1&&!/^[1-9]\d*$/.test(u))return!1}return!0}async function A(){try{w.value&&w.value.validate(async t=>{if(t){if(v.value=!0,e.value.organizationalStructurePersonList=[],!$(m.value)){U.warning({message:"提成比例必须是正整数",center:!0}),v.value=!1;return}m.value.forEach(a=>{if(a.userId){const n={id:a.id,userId:a.userId,commission:a.commission||0,commissionTime:a.commissionTime||1,commissionStatus:a.commissionStatus,commissionType:a.commissionType||1};e.value.organizationalStructurePersonList.push(n)}else{const n={userId:a.id,commission:a.commission||0,commissionTime:a.commissionTime||1,commissionStatus:a.commissionStatus,commissionType:a.commissionType||1};e.value.organizationalStructurePersonList.push(n)}});const u=e.value.organizationalStructurePersonList.reduce((a,n)=>(a.some(g=>g.userId===n.userId)||a.push(n),a),[]);e.value.organizationalStructurePersonList=u;const l={...e.value};if(delete l.userIdList,delete l.superior,e.value.id){const{status:a}=await T.edit(l);a===1&&U.success({message:"编辑成功",center:!0}),v.value=!1}else{const{status:a}=await T.create(l);a===1&&U.success({message:"新增成功",center:!0}),v.value=!1}await O("getList"),z()}})}catch{}finally{v.value=!1}}const G=t=>{if(t.userId){const l=e.value.userIdList.indexOf(t.userId);l!==-1&&e.value.userIdList.splice(l,1)}else{const l=e.value.userIdList.indexOf(t.id);l!==-1&&e.value.userIdList.splice(l,1)}const o=e.value.organizationalStructurePersonList.findIndex(l=>l.id===t.id||l.userId===t.id);o!==-1&&e.value.organizationalStructurePersonList.splice(o,1);const u=m.value.findIndex(l=>l.id===t.id||l.userId===t.id);u!==-1&&m.value.splice(u,1)},J=t=>{var o;if(e.value.userIdList=t,m.value=L.value.filter(u=>{var l;return(l=e.value)==null?void 0:l.userIdList.includes(u.id)}),(o=e.value)!=null&&o.userIdList.length){const u=[];e.value.organizationalStructurePersonList.forEach(n=>{u.push(n)}),m.value.forEach(n=>{e.value.organizationalStructurePersonList.some(g=>g.userId===n.id)||u.push(n)});const a=Array.from(new Map(u.map(n=>[n.id,n])).values()).filter(n=>t.includes(n.id));m.value=a,e.value.organizationalStructurePersonList=m.value}else m.value=[],e.value.organizationalStructurePersonList=m.value};function z(){Object.assign(e,{parentId:"",name:"",remark:"",userIdList:[],organizationalStructurePersonList:[],superior:""}),k.value=!1}const H=()=>L.value.filter(t=>{var o;return(o=e.value)==null?void 0:o.userIdList.includes(t.id)});return f.parentId&&(e.value.superior=f.name),le(async()=>{try{if(v.value=!0,f.id!==""){const{id:t,name:o,remark:u,organizationalStructurePersonList:l}=JSON.parse(f.row);e.value.id=t,e.value.name=o,e.value.remark=u,e.value.organizationalStructurePersonList=l,l.forEach(a=>{e.value.userIdList.push(a.userId)})}else{const{data:t}=await T.queryMemberList();t&&(L.value=t)}m.value=H(),e.value.id&&(m.value=e.value.organizationalStructurePersonList),v.value=!1}catch{}finally{v.value=!1}}),(t,o)=>{const u=p("ElInput"),l=p("ElFormItem"),a=p("el-option"),n=p("el-select"),E=p("el-tag"),g=p("el-text"),K=p("el-switch"),Q=p("ElForm"),D=p("ElButton"),W=p("ElDialog"),X=ae("loading");return V((_(),M(W,{modelValue:k.value,"onUpdate:modelValue":o[4]||(o[4]=s=>k.value=s),title:d(j),style:{width:"48rem"},"close-on-click-modal":!1,"append-to-body":"","destroy-on-close":"",onClosed:z},{footer:c(()=>[r(D,{size:"large",onClick:z},{default:c(()=>[h(" 取消 ")]),_:1}),r(D,{type:"primary",size:"large",onClick:A},{default:c(()=>[h(" 确定 ")]),_:1})]),default:c(()=>[r(Q,{ref_key:"formRef",ref:w,model:d(e),rules:d(R),"label-width":"7rem"},{default:c(()=>[r(l,{label:"上级部门",prop:""},{default:c(()=>[r(u,{modelValue:d(e).superior,"onUpdate:modelValue":o[0]||(o[0]=s=>d(e).superior=s),disabled:!!f.parentId,placeholder:"请输入部门名称",clearable:""},null,8,["modelValue","disabled"])]),_:1}),r(l,{label:"部门名称",prop:"name"},{default:c(()=>[r(u,{modelValue:d(e).name,"onUpdate:modelValue":o[1]||(o[1]=s=>d(e).name=s),placeholder:"请输入部门名称",clearable:""},null,8,["modelValue"])]),_:1}),r(l,{label:"部门主管",prop:""},{default:c(()=>[r(n,{modelValue:d(e).userIdList,"onUpdate:modelValue":o[2]||(o[2]=s=>d(e).userIdList=s),"value-key":"",placeholder:"请选择部门主管",multiple:"","collapse-tags":"","collapse-tags-tooltip":"",clearable:"",filterable:"",onChange:J},{default:c(()=>[(_(!0),b(x,null,S(d(L),s=>(_(),M(a,{key:s.value,label:s.userName,value:s.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),r(l,{label:"备注"},{default:c(()=>[r(u,{modelValue:d(e).remark,"onUpdate:modelValue":o[3]||(o[3]=s=>d(e).remark=s),placeholder:"请输入备注",clearable:""},null,8,["modelValue"])]),_:1}),(_(!0),b(x,null,S(d(m),s=>(_(),b("div",{key:s.id,class:"user"},[y("div",te,[r(E,{type:"primary",closable:"",onClose:i=>G(s)},{default:c(()=>[h(se(s.userName),1)]),_:2},1032,["onClose"])]),y("div",ne,[r(g,{style:{width:"4.375rem"}},{default:c(()=>[h("开启提成")]),_:1}),r(K,{modelValue:s.commissionStatus,"onUpdate:modelValue":i=>s.commissionStatus=i,"active-value":1,"inactive-value":2,"inline-prompt":"","active-text":"开启","inactive-text":"关闭"},null,8,["modelValue","onUpdate:modelValue"])]),V(y("div",ue,[r(n,{modelValue:s.commissionType,"onUpdate:modelValue":i=>s.commissionType=i,"value-key":"",placeholder:"计提方式",clearable:"",filterable:""},{default:c(()=>[(_(),b(x,null,S(F,i=>r(a,{key:i.value,label:i.label,value:i.value},null,8,["label","value"])),64))]),_:2},1032,["modelValue","onUpdate:modelValue"])],512),[[P,s.commissionStatus===1]]),V(y("div",re,[r(n,{class:"select",modelValue:s.commissionTime,"onUpdate:modelValue":i=>s.commissionTime=i,"value-key":"",placeholder:"计提时间",clearable:"",filterable:""},{default:c(()=>[(_(),b(x,null,S(N,i=>r(a,{key:i.value,label:i.label,value:i.value},null,8,["label","value"])),64))]),_:2},1032,["modelValue","onUpdate:modelValue"])],512),[[P,s.commissionStatus===1]]),V(y("div",ie,[r(u,{modelValue:s.commission,"onUpdate:modelValue":i=>s.commission=i,placeholder:"提成比例",style:{"max-width":"25rem"},clearable:""},null,8,["modelValue","onUpdate:modelValue"])],512),[[P,s.commissionStatus===1]])]))),128))]),_:1},8,["model","rules"])]),_:1},8,["modelValue","title"])),[[X,d(v)]])}}}),pe=oe(de,[["__scopeId","data-v-e1413451"]]);export{pe as default};


/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import N from"./index-BmhbwDCI.js";import{o as R,s as I}from"./apiLoading-DQ5kQxCY.js";import{u as q}from"./index-Coa3gg1s.js";import{u as H}from"./stagedData-CqrNu2wv.js";import{d as O,l as F,r as c,a2 as G,a3 as d,n as J,a as T,o as _,b as K,f as p,w as u,g,i as b,e as W,j as X,Q as Y,ao as f,E as m,P as Z}from"./index-DoiK1_dJ.js";import{u as $}from"./user_customer-nTUz_v_K.js";import{a as y}from"./projectManagement-ywiR4fOx.js";import"./index.vue_vue_type_script_setup_true_lang-C6VjAa-z.js";import"./index-ByEKE8q7.js";import"./zh_Hans-B39mJ-rS.js";import"./file-CU_3W4Vu.js";import"./user_customer-DQInRZ9f.js";const ee=O({name:"ProjeckEdit",__name:"index",emits:["fetch-data"],setup(te,{expose:C,emit:h}){const D=q(),v=H(),P=F(),V=$(),k=h,l=c(!1),r=c(""),n=c([]),i=c([]);function S(e){n.value.push(e)}G("validateTopTabs",S);let o=d([]);const L=c();async function A(e){if(e){r.value="编辑";const t=await R(y.detail({projectId:e.projectId}));E(t.data)}else{r.value="新增";const t=f(D.initialTopTabsData);o=v.projectManagementList||d([t])}l.value=!0,i.value=[],n.value=[]}function E(e){e.data={configurationInformation:{initialProblem:{countryId:null,projectProblemCategoryId:null,projectQuotaQuestionType:null,projectProblemId:null,keyValue:"",questionType:null,answerValueList:[],projectAnswerIdList:[]},configurationCountryList:null,projectCategoryList:null,ProjectProblemInfoList:[]}},o=[];const{projectInfoList:t,...a}=f(e);a.descriptionUrl=a.descriptionUrl.split(","),o.push(a),t&&t.length&&t.forEach(s=>{s.data={configurationInformation:{initialProblem:{countryId:null,projectProblemCategoryId:null,projectQuotaQuestionType:null,projectProblemId:null,keyValue:"",questionType:null,answerValueList:[],projectAnswerIdList:[]},configurationCountryList:null,projectCategoryList:null,ProjectProblemInfoList:[]}},s.descriptionUrl=s.descriptionUrl.split(","),o.push({...s})})}function x(){v.projectManagementList=f(o),o=d([]),l.value=!1,n.value=[]}async function j(){const e=[];n.value.forEach(a=>{e.push(a.validate())});const t=await Promise.allSettled(e);i.value=t.map(a=>a.status)}function U(e){const t=new Set;for(const a of e){if(t.has(a.name))return!0;t.add(a.name)}return!1}const M=()=>{const e=f(o);e.forEach(a=>{a.descriptionUrl=a.descriptionUrl.join(","),a.data&&delete a.data,a.projectQuotaInfoList=a.projectQuotaInfoList.map(s=>(Array.isArray(s.answerValueList)||(s.answerValueList=[]),Array.isArray(s.projectAnswerIdList)||(s.projectAnswerIdList=[]),s))});let t=e[0];return t.projectInfoList=e.slice(1),t};async function Q(){if(await j(),i.value.every(e=>e==="fulfilled"))if(U(o))m({message:"项目名称重复",center:!0});else{const e=M();if(r.value==="新增"){const{status:t}=await I(y.create(e));t===1&&m.success({message:"新增成功",center:!0})}else{const{status:t}=await I(y.edit(e));t===1&&m.success({message:"编辑成功",center:!0})}k("fetch-data"),w()}else L.value.activeLeftTab=i.value.indexOf("rejected"),m.warning({message:"请完善表单",center:!0})}function w(){o=d([]),i.value=[],n.value=[],l.value=!1,r.value==="新增"&&(v.projectManagementList=null)}const B=async()=>{await V.getCustomerList(),await P.getCountry()};return J(async()=>{await B()}),C({showEdit:A}),(e,t)=>{const a=T("el-button"),s=T("el-drawer");return _(),K("div",null,[p(s,{modelValue:l.value,"onUpdate:modelValue":t[0]||(t[0]=z=>l.value=z),class:Y(r.value==="新增"||b(o).length>1?"hide-drawer-header":"edit-drawer"),"append-to-body":"","close-on-click-modal":!1,"destroy-on-close":"",draggable:"",size:"70%"},{footer:u(()=>[p(a,{onClick:w},{default:u(()=>[g(" 取消 ")]),_:1}),p(a,{type:"warning",onClick:x},{default:u(()=>[g(" 暂存 ")]),_:1}),p(a,{type:"primary",onClick:Q},{default:u(()=>[g(" 确定 ")]),_:1})]),default:u(()=>[b(o).length?(_(),W(N,{key:0,onValidate:j,ref_key:"LeftTabsRef",ref:L,"left-tabs-data":b(o),"validate-top-tabs":n.value,"validate-all":i.value,title:r.value},null,8,["left-tabs-data","validate-top-tabs","validate-all","title"])):X("",!0)]),_:1},8,["modelValue","class"])])}}}),me=Z(ee,[["__scopeId","data-v-cfd8cb82"]]);export{me as default};

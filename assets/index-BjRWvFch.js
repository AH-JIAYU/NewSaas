
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{d as G,l as J,r as n,a2 as h,a3 as v,n as K,a as D,q as W,o as C,b as X,f as u,w as d,y as Y,s as L,aq as k,g,z as Z,i as w,e as ee,j as te,N as ae,an as f,E as b,_ as oe,L as se}from"./index-BrZx5I8s.js";import ie from"./index-f_D3P7Ko.js";import{u as re}from"./projectManagement_list-Cp-xrOUg.js";import{u as ne}from"./stagedData-C-TL777j.js";import{u as le}from"./user_customer-JJChpSSL.js";import{a as _}from"./projectManagement-DZupsPiR.js";import"./index-DlfUL2As.js";import"./user_customer-CaQiNeFw.js";import"./file-4bDzsaJA.js";import"./index-C2vE6GWd.js";import"./zh_Hans-D0hrCB5w.js";import"./zh_Hans-B39mJ-rS.js";import"./index.vue_vue_type_script_setup_true_lang-Bd2ORI92.js";import"./index.vue_vue_type_script_setup_true_lang-Cg6Z3K8m.js";import"./index-C0Udy9Qc.js";import"./index-C6i_tuAg.js";import"./index-BJ4tLKe7.js";import"./index-BbmYX7gH.js";import"./department-BcdK0CN4.js";import"./position_manage-hHXhhc_L.js";import"./configuration_role-GTTynuKi.js";import"./tenant_role-DhzwxjrA.js";import"./configuration_manager-Bw4X6IHn.js";import"./configuration_siteSetting-BMskUkCN.js";import"./configuration_site_setting-DfPaj1lb.js";import"./apiLoading-esJ3RDIt.js";import"./index.vue_vue_type_script_setup_true_lang-CJrhxUEd.js";const ce={class:"flex-c"},ue=G({name:"ProjeckEdit",__name:"index",emits:["fetch-data"],setup(de,{expose:S,emit:V}){const m=re(),y=ne(),E=J(),U=le(),x=V,p=n(!1),r=n(""),i=n(!1),l=n([]),j=n(""),c=n([]);function A(e){l.value.push(e)}function B(e){j.value=e}h("validateTopTabs",A),h("currentProjectTimeline",B);let s=v([]);const I=n();async function M(e){try{if(i.value=!0,e){r.value="编辑";const a=await _.detail({projectId:e.projectId});Q(a.data)}else{r.value="新增";const a=f(m.initialTopTabsData);s=y.projectManagementList||v([a])}p.value=!0,c.value=[],l.value=[],i.value=!1}catch{}finally{i.value=!1}}function Q(e){e.data={configurationInformation:{initialProblem:{countryId:null,projectProblemCategoryId:null,projectQuotaQuestionType:null,projectProblemId:null,keyValue:"",questionType:null,answerValueList:[],projectAnswerIdList:[]},configurationCountryList:null,projectCategoryList:null,ProjectProblemInfoList:[]}},s=[];const{projectInfoList:a,...t}=f(e);t.descriptionUrl?t.descriptionUrl=t.descriptionUrl.split(","):t.descriptionUrl=[],s.push(t),a&&a.length&&a.forEach(o=>{o.data={configurationInformation:{initialProblem:{countryId:null,projectProblemCategoryId:null,projectQuotaQuestionType:null,projectProblemId:null,keyValue:"",questionType:null,answerValueList:[],projectAnswerIdList:[]},configurationCountryList:null,projectCategoryList:null,ProjectProblemInfoList:[]}},o.descriptionUrl=o.descriptionUrl.split(","),s.push({...o})}),m.dataBeforeEditing=f(s)}function N(){y.projectManagementList=f(s),s=v([]),p.value=!1,l.value=[]}async function T(){const e=[];l.value.forEach(t=>{e.push(t.validate())});const a=await Promise.allSettled(e);c.value=a.map(t=>t.status)}function R(e){const a=new Set;for(const t of e){if(a.has(t.name))return!0;a.add(t.name)}return!1}const q=async()=>{const e=f(s);await m.compareProjectData(m.dataBeforeEditing,e),await e.forEach(t=>{t.descriptionUrl=t.descriptionUrl.join(","),(!t.data.configurationInformation.ProjectProblemInfoList||!t.data.configurationInformation.ProjectProblemInfoList.length)&&(t.isProfile=2),t.data&&delete t.data,t.projectQuotaInfoList=t.projectQuotaInfoList.map(o=>(Array.isArray(o.answerValueList)||(o.answerValueList=[]),Array.isArray(o.projectAnswerIdList)||(o.projectAnswerIdList=[]),o))});let a=e[0];return a.projectInfoList=e.slice(1),a};async function z(){if(i.value=!0,await T(),c.value.every(e=>e==="fulfilled"))if(R(s))b({message:"项目名称重复",center:!0});else{const e=await q();setTimeout(async()=>{if(r.value==="新增"){const{status:a}=await _.create(e);a===1&&b.success({message:"新增成功",center:!0})}else{const{status:a}=await _.edit(e);a===1&&b.success({message:"编辑成功",center:!0})}x("fetch-data"),P()},1e3)}else I.value.activeLeftTab=c.value.indexOf("rejected"),b.warning({message:"请完善表单",center:!0});i.value=!1}function P(){s=v([]),c.value=[],l.value=[],p.value=!1,r.value==="新增"&&(y.projectManagementList=null)}const H=async()=>{await U.getCustomerList(),await E.getCountry()};return K(async()=>{await H()}),S({showEdit:M}),(e,a)=>{const t=oe,o=D("el-button"),O=D("el-drawer"),$=W("loading");return C(),X("div",null,[u(O,{modelValue:p.value,"onUpdate:modelValue":a[0]||(a[0]=F=>p.value=F),class:ae(r.value==="新增"||w(s).length>1?"hide-drawer-header":"edit-drawer"),"append-to-body":"","close-on-click-modal":!1,"destroy-on-close":"",draggable:"",size:"70%"},{footer:d(()=>[Y("div",ce,[L(u(o,{link:""},{default:d(()=>[u(t,{name:"ant-design:clock-circle-outlined"}),g("   "+Z(j.value),1)]),_:1},512),[[k,j.value]]),u(o,{type:"primary",onClick:z,disabled:i.value},{default:d(()=>[g(" 发布项目 ")]),_:1},8,["disabled"]),L(u(o,{type:"warning",onClick:N,disabled:i.value},{default:d(()=>[g(" 暂存 ")]),_:1},8,["disabled"]),[[k,r.value!=="编辑"]]),u(o,{onClick:P,disabled:i.value},{default:d(()=>[g(" 取消 ")]),_:1},8,["disabled"])])]),default:d(()=>[w(s).length?L((C(),ee(ie,{key:0,onValidate:T,ref_key:"LeftTabsRef",ref:I,"left-tabs-data":w(s),"validate-top-tabs":l.value,"validate-all":c.value,title:r.value},null,8,["left-tabs-data","validate-top-tabs","validate-all","title"])),[[$,i.value]]):te("",!0)]),_:1},8,["modelValue","class"])])}}}),Ne=se(ue,[["__scopeId","data-v-0e7d0246"]]);export{Ne as default};

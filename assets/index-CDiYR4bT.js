
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{d as Y,m as D,r as _,u as Z,c as ee,n as le,a as v,q as ae,o as p,e as P,w as c,f as u,g as S,s as V,i as m,b as g,t as h,F as x,y as I,z as se,aq as U,E as q,L as oe}from"./index-DsLR48ME.js";import{a as B}from"./department-rF_t-LPr.js";import{u as te}from"./configuration_manager-BP_Z6YkW.js";const ne={class:"mr"},re={class:"mr checkbox-container"},ue={class:"centers mr"},ie={class:"center mr"},de={class:"center mr"},ce=Y({__name:"index",props:D({parentId:{default:""},id:{default:""},tree:{},row:{}},{modelValue:{type:Boolean,default:!1},modelModifiers:{}}),emits:D(["getList"],["update:modelValue"]),setup(T,{emit:F}){const M=te(),L=_([]),y=T,N=[{label:"完成计提",value:1},{label:"审核计提",value:2},{label:"结算计提",value:3}],O=[{label:"按项目价",value:1},{label:"按成本价",value:2},{label:"按毛利润",value:3}],f=_(!1),j=F,k=Z(T,"modelValue"),R=ee(()=>y.id===""?"新增部门":"编辑部门"),i=_([]),z=_(),l=_({parentId:y.parentId,name:"",remark:"",userIdList:[],organizationalStructurePersonList:[]}),A=_({name:[{required:!0,message:"请输入部门名称"}],commissionType:[{required:!0,message:"请选择计提方式",trigger:"change"}]}),J=s=>{if(s.userId){const e=l.value.userIdList.indexOf(s.userId);e!==-1&&l.value.userIdList.splice(e,1)}else{const e=l.value.userIdList.indexOf(s.id);e!==-1&&l.value.userIdList.splice(e,1)}const o=l.value.organizationalStructurePersonList.findIndex(e=>e.id===s.id||e.userId===s.id);o!==-1&&l.value.organizationalStructurePersonList.splice(o,1);const t=i.value.findIndex(e=>e.id===s.id||e.userId===s.id);t!==-1&&i.value.splice(t,1)},$=s=>{var o;if(l.value.userIdList=s,i.value=L.value.filter(t=>{var e;return(e=l.value)==null?void 0:e.userIdList.includes(t.id)}),(o=l.value)!=null&&o.userIdList.length){const t=[];l.value.organizationalStructurePersonList.forEach(n=>{t.push(n)}),i.value.forEach(n=>{l.value.organizationalStructurePersonList.some(w=>w.userId===n.id)||t.push(n)});const d=Array.from(new Map(t.map(n=>[n.id,n])).values()).filter(n=>n.userId?s.includes(n.userId):s.includes(n.id));i.value=d,l.value.organizationalStructurePersonList=i.value}else i.value=[],l.value.organizationalStructurePersonList=i.value};async function G(){try{z.value&&z.value.validate(async s=>{if(s){f.value=!0,l.value.organizationalStructurePersonList=[],console.log("filteredUsers.value",i.value),i.value.forEach(e=>{if(e.userId){const d={id:e.id,userId:e.userId,commission:e.commission,commissionTime:e.commissionTime,commissionStatus:e.commissionStatus,commissionType:e.commissionType};l.value.organizationalStructurePersonList.push(d)}else{const d={userId:e.id,commission:e.commission,commissionTime:e.commissionTime,commissionStatus:e.commissionStatus,commissionType:e.commissionType};l.value.organizationalStructurePersonList.push(d)}});const o=l.value.organizationalStructurePersonList.reduce((e,d)=>(e.some(b=>b.userId===d.userId)||e.push(d),e),[]);l.value.organizationalStructurePersonList=o;const t={...l.value};if(delete t.userIdList,l.value.id){console.log("params",t),console.log("filteredUsers",i.value);const{status:e}=await B.edit(t);e===1&&q.success({message:"编辑成功",center:!0}),f.value=!1}else{console.log("params",t);const{status:e}=await B.create(t);e===1&&q.success({message:"新增成功",center:!0}),f.value=!1}await j("getList"),E()}})}catch{}finally{f.value=!1}}function E(){Object.assign(l,{parentId:"",name:"",remark:"",userIdList:[],organizationalStructurePersonList:[]}),k.value=!1}const H=()=>L.value.filter(s=>{var o;return(o=l.value)==null?void 0:o.userIdList.includes(s.id)});return le(async()=>{try{if(f.value=!0,y.id){const{id:s,name:o,remark:t,organizationalStructurePersonList:e}=JSON.parse(y.row);l.value.id=s,l.value.name=o,l.value.remark=t,e?(l.value.organizationalStructurePersonList=e,e.forEach(d=>{l.value.userIdList.push(d.userId)})):l.value.organizationalStructurePersonList=[]}L.value=await M.getStaff(),i.value=H(),l.value.id&&(i.value=l.value.organizationalStructurePersonList)}catch(s){console.error("Error occurred:",s)}finally{f.value=!1}}),(s,o)=>{const t=v("ElInput"),e=v("ElFormItem"),d=v("el-option"),n=v("el-select"),b=v("el-tag"),w=v("el-text"),K=v("el-switch"),Q=v("ElForm"),C=v("ElButton"),W=v("ElDialog"),X=ae("loading");return p(),P(W,{modelValue:k.value,"onUpdate:modelValue":o[3]||(o[3]=a=>k.value=a),title:m(R),style:{width:"48rem"},"close-on-click-modal":!1,"append-to-body":"","destroy-on-close":"",onClosed:E},{footer:c(()=>[u(C,{size:"large",onClick:E},{default:c(()=>[S(" 取消 ")]),_:1}),u(C,{type:"primary",size:"large",onClick:G},{default:c(()=>[S(" 确定 ")]),_:1})]),default:c(()=>[V((p(),P(Q,{ref_key:"formRef",ref:z,model:m(l),rules:m(A),"label-width":"7rem"},{default:c(()=>[u(e,{label:"部门名称",prop:"name"},{default:c(()=>[u(t,{modelValue:m(l).name,"onUpdate:modelValue":o[0]||(o[0]=a=>m(l).name=a),placeholder:"请输入部门名称",clearable:""},null,8,["modelValue"])]),_:1}),u(e,{label:"部门主管",prop:""},{default:c(()=>[u(n,{modelValue:m(l).userIdList,"onUpdate:modelValue":o[1]||(o[1]=a=>m(l).userIdList=a),"value-key":"",placeholder:"请选择部门主管",multiple:"","collapse-tags":"","collapse-tags-tooltip":"",clearable:"",filterable:"",onChange:$},{default:c(()=>[(p(!0),g(x,null,h(m(L),a=>(p(),P(d,{key:a.value,label:a.userName,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),u(e,{label:"备注"},{default:c(()=>[u(t,{modelValue:m(l).remark,"onUpdate:modelValue":o[2]||(o[2]=a=>m(l).remark=a),placeholder:"请输入备注",clearable:""},null,8,["modelValue"])]),_:1}),(p(!0),g(x,null,h(m(i),a=>(p(),g("div",{key:a.id,class:"user"},[I("div",ne,[u(b,{type:"primary",closable:"",onClose:r=>J(a)},{default:c(()=>[S(se(a.userName),1)]),_:2},1032,["onClose"])]),I("div",re,[u(w,{style:{width:"4.375rem"}},{default:c(()=>[S("开启提成")]),_:1}),u(K,{modelValue:a.commissionStatus,"onUpdate:modelValue":r=>a.commissionStatus=r,"active-value":1,"inactive-value":2,"inline-prompt":"","active-text":"开启","inactive-text":"关闭"},null,8,["modelValue","onUpdate:modelValue"])]),V(I("div",ue,[u(n,{modelValue:a.commissionType,"onUpdate:modelValue":r=>a.commissionType=r,"value-key":"",placeholder:"计提方式",clearable:"",filterable:""},{default:c(()=>[(p(),g(x,null,h(O,r=>u(d,{key:r.value,label:r.label,value:r.value},null,8,["label","value"])),64))]),_:2},1032,["modelValue","onUpdate:modelValue"])],512),[[U,a.commissionStatus===1]]),V(I("div",ie,[u(n,{class:"select",modelValue:a.commissionTime,"onUpdate:modelValue":r=>a.commissionTime=r,"value-key":"",placeholder:"计提时间",clearable:"",filterable:""},{default:c(()=>[(p(),g(x,null,h(N,r=>u(d,{key:r.value,label:r.label,value:r.value},null,8,["label","value"])),64))]),_:2},1032,["modelValue","onUpdate:modelValue"])],512),[[U,a.commissionStatus===1]]),V(I("div",de,[u(t,{modelValue:a.commission,"onUpdate:modelValue":r=>a.commission=r,placeholder:"提成比例",style:{"max-width":"25rem"},clearable:""},null,8,["modelValue","onUpdate:modelValue"])],512),[[U,a.commissionStatus===1]])]))),128))]),_:1},8,["model","rules"])),[[X,m(f)]])]),_:1},8,["modelValue","title"])}}}),fe=oe(ce,[["__scopeId","data-v-72737897"]]);export{fe as default};

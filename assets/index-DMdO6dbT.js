
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{d as X,m as C,r as I,u as Y,c as Z,n as ee,a as p,q as le,s as L,i as d,o as _,e as D,w as c,f as n,g as V,b,t as h,F as S,y as g,z as ae,aq as P,E as q,L as se}from"./index-v-7i03E1.js";import{a as B}from"./survey_vip_department-BwA1VKLo.js";const oe={class:"mr"},te={class:"mr checkbox-container"},ne={class:"centers mr"},ue={class:"center mr"},re={class:"center mr"},ie=X({__name:"index",props:C({parentId:{default:""},id:{default:""},tree:{},row:{},name:{}},{modelValue:{type:Boolean,default:!1},modelModifiers:{}}),emits:C(["getList"],["update:modelValue"]),setup(U,{emit:F}){const x=I([]),f=U,M=[{label:"完成计提",value:1},{label:"审核计提",value:2},{label:"结算计提",value:3}],N=[{label:"按项目价",value:1},{label:"按成本价",value:2},{label:"按毛利润",value:3}],v=I(!1),O=F,k=Y(U,"modelValue"),j=Z(()=>f.id===""?"新增子部门":"编辑子部门"),m=I([]),z=I(),l=I({parentId:f.parentId,name:"",remark:"",userIdList:[],organizationalStructurePersonList:[],superior:""}),R=I({name:[{required:!0,message:"请输入部门名称"}],commissionType:[{required:!0,message:"请选择计提方式",trigger:"change"}]});async function A(){try{z.value&&z.value.validate(async t=>{if(t){v.value=!0,l.value.organizationalStructurePersonList=[],m.value.forEach(e=>{if(e.userId){const r={id:e.id,userId:e.userId,commission:e.commission,commissionTime:e.commissionTime,commissionStatus:e.commissionStatus,commissionType:e.commissionType};l.value.organizationalStructurePersonList.push(r)}else{const r={userId:e.id,commission:e.commission,commissionTime:e.commissionTime,commissionStatus:e.commissionStatus,commissionType:e.commissionType};l.value.organizationalStructurePersonList.push(r)}});const s=l.value.organizationalStructurePersonList.reduce((e,r)=>(e.some(y=>y.userId===r.userId)||e.push(r),e),[]);l.value.organizationalStructurePersonList=s;const o={...l.value};if(delete o.userIdList,delete o.superior,l.value.id){const{status:e}=await B.edit(o);e===1&&q.success({message:"编辑成功",center:!0}),v.value=!1}else{const{status:e}=await B.create(o);e===1&&q.success({message:"新增成功",center:!0}),v.value=!1}await O("getList"),E()}})}catch{}finally{v.value=!1}}const J=t=>{if(t.userId){const e=l.value.userIdList.indexOf(t.userId);e!==-1&&l.value.userIdList.splice(e,1)}else{const e=l.value.userIdList.indexOf(t.id);e!==-1&&l.value.userIdList.splice(e,1)}const s=l.value.organizationalStructurePersonList.findIndex(e=>e.id===t.id||e.userId===t.id);s!==-1&&l.value.organizationalStructurePersonList.splice(s,1);const o=m.value.findIndex(e=>e.id===t.id||e.userId===t.id);o!==-1&&m.value.splice(o,1)},$=t=>{var s;if(l.value.userIdList=t,m.value=x.value.filter(o=>{var e;return(e=l.value)==null?void 0:e.userIdList.includes(o.id)}),(s=l.value)!=null&&s.userIdList.length){const o=[];l.value.organizationalStructurePersonList.forEach(i=>{o.push(i)}),m.value.forEach(i=>{l.value.organizationalStructurePersonList.some(w=>w.userId===i.id)||o.push(i)});const r=Array.from(new Map(o.map(i=>[i.id,i])).values()).filter(i=>t.includes(i.id));m.value=r,l.value.organizationalStructurePersonList=m.value}else m.value=[],l.value.organizationalStructurePersonList=m.value};function E(){Object.assign(l,{parentId:"",name:"",remark:"",userIdList:[],organizationalStructurePersonList:[],superior:""}),k.value=!1}const G=()=>x.value.filter(t=>{var s;return(s=l.value)==null?void 0:s.userIdList.includes(t.id)});return f.parentId&&(l.value.superior=f.name),ee(async()=>{try{if(v.value=!0,f.id!==""){const{id:t,name:s,remark:o,organizationalStructurePersonList:e}=JSON.parse(f.row);l.value.id=t,l.value.name=s,l.value.remark=o,l.value.organizationalStructurePersonList=e,e.forEach(r=>{l.value.userIdList.push(r.userId)})}m.value=G(),l.value.id&&(m.value=l.value.organizationalStructurePersonList),v.value=!1}catch{}finally{v.value=!1}}),(t,s)=>{const o=p("ElInput"),e=p("ElFormItem"),r=p("el-option"),i=p("el-select"),y=p("el-tag"),w=p("el-text"),H=p("el-switch"),K=p("ElForm"),T=p("ElButton"),Q=p("ElDialog"),W=le("loading");return L((_(),D(Q,{modelValue:k.value,"onUpdate:modelValue":s[4]||(s[4]=a=>k.value=a),title:d(j),style:{width:"48rem"},"close-on-click-modal":!1,"append-to-body":"","destroy-on-close":"",onClosed:E},{footer:c(()=>[n(T,{size:"large",onClick:E},{default:c(()=>[V(" 取消 ")]),_:1}),n(T,{type:"primary",size:"large",onClick:A},{default:c(()=>[V(" 确定 ")]),_:1})]),default:c(()=>[n(K,{ref_key:"formRef",ref:z,model:d(l),rules:d(R),"label-width":"7rem"},{default:c(()=>[n(e,{label:"上级部门",prop:""},{default:c(()=>[n(o,{modelValue:d(l).superior,"onUpdate:modelValue":s[0]||(s[0]=a=>d(l).superior=a),disabled:!!f.parentId,placeholder:"请输入部门名称",clearable:""},null,8,["modelValue","disabled"])]),_:1}),n(e,{label:"部门名称",prop:"name"},{default:c(()=>[n(o,{modelValue:d(l).name,"onUpdate:modelValue":s[1]||(s[1]=a=>d(l).name=a),placeholder:"请输入部门名称",clearable:""},null,8,["modelValue"])]),_:1}),n(e,{label:"部门主管",prop:""},{default:c(()=>[n(i,{modelValue:d(l).userIdList,"onUpdate:modelValue":s[2]||(s[2]=a=>d(l).userIdList=a),"value-key":"",placeholder:"请选择部门主管",multiple:"","collapse-tags":"","collapse-tags-tooltip":"",clearable:"",filterable:"",onChange:$},{default:c(()=>[(_(!0),b(S,null,h(d(x),a=>(_(),D(r,{key:a.value,label:a.userName,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),n(e,{label:"备注"},{default:c(()=>[n(o,{modelValue:d(l).remark,"onUpdate:modelValue":s[3]||(s[3]=a=>d(l).remark=a),placeholder:"请输入备注",clearable:""},null,8,["modelValue"])]),_:1}),(_(!0),b(S,null,h(d(m),a=>(_(),b("div",{key:a.id,class:"user"},[g("div",oe,[n(y,{type:"primary",closable:"",onClose:u=>J(a)},{default:c(()=>[V(ae(a.userName),1)]),_:2},1032,["onClose"])]),g("div",te,[n(w,{style:{width:"4.375rem"}},{default:c(()=>[V("开启提成")]),_:1}),n(H,{modelValue:a.commissionStatus,"onUpdate:modelValue":u=>a.commissionStatus=u,"active-value":1,"inactive-value":2,"inline-prompt":"","active-text":"开启","inactive-text":"关闭"},null,8,["modelValue","onUpdate:modelValue"])]),L(g("div",ne,[n(i,{modelValue:a.commissionType,"onUpdate:modelValue":u=>a.commissionType=u,"value-key":"",placeholder:"计提方式",clearable:"",filterable:""},{default:c(()=>[(_(),b(S,null,h(N,u=>n(r,{key:u.value,label:u.label,value:u.value},null,8,["label","value"])),64))]),_:2},1032,["modelValue","onUpdate:modelValue"])],512),[[P,a.commissionStatus===1]]),L(g("div",ue,[n(i,{class:"select",modelValue:a.commissionTime,"onUpdate:modelValue":u=>a.commissionTime=u,"value-key":"",placeholder:"计提时间",clearable:"",filterable:""},{default:c(()=>[(_(),b(S,null,h(M,u=>n(r,{key:u.value,label:u.label,value:u.value},null,8,["label","value"])),64))]),_:2},1032,["modelValue","onUpdate:modelValue"])],512),[[P,a.commissionStatus===1]]),L(g("div",re,[n(o,{modelValue:a.commission,"onUpdate:modelValue":u=>a.commission=u,placeholder:"提成比例",style:{"max-width":"25rem"},clearable:""},null,8,["modelValue","onUpdate:modelValue"])],512),[[P,a.commissionStatus===1]])]))),128))]),_:1},8,["model","rules"])]),_:1},8,["modelValue","title"])),[[W,d(v)]])}}}),me=se(ie,[["__scopeId","data-v-91019121"]]);export{me as default};

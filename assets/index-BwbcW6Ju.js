
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{a as O}from"./group_team-CfCychTM.js";import{a as ie}from"./department-5U7R4aET.js";import{u as ce}from"./department-PrZeUXLr.js";import{u as fe}from"./configuration_manager-C7Zu0kif.js";import{u as me}from"./position_manage-B8GclhF_.js";import{d as pe,aO as _e,r as u,l as ve,b as c,q as he,s as ge,o as d,e as k,g as s,w as e,t as U,h as v,j as be,aN as Ie,f as p,H as g,F as V,v as N,k as C,E as $,aI as ye,aJ as ke,R as we}from"./index-B9wLryVD.js";import"./position_manage-Di8AxlvS.js";const xe=w=>(ye("data-v-f47cfd37"),w=w(),ke(),w),Se=xe(()=>U("div",{class:"card-header"},[U("span",null,"组成员")],-1)),Ve={style:{flex:"auto"}},Ne=pe({name:"Edit",__name:"index",emits:["success"],setup(w,{expose:z,emit:J}){_e();const B=u(),q=u(),E=me(),M=u(),A=ce(),b=u(),G=fe(),L=u([]),K=J,T=u(""),Q=u(),I=u(!1);u([]);const D=u(),y=u(!1),_=u([]),j=u([]),R=u();u({loading:!1,tableAutoHeight:!1,border:!0,stripe:!1,lineHeight:"default",checkList:[],search:{chineseName:""},dataList:[],selectionDataList:[],row:"",dialog:{visible:!1,id:"",parentId:"",level:1}});const x=u(null),f=u({groupId:null,userInfo:[],menuId:[]}),W={children:"children",label:"name"},X=u({commission:[{validator:(a,n,o)=>{/^[0-9]*[.]?[0-9]+$/.test(n)?o():o(new Error("请输入有效的数字或小数"))},trigger:"blur"}]});async function Y(a){try{I.value=!0,T.value=a!=null&&a.id?"编辑":"新增";const n=JSON.parse(a);f.value.groupId=n.id,R.value=n.departmentId;const o={page:1,limit:10,groupId:n.id},m=await O.list(o);m!=null&&m.data.data&&m.data.data.forEach(t=>{var h,S;(S=(h=f.value)==null?void 0:h.menuId)==null||S.push(t.id),_.value.push(t)});const r=await ie.createEvery();b.value=r.data.result,b.value=b.value.filter(t=>t.id===R.value),I.value=!1,y.value=!0}catch{}finally{I.value=!1}}const Z=()=>{x&&(_.value=b.value[0].children.filter(a=>a.userName.includes(x.value)))};ve(async()=>{M.value=await(E==null?void 0:E.getPositionManage())||[],b.value=await A.getDepartment(),L.value=await G.getStaff(),Q.value=new Date});function F(a,n){const o=a.findIndex(m=>m.memberId===n);o!==-1&&a.splice(o,1)}function P(a,n){a.some(o=>o.id===n.id)||a.push(n)}function ee(a){_.value=_.value.filter(o=>o.id!==a.id),B.value.getNode(a.id).checked?a.children&&a.children.length?a.children.forEach(o=>P(_.value,o)):P(_.value,a):a.children&&a.children.length?a.children.forEach(o=>F(_.value,o.id)):F(_.value,a.id)}function ae(){return new Promise(a=>{D.value&&D.value.validate(n=>{if(n)try{I.value=!0,f.value.userInfo=[],delete f.value.menuId;let o=0;j.value.forEach(r=>{r.commission&&(o+=r.commission);let t={userId:r.memberId,commission:r.commission};f.value.userInfo.push(t)}),_.value.forEach(r=>{r.commission&&(o+=r.commission);let t;r.memberId?t={userId:r.memberId,commission:r.commission}:t={userId:r.id,commission:r.commission},f.value.userInfo.push(t)});const m=new Set;if(f.value.userInfo=f.value.userInfo.filter(r=>{const{userId:t}=r;return m.has(t)?!1:(m.add(t),!0)}),o>100){$.warning({message:"提成比例不能超过100",center:!0});return}O.edit(f.value).then(()=>{I.value=!1,$.success({message:"操作成功",center:!0}),K("success"),y.value=!1,a()})}catch{}finally{I.value=!1}})})}const te=()=>{Object.assign(f.value,{groupId:null,userInfo:[],menuId:[]}),j.value=[],_.value=[]};return z({showEdit:Y}),(a,n)=>{const o=c("el-input"),m=c("el-tree"),r=c("el-col"),t=c("el-text"),h=c("el-table-column"),S=c("el-form-item"),le=c("el-form"),oe=c("el-empty"),ne=c("el-table"),se=c("el-row"),re=c("el-card"),H=c("el-button"),ue=c("el-drawer"),de=he("loading");return ge((d(),k("div",null,[s(ue,{modelValue:y.value,"onUpdate:modelValue":n[2]||(n[2]=l=>y.value=l),title:T.value,onClose:te,size:"60%"},{footer:e(()=>[U("div",Ve,[s(H,{type:"",onClick:n[1]||(n[1]=l=>y.value=!1)},{default:e(()=>[v(" 取消 ")]),_:1}),s(H,{type:"primary",onClick:ae},{default:e(()=>[v(" 确定 ")]),_:1})])]),default:e(()=>[s(re,{class:"box-card"},{header:e(()=>[Se]),default:e(()=>[s(se,{gutter:20},{default:e(()=>[s(r,{class:"leftData",span:8},{default:e(()=>[s(o,{modelValue:x.value,"onUpdate:modelValue":n[0]||(n[0]=l=>x.value=l),placeholder:"可输入用户名查找",clearable:"",onBlur:Z},null,8,["modelValue"]),s(m,{style:{"max-width":"37.5rem","min-height":"20.125rem","margin-top":"20px"},data:b.value,ref_key:"treeRef",ref:B,"show-checkbox":"","node-key":"id","default-checked-keys":f.value.menuId,"default-expanded-keys":f.value.menuId,"default-expand-all":"",props:W,onCheck:ee},null,8,["data","default-checked-keys","default-expanded-keys"])]),_:1}),s(r,{span:16},{default:e(()=>[s(ne,{ref_key:"tableRef",ref:q,data:_.value,border:""},{empty:e(()=>[s(oe,{image:be(Ie),"image-size":300},null,8,["image"])]),default:e(()=>[s(h,{align:"center","show-overflow-tooltip":"",prop:"memberId",label:"员工ID"},{default:e(({row:l})=>[l.id?(d(),p(t,{key:0},{default:e(()=>[v(g(l.id),1)]),_:2},1024)):(d(),p(t,{key:1},{default:e(()=>[v(g(l.id),1)]),_:2},1024))]),_:1}),s(h,{align:"center","show-overflow-tooltip":"",prop:"userName",label:"用户名"},{default:e(({row:l})=>[l.id?(d(!0),k(V,{key:0},N(L.value,i=>(d(),p(t,null,{default:e(()=>[l.id===i.id?(d(),p(t,{key:0},{default:e(()=>[v(g(i.name),1)]),_:2},1024)):C("",!0)]),_:2},1024))),256)):(d(),p(t,{key:1},{default:e(()=>[v(g(l.userName?l.userName:"-"),1)]),_:2},1024))]),_:1}),s(h,{align:"center","show-overflow-tooltip":"",prop:"name",label:"姓名"},{default:e(({row:l})=>[l.id?(d(!0),k(V,{key:0},N(L.value,i=>(d(),p(t,null,{default:e(()=>[l.id===i.id?(d(),p(t,{key:0},{default:e(()=>[v(g(i.name),1)]),_:2},1024)):C("",!0)]),_:2},1024))),256)):(d(),p(t,{key:1},{default:e(()=>[v(g(l.name),1)]),_:2},1024))]),_:1}),s(h,{align:"center","show-overflow-tooltip":"",prop:"lable",label:"职位"},{default:e(({row:l})=>[(d(!0),k(V,null,N(M.value,i=>(d(),p(t,null,{default:e(()=>[l.positionId===i.id?(d(),p(t,{key:0},{default:e(()=>[v(g(i.name),1)]),_:2},1024)):C("",!0)]),_:2},1024))),256))]),_:1}),s(h,{align:"center","show-overflow-tooltip":"",prop:"lable",label:"部门"},{default:e(({row:l})=>[(d(!0),k(V,null,N(b.value,i=>(d(),p(t,null,{default:e(()=>[R.value===i.id?(d(),p(t,{key:0},{default:e(()=>[v(g(i.name),1)]),_:2},1024)):C("",!0)]),_:2},1024))),256))]),_:1}),s(h,{align:"center",width:"200",fixed:"right","show-overflow-tooltip":"",label:"提成比例"},{default:e(({row:l})=>[s(le,{model:l,ref_key:"formRef",ref:D,rules:X.value},{default:e(()=>[s(S,{prop:"commission"},{default:e(()=>[s(o,{modelValue:l.commission,"onUpdate:modelValue":i=>l.commission=i,modelModifiers:{number:!0},placeholder:"请输入提成比例",clearable:""},{append:e(()=>[v("%")]),_:2},1032,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1032,["model","rules"])]),_:1})]),_:1},8,["data"])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue","title"])])),[[de,I.value]])}}}),Me=we(Ne,[["__scopeId","data-v-f47cfd37"]]);export{Me as default};

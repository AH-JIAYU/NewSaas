
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{d as be,r as n,n as je,a as h,q as ke,o as f,b as L,f as s,w as o,y as v,g as c,s as Ae,i as t,e as x,aJ as K,j as _,F as W,t as Q,A as Ce,E as X,_ as Ve,aH as Te,aI as xe,L as we}from"./index-DBquyRqD.js";import{_ as Ee,a as Pe}from"./he-DTzj0YDI.js";import{_ as $,a as Ne}from"./jiantou-r_GPOlIm.js";import{o as w,s as Ue}from"./apiLoading-DYbTnkTt.js";import{a as Y}from"./projectManagement-DQVZcHOa.js";import{a as Z}from"./user_cooperation-D2Ajw8pi.js";import{a as ee}from"./survey_vip_department-DpUBA-rJ.js";import{U as De}from"./user_supplier-BQJHo8MA.js";import{u as Re}from"./survey_vipGroup-BOaysFCm.js";import Be from"./index-OSkSr3C5.js";import Oe from"./index-DIsh-9s2.js";import Ke from"./index-BXF44J1t.js";import"./user_supplier-B8L4bgCw.js";import"./survey_vipGroup-CGemg1ad.js";import"./index.vue_vue_type_script_setup_true_lang-Ce4ekk3D.js";import"./index-DXnHkjDy.js";import"./index-C2iEz3U5.js";import"./configuration_supplierLevel-BtnFUB3D.js";import"./user_customer-CUm-SN7U.js";import"./user_customer-BNwYSVA4.js";import"./stagedData-hpNl18AS.js";import"./index-CBu-WCdw.js";import"./index-B3qu4jXu.js";import"./index-B5bL-PXH.js";import"./clipboard-DagmydnP.js";import"./department-CsL0sFM3.js";const A=E=>(Te("data-v-927508ba"),E=E(),xe(),E),$e=A(()=>v("span",{class:"icon-class"},[v("img",{src:Ee,alt:"",style:{"margin-right":"0.25rem"}}),c(" 供应商")],-1)),Fe={key:0,class:"prefix-class"},ze=A(()=>v("img",{src:$,alt:"",style:{"margin-left":"0.25rem"}},null,-1)),He={key:1},Je=A(()=>v("span",{class:"icon-class"},[v("img",{src:Ne,alt:"",style:{"margin-right":"0.25rem"}}),c(" 调查站")],-1)),Me={key:0,class:"prefix-class"},qe=A(()=>v("img",{src:$,alt:"",style:{"margin-left":"0.25rem"}},null,-1)),Ge={key:1},We=A(()=>v("span",{class:"icon-class"},[v("img",{src:Pe,alt:"",style:{"margin-right":"0.25rem"}}),c(" 合作商")],-1)),Qe={key:0,class:"prefix-class"},Xe=A(()=>v("img",{src:$,alt:"",style:{"margin-left":"0.25rem"}},null,-1)),Ye={key:1},Ze={style:{flex:"auto"}},el=be({name:"AllocationEdit",__name:"index",emits:["fetch-data"],setup(E,{expose:le,emit:te}){const F=De();Re();const ae=te,P=n(!1),C=n(!1),D=n(),j=n(),k=n([]),oe={children:"children",label:"name"};n([]);const e=n({title:"分配",list:[],tenantSupplierList:[],departmentList:[],tenantList:[],form:{projectId:"",allocationType:1,groupSupplierIdList:[],deleteSet:[]},selectAll:{supplier:!1,member:!1,tenant:!1}}),m=n({projectId:null,allocationType:4,groupSupplierIdList:[],deleteSet:[]}),g=n({projectId:null,allocationType:2,groupSupplierIdList:[],deleteSet:[]}),p=n({projectId:null,allocationType:3,groupSupplierIdList:[],deleteSet:[]}),ie=n({groupSupplierIdList:[{type:"array",required:!0,trigger:"change",message:"请选择分配目标"}]}),R=n([]),N=n();async function se(a,l){if(e.value.list=[{...a}],l==="reassign"){e.value.title="重新分配";const y=await w(Y.getProjectAllocation({projectId:a.projectId}));e.value.form.projectId=a.projectId;const{getProjectAllocationInfoList:b}=y.data;b.forEach(r=>{r.allocationType===2?g.value={allocationType:r.allocationType,projectId:r.projectId,groupSupplierIdList:r.groupSupplierIdSet}:r.allocationType===3?p.value={allocationType:r.allocationType,projectId:r.projectId,groupSupplierIdList:r.groupSupplierIdSet}:r.allocationType===4&&(m.value={allocationType:r.allocationType,projectId:r.projectId,groupSupplierIdList:r.groupSupplierIdSet},N.value=r.groupSupplierIdSet)})}else e.value.title="分配",e.value.form.projectId=a.projectId,m.value.projectId=a.projectId,g.value.projectId=a.projectId,p.value.projectId=a.projectId;e.value.tenantSupplierList=await w(F.getTenantSupplierList(a.projectId)),e.value.tenantSupplierList.length==g.value.groupSupplierIdList.length?e.value.selectAll.supplier=!0:e.value.selectAll.supplier=!1;const d=await ee.list({name:""});e.value.departmentList=d.data;const S=JSON.parse(JSON.stringify(d.data));R.value=z(S),R.value.length==p.value.groupSupplierIdList.length?e.value.selectAll.member=!0:e.value.selectAll.member=!1;const u=await w(Z.getAllocationBindList({projectId:a.projectId}));k.value=[],e.value.form.groupSupplierIdList&&e.value.form.allocationType===3&&(k.value=e.value.form.groupSupplierIdList),e.value.tenantList=u.data.allocationBindInfoList,e.value.tenantList.length==m.value.groupSupplierIdList.length?e.value.selectAll.tenant=!0:e.value.selectAll.tenant=!1,C.value=!0}const z=a=>a.reduce((l,d)=>{const{children:S,...u}=d;return l.push(u),d.children&&d.children.length>0&&(l=l.concat(z(d.children))),l},[]);function re(){m.value.groupSupplierIdList=[],e.value.selectAll.tenant&&e.value.tenantList.map(a=>{m.value.groupSupplierIdList.push(a.beInvitationTenantId)})}function ne(){g.value.groupSupplierIdList=[],e.value.selectAll.supplier&&e.value.tenantSupplierList.map(a=>{g.value.groupSupplierIdList.push(a.tenantSupplierId)})}const pe=()=>{e.value.tenantSupplierList.length==g.value.groupSupplierIdList.length?e.value.selectAll.supplier=!0:e.value.selectAll.supplier=!1},ue=()=>{e.value.tenantList.length==m.value.groupSupplierIdList.length?e.value.selectAll.tenant=!0:e.value.selectAll.tenant=!1},de=()=>{p.value.groupSupplierIdList=[],e.value.departmentList.forEach(a=>{H(a)}),j.value.setCheckedKeys(p.value.groupSupplierIdList)};function H(a){p.value.groupSupplierIdList.push(a.id),a.children&&a.children.length&&a.children.forEach(l=>{H(l)})}function ce(){p.value.groupSupplierIdList=[],e.value.selectAll.member?(de(),j.value.setCheckedKeys(p.value.groupSupplierIdList)):(e.value.selectAll.member=!1,p.value.groupSupplierIdList=[],j.value.setCheckedKeys([]))}const fe=(a,l)=>{l?k.value.includes(a.id)||k.value.push(a.id):k.value=k.value.filter(y=>y!==a.id);const d=j.value.getCheckedKeys(),S=j.value.getHalfCheckedKeys(),u=[...d,...S];p.value.groupSupplierIdList=u,R.value.length==u.length?e.value.selectAll.member=!0:e.value.selectAll.member=!1},V=n(!1),T=n(!1),me=()=>{T.value=!T.value,J(),T.value?V.value=!0:V.value=!1},J=()=>{Object.assign(m.value,{projectId:null,allocationType:4,groupSupplierIdList:[],deleteSet:[]}),Object.assign(g.value,{projectId:null,allocationType:2,groupSupplierIdList:[],deleteSet:[]}),Object.assign(p.value,{projectId:null,allocationType:3,groupSupplierIdList:[],deleteSet:[]}),e.value.selectAll.tenant=!1,e.value.selectAll.supplier=!1,e.value.selectAll.member=!1};function B(){D.value.resetFields(),J(),C.value=!1,V.value=!1,T.value=null}function ge(){D.value.validate(async a=>{if(a)try{P.value=!0;let l={addProjectAllocationInfoList:[]};if(m.value.groupSupplierIdList.length&&(m.value.projectId=e.value.form.projectId,l.addProjectAllocationInfoList.push(m.value)),g.value.groupSupplierIdList.length&&(g.value.projectId=e.value.form.projectId,l.addProjectAllocationInfoList.push(g.value)),p.value.groupSupplierIdList.length&&(p.value.projectId=e.value.form.projectId,l.addProjectAllocationInfoList.push(p.value)),e.value.title!=="分配")l.addProjectAllocationInfoList.length||(V.value=!0),l.addProjectAllocationInfoList.map(u=>{u.projectId||(u.projectId=e.value.form.projectId),u.allocationType===4&&(u.deleteSet=[],N.value&&N.value.length&&N.value.filter(y=>{u.groupSupplierIdList.map(b=>{y!==b&&u.deleteSet.push(y)})}))});else if(!l.addProjectAllocationInfoList.length){X.warning({message:"至少选择一个分配目标",center:!0});return}let d="分配成功";V.value&&(d="取消分配成功",l={addProjectAllocationInfoList:[{projectId:e.value.form.projectId,allocationType:5,groupSupplierIdList:[],deleteSet:[]}]});const{status:S}=await Ue(Y.allocation(l));P.value=!1,S===1&&X.success({message:d,center:!0}),B(),ae("fetch-data")}catch{}finally{P.value=!1}})}n();const I=n({search:{name:""},tree:[],currentNode:void 0,currentData:void 0,dialog:{visible:!1,parentId:"",id:"",isClick:!1},row:"",loading:!1}),M=n(),q=n(),O=(a,l)=>{a=="供应商"?M.value.showEdit():a=="调查站"?(I.value.currentData=l,I.value.dialog.parentId="",I.value.dialog.id="",I.value.dialog.visible=!0):a=="合作商"&&q.value.showEdit()},ve=async()=>{e.value.tenantSupplierList=await w(F.getTenantSupplierList(e.value.form.projectId))},Ie=async()=>{const a=await ee.list({name:""});e.value.departmentList=a.data},he=async()=>{const a=await w(Z.getAllocationBindList({projectId:e.value.form.projectId}));e.value.tenantList=a.data.allocationBindInfoList};return je(async()=>{}),le({showEdit:se}),(a,l)=>{const d=h("el-table-column"),S=h("el-table"),u=h("el-checkbox"),y=h("el-option"),b=Ve,r=h("el-button"),G=h("el-select"),U=h("el-form-item"),ye=h("el-tree-select"),Le=h("el-form"),Se=h("el-dialog"),_e=ke("loading");return f(),L("div",null,[s(Se,{modelValue:t(C),"onUpdate:modelValue":l[10]||(l[10]=i=>Ce(C)?C.value=i:null),title:t(e).title,width:"700","before-close":B},{footer:o(()=>[v("div",Ze,[s(r,{onClick:B},{default:o(()=>[c(" 取消 ")]),_:1}),s(r,{type:"primary",onClick:ge},{default:o(()=>[c(" 确定 ")]),_:1})])]),default:o(()=>[Ae((f(),x(S,{data:t(e).list,"row-key":"id"},{default:o(()=>[s(d,{align:"left","show-overflow-tooltip":"",label:"项目名称",prop:"name"}),s(d,{align:"left","show-overflow-tooltip":"",label:"项目编码",prop:"projectId"}),s(d,{align:"left","show-overflow-tooltip":"",label:"客户简称",width:"100",prop:"clientName"})]),_:1},8,["data"])),[[_e,t(P)]]),s(Le,{ref_key:"formRef",ref:D,"label-width":"90px",rules:t(ie),model:t(e).form,inline:!1,"label-position":"left",prop:"groupSupplierIdList"},{default:o(()=>[s(U,{style:{"margin-top":"1rem"}},{label:o(()=>[$e]),default:o(()=>[s(G,{modelValue:t(g).groupSupplierIdList,"onUpdate:modelValue":l[2]||(l[2]=i=>t(g).groupSupplierIdList=i),clearable:"",filterable:"",multiple:"","collapse-tags":"","collapse-tags-tooltip":"","max-collapse-tags":10,placeholder:"",onChange:pe},K({prefix:o(()=>[t(e).tenantSupplierList.length==0?(f(),L("span",Fe,[c(" 请先维护供应商数据 "),ze])):_("",!0),t(g).groupSupplierIdList.length==0&&t(e).tenantSupplierList.length!=0?(f(),L("span",He,"请先选择供应商数据")):_("",!0)]),empty:o(()=>[v("div",null,[s(r,{type:"primary",link:"",class:"buttonClass",size:"small",onClick:l[1]||(l[1]=i=>O("供应商"))},{default:o(()=>[c(" 快捷新增 "),s(b,{name:"ant-design:plus-outlined",color:"#fff",style:{"background-color":"var(--el-color-primary)","border-radius":"50%",padding:"0.125rem",margin:"0 0.125rem"}})]),_:1})])]),default:o(()=>[(f(!0),L(W,null,Q(t(e).tenantSupplierList,i=>(f(),x(y,{label:i.supplierAccord,key:i.supplierAccord,value:i.tenantSupplierId},null,8,["label","value"]))),128))]),_:2},[t(e).tenantSupplierList.length?{name:"header",fn:o(()=>[s(u,{modelValue:t(e).selectAll.supplier,"onUpdate:modelValue":l[0]||(l[0]=i=>t(e).selectAll.supplier=i),onChange:ne,style:{display:"flex",height:"unset"}},{default:o(()=>[c("全选")]),_:1},8,["modelValue"])]),key:"0"}:void 0]),1032,["modelValue"])]),_:1}),s(U,null,{label:o(()=>[Je]),default:o(()=>[s(ye,{ref_key:"treeRef",ref:j,modelValue:t(p).groupSupplierIdList,"onUpdate:modelValue":l[5]||(l[5]=i=>t(p).groupSupplierIdList=i),data:t(e).departmentList,"show-checkbox":"","default-expand-all":"","node-key":"id",props:oe,onCheckChange:fe,"check-strictly":!0,"check-on-click-node":!0,multiple:!0,"expand-on-click-node":!1,style:{width:"37.625rem"},clearable:"",placeholder:""},K({prefix:o(()=>[t(e).departmentList.length==0?(f(),L("span",Me,[c(" 请先维护调查站数据 "),qe])):_("",!0),!t(p).groupSupplierIdList.length&&t(e).departmentList.length!=0?(f(),L("span",Ge,"请先选择调查站数据")):_("",!0)]),empty:o(()=>[v("div",null,[s(r,{type:"primary",link:"",class:"buttonClass",size:"small",onClick:l[4]||(l[4]=i=>O("调查站"))},{default:o(()=>[c(" 快捷新增 "),s(b,{name:"ant-design:plus-outlined",color:"#fff",style:{"background-color":"var(--el-color-primary)","border-radius":"50%",padding:"0.125rem",margin:"0 0.125rem"}})]),_:1})])]),_:2},[t(e).departmentList.length?{name:"header",fn:o(()=>[s(u,{modelValue:t(e).selectAll.member,"onUpdate:modelValue":l[3]||(l[3]=i=>t(e).selectAll.member=i),onChange:ce,style:{display:"flex",height:"unset"}},{default:o(()=>[c("全选")]),_:1},8,["modelValue"])]),key:"0"}:void 0]),1032,["modelValue","data"])]),_:1}),s(U,null,{label:o(()=>[We]),default:o(()=>[s(G,{modelValue:t(m).groupSupplierIdList,"onUpdate:modelValue":l[8]||(l[8]=i=>t(m).groupSupplierIdList=i),clearable:"",filterable:"",multiple:"","collapse-tags":"","collapse-tags-tooltip":"","max-collapse-tags":10,placeholder:"",onChange:ue},K({prefix:o(()=>[t(e).tenantList.length==0?(f(),L("span",Qe,[c(" 请先维护合作商数据 "),Xe])):_("",!0),t(m).groupSupplierIdList.length==0&&t(e).tenantList.length!=0?(f(),L("span",Ye,"请先选择合作商数据")):_("",!0)]),empty:o(()=>[v("div",null,[s(r,{type:"primary",link:"",class:"buttonClass",size:"small",onClick:l[7]||(l[7]=i=>O("合作商"))},{default:o(()=>[c(" 快捷新增 "),s(b,{name:"ant-design:plus-outlined",color:"#fff",style:{"background-color":"var(--el-color-primary)","border-radius":"50%",padding:"0.125rem",margin:"0 0.125rem"}})]),_:1})])]),default:o(()=>[(f(!0),L(W,null,Q(t(e).tenantList,i=>(f(),x(y,{label:i.beInvitationTenantName,key:i.beInvitationTenantName,value:i.beInvitationTenantId},null,8,["label","value"]))),128))]),_:2},[t(e).tenantList.length?{name:"header",fn:o(()=>[s(u,{modelValue:t(e).selectAll.tenant,"onUpdate:modelValue":l[6]||(l[6]=i=>t(e).selectAll.tenant=i),onChange:re,style:{display:"flex",height:"unset"}},{default:o(()=>[c("全选")]),_:1},8,["modelValue"])]),key:"0"}:void 0]),1032,["modelValue"])]),_:1}),t(e).title=="重新分配"?(f(),x(U,{key:0},{label:o(()=>[s(r,{type:t(T)?"primary":"",onClick:l[9]||(l[9]=i=>me()),style:{"border-radius":"1.875rem"}},{default:o(()=>[c(" 取消分配 ")]),_:1},8,["type"])]),_:1})):_("",!0)]),_:1},8,["rules","model"])]),_:1},8,["modelValue","title"]),s(Oe,{ref_key:"editRef",ref:M,onFetchData:ve},null,512),t(I).dialog.visible?(f(),x(Be,{key:0,id:t(I).dialog.id,modelValue:t(I).dialog.visible,"onUpdate:modelValue":l[11]||(l[11]=i=>t(I).dialog.visible=i),row:t(I).row,"parent-id":t(I).dialog.parentId,tree:t(I).tree,isClick:t(I).dialog.isClick,onGetList:Ie},null,8,["id","modelValue","row","parent-id","tree","isClick"])):_("",!0),s(Ke,{ref_key:"tenantRef",ref:q,onFetchData:he},null,512)])}}}),Cl=we(el,[["__scopeId","data-v-927508ba"]]);export{Cl as default};

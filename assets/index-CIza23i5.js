
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{d as $,aD as F,l as G,r as l,X as D,Z as y,n as J,a as C,q as K,o as S,b as W,f as d,w as p,y as ee,s as T,ao as x,g,z as te,i as w,e as ae,j as oe,N as re,ap as m,E as b,_ as ie,L as se}from"./index-DblQ9bv_.js";import ne from"./index-Bal_wlSW.js";import{u as le}from"./projectManagement_list-Cr0KSqMx.js";import{u as ce}from"./stagedData-HblON5zR.js";import{u as ue}from"./user_customer-Cy9R7uwN.js";import{a as _}from"./projectManagement-BzVmr2Ch.js";import"./index-Bxr62pPF.js";import"./user_customer-Cn2_S8uF.js";import"./file-B7qFtOJa.js";import"./index-DlpX678-.js";import"./zh_Hans-D6UzZbQM.js";import"./zh_Hans-B39mJ-rS.js";import"./index-BqWm9b3r.js";import"./index.vue_vue_type_script_setup_true_lang-eW2kEqb8.js";import"./index-Bn_WdWQ7.js";import"./index-C-yhvVF2.js";import"./index-C9mAI_fA.js";import"./index-ua5ETpJ7.js";import"./department-DGtbt5xG.js";import"./position_manage-D4Yht68i.js";import"./configuration_role-DjgaW6-t.js";import"./tenant_role-BB7Ubv9R.js";import"./configuration_manager-wcebkGtq.js";import"./configuration_siteSetting-Dvs2st6d.js";import"./configuration_site_setting-Qx5Wg-wB.js";import"./apiLoading-bn_2S6uh.js";import"./index.vue_vue_type_script_setup_true_lang-B5hDsjc5.js";const de={class:"flex-c"},pe=$({name:"ProjeckEdit",__name:"index",emits:["fetch-data"],setup(fe,{expose:k,emit:E}){const s=F(),v=le(),j=ce(),V=G(),R=ue(),U=E,f=l(!1),n=l(""),i=l(!1),c=l([]),L=l(""),u=l([]);function M(e){c.value.push(e)}function A(e){L.value=e}D("validateTopTabs",M),D("currentProjectTimeline",A);let r=y([]);const P=l();async function B(e){try{if(i.value=!0,e){n.value="编辑";const a=await _.detail({projectId:e.projectId});N(a.data)}else{n.value="新增";const a=m(v.initialTopTabsData);r=j.projectManagementList||y([a])}f.value=!0,u.value=[],c.value=[],i.value=!1}catch{}finally{i.value=!1}}function N(e){e.data={configurationInformation:{initialProblem:{countryId:null,projectProblemCategoryId:null,projectQuotaQuestionType:null,projectProblemId:null,keyValue:"",questionType:null,answerValueList:[],projectAnswerIdList:[]},configurationCountryList:null,projectCategoryList:null,ProjectProblemInfoList:[]}},r=[];const{projectInfoList:a,...t}=m(e);t.descriptionUrl?t.descriptionUrl=t.descriptionUrl.split(","):t.descriptionUrl=[],r.push(t),a&&a.length&&a.forEach(o=>{o.data={configurationInformation:{initialProblem:{countryId:null,projectProblemCategoryId:null,projectQuotaQuestionType:null,projectProblemId:null,keyValue:"",questionType:null,answerValueList:[],projectAnswerIdList:[]},configurationCountryList:null,projectCategoryList:null,ProjectProblemInfoList:[]}},o.descriptionUrl=o.descriptionUrl.split(","),r.push({...o})}),v.dataBeforeEditing=m(r)}function Q(){j.projectManagementList=m(r),r=y([]),f.value=!1,c.value=[]}async function h(){const e=[];c.value.forEach(t=>{e.push(t.validate())});const a=await Promise.allSettled(e);u.value=a.map(t=>t.status)}function z(e){const a=new Set;for(const t of e){if(a.has(t.name))return!0;a.add(t.name)}return!1}const q=async()=>{const e=m(r);await v.compareProjectData(v.dataBeforeEditing,e),await e.forEach(t=>{t.descriptionUrl=t.descriptionUrl.join(","),(!t.data.configurationInformation.ProjectProblemInfoList||!t.data.configurationInformation.ProjectProblemInfoList.length)&&(t.isProfile=2),t.data&&delete t.data,t.projectQuotaInfoList=t.projectQuotaInfoList.map(o=>(Array.isArray(o.answerValueList)||(o.answerValueList=[]),Array.isArray(o.projectAnswerIdList)||(o.projectAnswerIdList=[]),o))});let a=e[0];return a.projectInfoList=e.slice(1),a};async function Y(){if(i.value=!0,await h(),u.value.every(e=>e==="fulfilled"))if(z(r))b({message:"项目名称重复",center:!0});else{const e=await q();setTimeout(async()=>{if(n.value==="新增"){s.currencyType===2&&e.currencyType==="CNY"||s.currencyType===1&&e.currencyType==="USD"?(e.exchangeRate=1,e.memberPrice=e.doMoneyPrice):s.currencyType===2&&e.currencyType==="USD"?(e.exchangeRate=s.originalExchangeRate,e.memberPrice=e.doMoneyPrice*s.originalExchangeRate):s.currencyType===1&&e.currencyType==="CNY"&&(e.exchangeRate=s.originalExchangeRate,e.memberPrice=e.doMoneyPrice/s.originalExchangeRate);const{status:a}=await _.create(e);a===1&&b.success({message:"新增成功",center:!0})}else{const{status:a}=await _.edit(e);a===1&&b.success({message:"编辑成功",center:!0})}U("fetch-data"),I()},1e3)}else P.value.activeLeftTab=u.value.indexOf("rejected"),b.warning({message:"请完善表单",center:!0});i.value=!1}function I(){r=y([]),u.value=[],c.value=[],f.value=!1,n.value==="新增"&&(j.projectManagementList=null)}const H=async()=>{await R.getCustomerList(),await V.getCountry()};return J(async()=>{await H()}),k({showEdit:B}),(e,a)=>{const t=ie,o=C("el-button"),O=C("el-drawer"),X=K("loading");return S(),W("div",null,[d(O,{modelValue:f.value,"onUpdate:modelValue":a[0]||(a[0]=Z=>f.value=Z),class:re(n.value==="新增"||w(r).length>1?"hide-drawer-header":"edit-drawer"),"append-to-body":"","close-on-click-modal":!1,"destroy-on-close":"",draggable:"",size:"70%"},{footer:p(()=>[ee("div",de,[T(d(o,{link:""},{default:p(()=>[d(t,{name:"ant-design:clock-circle-outlined"}),g("   "+te(L.value),1)]),_:1},512),[[x,L.value]]),d(o,{type:"primary",onClick:Y,disabled:i.value},{default:p(()=>[g(" 发布项目 ")]),_:1},8,["disabled"]),T(d(o,{type:"warning",onClick:Q,disabled:i.value},{default:p(()=>[g(" 暂存 ")]),_:1},8,["disabled"]),[[x,n.value!=="编辑"]]),d(o,{onClick:I,disabled:i.value},{default:p(()=>[g(" 取消 ")]),_:1},8,["disabled"])])]),default:p(()=>[w(r).length?T((S(),ae(ne,{key:0,onValidate:h,ref_key:"LeftTabsRef",ref:P,"left-tabs-data":w(r),"validate-top-tabs":c.value,"validate-all":u.value,title:n.value},null,8,["left-tabs-data","validate-top-tabs","validate-all","title"])),[[X,i.value]]):oe("",!0)]),_:1},8,["modelValue","class"])])}}}),ze=se(pe,[["__scopeId","data-v-675426fe"]]);export{ze as default};

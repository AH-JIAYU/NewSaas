
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{_ as Z,a as ee}from"./jiantou-BFtAGxsy.js";import{o as le,s as te}from"./apiLoading-B-0f9Z2R.js";import{a as K}from"./projectManagement-Bt348miG.js";import{a as oe}from"./survey_vip_department-CdBn_fQu.js";import{u as ae}from"./survey_vipGroup-CbHsFh2L.js";import{d as se,r as i,n as re,a as f,q as ie,o as h,b as w,f as c,w as r,y as L,g as v,s as ne,e as V,z as P,i as a,aJ as ue,j as k,A as ce,E as R,aH as pe,aI as de,L as fe}from"./index-Bn8qCMs0.js";import"./survey_vipGroup-ChIdQWCk.js";const O=b=>(pe("data-v-c4bba734"),b=b(),de(),b),me=O(()=>L("span",{class:"icon-class"},[L("img",{src:Z,alt:"",style:{"margin-right":"0.25rem"}}),v(" 部门")],-1)),ve=O(()=>L("img",{src:ee,alt:"",style:{"margin-left":"0.25rem"}},null,-1)),ge={key:1},he={style:{flex:"auto"}},_e=se({name:"AllocationEdit",__name:"index",emits:["fetch-data"],setup(b,{expose:B,emit:H}){ae();const m=i([]),g=i(),S=i([]),J={children:"children",label:"name"},M=H,_=i(!1),j=i(),l=i({list:[],title:null,vipGroupList:[],form:{projectId:"",allocationType:3,groupSupplierIdList:[]},selectAll:{member:!1}}),A=i([]),U=i({groupSupplierIdList:[{type:"array",required:!0,trigger:"change",message:"请选择至少一项"}]});async function q(t,e){l.value.list=[{...t}],l.value.form.projectId=t.projectId,o.value.projectId=t.projectId;const s=await le(K.getProjectAllocation({projectId:t.projectId})),{getProjectAllocationInfoList:n}=s.data;n==null||n.forEach(d=>{d.allocationType===3&&(o.value={allocationType:d.allocationType,projectId:d.projectId,groupSupplierIdList:d.groupSupplierIdSet})});const p=JSON.parse(JSON.stringify(m.value));A.value=T(p),A.value.length==o.value.groupSupplierIdList.length?l.value.selectAll.member=!0:l.value.selectAll.member=!1,e==="reassign"?l.value.title="重新分配":l.value.title="分配",_.value=!0}const T=t=>t.reduce((e,s)=>{const{children:n,...p}=s;return e.push(p),s.children&&s.children.length>0&&(e=e.concat(T(s.children))),e},[]);function C(){j.value.resetFields(),Object.assign(l.value.form,{projectId:"",groupSupplierIdList:[]}),_.value=!1,Object.assign(o.value,{projectId:null,allocationType:3,groupSupplierIdList:[],deleteSet:[]}),y.value=!1,I.value=!1,l.value.selectAll.member=!1}const o=i({projectId:null,allocationType:3,groupSupplierIdList:[],deleteSet:[]}),z=()=>{o.value.groupSupplierIdList=[],m.value.forEach(t=>{E(t)}),g.value.setCheckedKeys(o.value.groupSupplierIdList)};function E(t){o.value.groupSupplierIdList.push(t.id),t.children&&t.children.length&&t.children.forEach(e=>{E(e)})}function D(){o.value.groupSupplierIdList=[],l.value.selectAll.member?(z(),g.value.setCheckedKeys(o.value.groupSupplierIdList)):(l.value.selectAll.member=!1,o.value.groupSupplierIdList=[],g.value.setCheckedKeys([]))}const G=(t,e)=>{e?S.value.includes(t.id)||S.value.push(t.id):S.value=S.value.filter(d=>d!==t.id);const s=g.value.getCheckedKeys(),n=g.value.getHalfCheckedKeys(),p=[...s,...n];o.value.groupSupplierIdList=p,A.value.length==p.length?l.value.selectAll.member=!0:l.value.selectAll.member=!1};function $(){j.value.validate(async t=>{if(t){let e={addProjectAllocationInfoList:[]};if(o.value.groupSupplierIdList.length&&(o.value.projectId=l.value.form.projectId,e.addProjectAllocationInfoList.push(o.value)),l.value.form.groupSupplierIdList=o.value.groupSupplierIdList,l.value.title!=="分配")e.addProjectAllocationInfoList.length||(y.value=!0);else if(!e.addProjectAllocationInfoList.length){R.warning({message:"至少选择一个分配目标",center:!0});return}let s="分配成功";y.value&&(s="取消分配成功",e={addProjectAllocationInfoList:[{projectId:l.value.form.projectId,allocationType:5,groupSupplierIdList:[],deleteSet:[]}]});const{status:n}=await te(K.allocation(e));n===1&&R.success({message:s,center:!0}),C(),M("fetch-data")}})}re(async()=>{const t=await oe.list({name:""});t.data&&(m.value=t.data)});const y=i(!1),I=i(!1),F=()=>{I.value=!I.value,I.value?y.value=!0:y.value=!1},Q=t=>{};return B({showEdit:q}),(t,e)=>{const s=f("el-table-column"),n=f("el-table"),p=f("el-checkbox"),d=f("el-tree-select"),N=f("el-form-item"),x=f("el-button"),W=f("el-form"),X=f("el-dialog"),Y=ie("loading");return h(),w("div",null,[c(X,{modelValue:a(_),"onUpdate:modelValue":e[4]||(e[4]=u=>ce(_)?_.value=u:null),title:a(l).title,width:"700","before-close":C},{footer:r(()=>[L("div",he,[c(x,{onClick:C},{default:r(()=>[v(" 取消 ")]),_:1}),c(x,{type:"primary",onClick:$},{default:r(()=>[v(" 确定 ")]),_:1})])]),default:r(()=>[ne((h(),V(n,{data:a(l).list,"row-key":"id"},{default:r(()=>[c(s,{align:"left","show-overflow-tooltip":"",label:"项目编码",prop:"projectId"}),c(s,{align:"left","show-overflow-tooltip":"",label:"项目名称",prop:"projectName"}),c(s,{align:"left","show-overflow-tooltip":"",label:"配额/限量",prop:"name"},{default:r(({row:u})=>[v(P(u.limitedQuantity||0)+"/ "+P(u.num||0),1)]),_:1})]),_:1},8,["data"])),[[Y,!1]]),a(l).form.allocationType===3&&a(l).form.allocationType!==5?(h(),V(W,{key:0,ref_key:"formRef",ref:j,"label-width":"90px",rules:a(U),model:a(l).form,inline:!1,"label-position":"left",style:{"margin-top":"1.25rem"}},{default:r(()=>[c(N,null,{label:r(()=>[me]),default:r(()=>[c(d,{ref_key:"treeRef",ref:g,modelValue:a(o).groupSupplierIdList,"onUpdate:modelValue":e[2]||(e[2]=u=>a(o).groupSupplierIdList=u),data:a(m),"show-checkbox":"","default-expand-all":"","node-key":"id",props:J,onCheckChange:G,"check-strictly":!0,"check-on-click-node":!0,multiple:!0,"expand-on-click-node":!1,style:{width:"37.625rem"},clearable:"",placeholder:""},ue({prefix:r(()=>[a(m).length==0?(h(),w("span",{key:0,class:"prefix-class",onClick:e[1]||(e[1]=u=>Q("部门"))},[v(" 请先维护部门数据 "),ve])):k("",!0),!a(o).groupSupplierIdList.length&&a(m).length!=0?(h(),w("span",ge,"请先选择部门数据")):k("",!0)]),_:2},[a(m).length?{name:"header",fn:r(()=>[c(p,{modelValue:a(l).selectAll.member,"onUpdate:modelValue":e[0]||(e[0]=u=>a(l).selectAll.member=u),onChange:D,style:{display:"flex",height:"unset"}},{default:r(()=>[v("全选")]),_:1},8,["modelValue"])]),key:"0"}:void 0]),1032,["modelValue","data"])]),_:1}),a(l).title=="重新分配"?(h(),V(N,{key:0},{label:r(()=>[c(x,{type:a(I)?"primary":"",onClick:e[3]||(e[3]=u=>F()),style:{"border-radius":"1.875rem"}},{default:r(()=>[v(" 取消分配 ")]),_:1},8,["type"])]),_:1})):k("",!0)]),_:1},8,["rules","model"])):k("",!0)]),_:1},8,["modelValue","title"])])}}}),Ae=fe(_e,[["__scopeId","data-v-c4bba734"]]);export{Ae as default};


/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{d as ee,m as N,r as _,u as ae,c as le,n as se,p as F,a as v,q as oe,o as f,e as U,w as u,f as r,g as L,s as S,i as c,b as y,t as k,F as x,y as h,z as te,aq as T,E as M,L as ne}from"./index-DkeSsSat.js";import{a as O}from"./department-Cm2_E5Tv.js";const ie={class:"mr"},re={class:"mr checkbox-container"},ue={class:"centers mr"},de={class:"center mr"},ce={class:"center mr"},me=ee({__name:"index",props:N({parentId:{default:""},id:{default:""},tree:{},row:{},isClick:{type:Boolean}},{modelValue:{type:Boolean,default:!1},modelModifiers:{}}),emits:N(["getList","getItmelist"],["update:modelValue"]),setup(q,{emit:j}){const g=_([]),I=q,D=_(!1),R=[{label:"完成计提",value:1},{label:"审核计提",value:2},{label:"结算计提",value:3}],A=[{label:"按项目价",value:1},{label:"按成本价",value:2},{label:"按毛利润",value:3}],b=_(!1),w=j,z=ae(q,"modelValue"),J=le(()=>I.id===""?"新增部门":"编辑部门"),d=_([]),E=_(),e=_({parentId:I.parentId,name:"",remark:"",userIdList:[],organizationalStructurePersonList:[]}),$=_({name:[{required:!0,message:"请输入部门名称"}],commissionType:[{required:!0,message:"请选择计提方式",trigger:"change"}]}),G=o=>{if(o.userId){const l=e.value.userIdList.indexOf(o.userId);l!==-1&&e.value.userIdList.splice(l,1)}else{const l=e.value.userIdList.indexOf(o.id);l!==-1&&e.value.userIdList.splice(l,1)}const t=e.value.organizationalStructurePersonList.findIndex(l=>l.id===o.id||l.userId===o.id);t!==-1&&e.value.organizationalStructurePersonList.splice(t,1);const n=d.value.findIndex(l=>l.id===o.id||l.userId===o.id);n!==-1&&d.value.splice(n,1)},H=o=>{var t;if(e.value.userIdList=o,d.value=g.value.filter(n=>{var l;return(l=e.value)==null?void 0:l.userIdList.includes(n.id)}),(t=e.value)!=null&&t.userIdList.length){const n=[];e.value.organizationalStructurePersonList.forEach(a=>{n.push(a)}),d.value.forEach(a=>{e.value.organizationalStructurePersonList.some(V=>V.userId===a.id)||n.push(a)});const m=Array.from(new Map(n.map(a=>[a.id,a])).values()).filter(a=>a.userId?o.includes(a.userId):o.includes(a.id));d.value=m,e.value.organizationalStructurePersonList=d.value}else d.value=[],e.value.organizationalStructurePersonList=d.value},K=o=>{};async function Q(){try{E.value&&await E.value.validate(async o=>{if(o){b.value=!0,e.value.organizationalStructurePersonList=[],d.value.forEach(a=>{if(a.userId){const p={id:a.id,userId:a.userId,commission:a.commission||0,commissionTime:a.commissionTime||1,commissionStatus:a.commissionStatus,commissionType:a.commissionType||1};e.value.organizationalStructurePersonList.push(p)}else{const p={userId:a.id,commission:a.commission||0,commissionTime:a.commissionTime||1,commissionStatus:a.commissionStatus,commissionType:a.commissionType||1};e.value.organizationalStructurePersonList.push(p)}});const t=e.value.organizationalStructurePersonList.reduce((a,p)=>(a.some(P=>P.userId===p.userId)||a.push(p),a),[]);e.value.organizationalStructurePersonList=t;const n={...e.value};delete n.userIdList;let l;e.value.id?l=await O.edit(n):l=await O.create(n);const{status:m}=l;m===1?M.success({message:e.value.id?"编辑成功":"新增成功",center:!0}):M.error("操作失败，请重试"),D.value?(await w("getItmelist"),await w("getList")):await w("getList"),C()}})}catch{}finally{b.value=!1}}function C(){Object.assign(e,{parentId:"",name:"",remark:"",userIdList:[],organizationalStructurePersonList:[]}),z.value=!1}const W=()=>g.value.filter(o=>{var t;return(t=e.value)==null?void 0:t.userIdList.includes(o.id)});return se(async()=>{try{if(b.value=!0,I.id){const{id:o,name:t,remark:n,organizationalStructurePersonList:l}=JSON.parse(I.row);e.value.id=o,e.value.name=t,e.value.remark=n,D.value=I.isClick;const{data:m}=await F.queryNotEnableStaffList({organizationalStructureId:e.value.id});m&&(g.value=m),l?(e.value.organizationalStructurePersonList=l,l.forEach(a=>{e.value.userIdList.push(a.userId)})):e.value.organizationalStructurePersonList=[]}else{const{data:o}=await F.queryAllNotEnableStaffList();o&&(g.value=o)}d.value=W(),e.value.id&&(d.value=e.value.organizationalStructurePersonList)}catch(o){console.error("Error occurred:",o)}finally{b.value=!1}}),(o,t)=>{const n=v("ElInput"),l=v("ElFormItem"),m=v("el-option"),a=v("el-select"),p=v("el-tag"),V=v("el-text"),P=v("el-switch"),X=v("ElForm"),B=v("ElButton"),Y=v("ElDialog"),Z=oe("loading");return f(),U(Y,{modelValue:z.value,"onUpdate:modelValue":t[3]||(t[3]=s=>z.value=s),title:c(J),style:{width:"48rem"},"close-on-click-modal":!1,"append-to-body":"","destroy-on-close":"",onClosed:C},{footer:u(()=>[r(B,{size:"large",onClick:C},{default:u(()=>[L(" 取消 ")]),_:1}),r(B,{type:"primary",size:"large",onClick:Q},{default:u(()=>[L(" 确定 ")]),_:1})]),default:u(()=>[S((f(),U(X,{ref_key:"formRef",ref:E,model:c(e),rules:c($),"label-width":"7rem"},{default:u(()=>[r(l,{label:"部门名称",prop:"name"},{default:u(()=>[r(n,{modelValue:c(e).name,"onUpdate:modelValue":t[0]||(t[0]=s=>c(e).name=s),placeholder:"请输入部门名称",clearable:""},null,8,["modelValue"])]),_:1}),r(l,{label:"部门主管",prop:""},{default:u(()=>[r(a,{modelValue:c(e).userIdList,"onUpdate:modelValue":t[1]||(t[1]=s=>c(e).userIdList=s),"value-key":"",placeholder:"请选择部门主管",multiple:"","collapse-tags":"","collapse-tags-tooltip":"",clearable:"",filterable:"",onChange:H},{default:u(()=>[(f(!0),y(x,null,k(c(g),s=>(f(),U(m,{key:s.value,label:s.userName,value:s.id,disabled:s.enableChargePerson===1},null,8,["label","value","disabled"]))),128))]),_:1},8,["modelValue"])]),_:1}),r(l,{label:"备注"},{default:u(()=>[r(n,{modelValue:c(e).remark,"onUpdate:modelValue":t[2]||(t[2]=s=>c(e).remark=s),placeholder:"请输入备注",clearable:""},null,8,["modelValue"])]),_:1}),(f(!0),y(x,null,k(c(d),s=>(f(),y("div",{key:s.id,class:"user"},[h("div",ie,[r(p,{type:"primary",closable:"",onClose:i=>G(s)},{default:u(()=>[L(te(s.userName),1)]),_:2},1032,["onClose"])]),h("div",re,[r(V,{style:{width:"4.375rem"}},{default:u(()=>[L("开启提成")]),_:1}),r(P,{modelValue:s.commissionStatus,"onUpdate:modelValue":i=>s.commissionStatus=i,"active-value":1,"inactive-value":2,"inline-prompt":"","active-text":"开启","inactive-text":"关闭",onChange:K},null,8,["modelValue","onUpdate:modelValue"])]),S(h("div",ue,[r(a,{modelValue:s.commissionType,"onUpdate:modelValue":i=>s.commissionType=i,"value-key":"",placeholder:"计提方式",clearable:"",filterable:""},{default:u(()=>[(f(),y(x,null,k(A,i=>r(m,{key:i.value,label:i.label,value:i.value},null,8,["label","value"])),64))]),_:2},1032,["modelValue","onUpdate:modelValue"])],512),[[T,s.commissionStatus===1]]),S(h("div",de,[r(a,{class:"select",modelValue:s.commissionTime,"onUpdate:modelValue":i=>s.commissionTime=i,"value-key":"",placeholder:"计提时间",clearable:"",filterable:""},{default:u(()=>[(f(),y(x,null,k(R,i=>r(m,{key:i.value,label:i.label,value:i.value},null,8,["label","value"])),64))]),_:2},1032,["modelValue","onUpdate:modelValue"])],512),[[T,s.commissionStatus===1]]),S(h("div",ce,[r(n,{modelValue:s.commission,"onUpdate:modelValue":i=>s.commission=i,placeholder:"提成比例",style:{"max-width":"25rem"},clearable:""},{append:u(()=>[L("%")]),_:2},1032,["modelValue","onUpdate:modelValue"])],512),[[T,s.commissionStatus===1]])]))),128))]),_:1},8,["model","rules"])),[[Z,c(b)]])]),_:1},8,["modelValue","title"])}}}),fe=ne(me,[["__scopeId","data-v-a64e50cf"]]);export{fe as default};

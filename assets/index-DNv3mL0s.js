
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{d as oe,r,o as ie,a2 as g,al as se,a as h,i as T,f as d,w as i,b as S,g as v,a3 as re,c as w,t as P,h as t,aJ as ne,j as k,k as ue,ai as R,_ as de,aH as ce,aI as pe,y as me}from"./index-C7IrLSdY.js";import{a as fe,_ as ge}from"./jiantou-r_GPOlIm.js";import{o as ve,s as he}from"./apiLoading-BMWBBwp6.js";import{a as O}from"./projectManagement-Dh1DCvo9.js";import{a as B}from"./survey_vip_department-2OdP38cr.js";import{u as _e}from"./survey_vipGroup-B64NAJym.js";import ye from"./index-G79PZgx9.js";import"./survey_vipGroup-BZUVk5Fn.js";const H=L=>(ce("data-v-f754781f"),L=L(),pe(),L),Ie=H(()=>S("span",{class:"icon-class"},[S("img",{src:fe,alt:"",style:{"margin-right":"0.25rem"}}),v(" 部门")],-1)),be={key:0,class:"prefix-class"},ke=H(()=>S("img",{src:ge,alt:"",style:{"margin-left":"0.25rem"}},null,-1)),Se={key:1},Le={style:{flex:"auto"}},je=oe({name:"AllocationEdit",__name:"index",emits:["fetch-data"],setup(L,{expose:U,emit:G}){_e();const p=r([]),_=r(),j=r([]),J={children:"children",label:"name"},M=G,y=r(!1),A=r(),a=r({list:[],title:null,vipGroupList:[],form:{projectId:"",allocationType:3,groupSupplierIdList:[]},selectAll:{member:!1}}),V=r([]),$=r({groupSupplierIdList:[{type:"array",required:!0,trigger:"change",message:"请选择至少一项"}]});async function z(l,e){a.value.list=[{...l}],a.value.form.projectId=l.projectId,o.value.projectId=l.projectId;const s=await ve(O.getProjectAllocation({projectId:l.projectId})),{getProjectAllocationInfoList:c}=s.data;c==null||c.forEach(f=>{f.allocationType===3&&(o.value={allocationType:f.allocationType,projectId:f.projectId,groupSupplierIdList:f.groupSupplierIdSet})});const m=JSON.parse(JSON.stringify(p.value));V.value=N(m),V.value.length==o.value.groupSupplierIdList.length?a.value.selectAll.member=!0:a.value.selectAll.member=!1,e==="reassign"?a.value.title="重新分配":a.value.title="分配",y.value=!0}const N=l=>l.reduce((e,s)=>{const{children:c,...m}=s;return e.push(m),s.children&&s.children.length>0&&(e=e.concat(N(s.children))),e},[]);function x(){A.value.resetFields(),Object.assign(a.value.form,{projectId:"",groupSupplierIdList:[]}),y.value=!1,D(),I.value=!1,b.value=!1,a.value.selectAll.member=!1}const D=()=>{Object.assign(o.value,{projectId:null,allocationType:3,groupSupplierIdList:[],deleteSet:[]})},o=r({projectId:null,allocationType:3,groupSupplierIdList:[],deleteSet:[]}),q=()=>{o.value.groupSupplierIdList=[],p.value.forEach(l=>{E(l)}),_.value.setCheckedKeys(o.value.groupSupplierIdList)};function E(l){o.value.groupSupplierIdList.push(l.id),l.children&&l.children.length&&l.children.forEach(e=>{E(e)})}function F(){o.value.groupSupplierIdList=[],a.value.selectAll.member?(q(),_.value.setCheckedKeys(o.value.groupSupplierIdList)):(a.value.selectAll.member=!1,o.value.groupSupplierIdList=[],_.value.setCheckedKeys([]))}const Q=(l,e)=>{e?j.value.includes(l.id)||j.value.push(l.id):j.value=j.value.filter(f=>f!==l.id);const s=_.value.getCheckedKeys(),c=_.value.getHalfCheckedKeys(),m=[...s,...c];o.value.groupSupplierIdList=m,V.value.length==m.length?a.value.selectAll.member=!0:a.value.selectAll.member=!1};function W(){A.value.validate(async l=>{if(l){let e={addProjectAllocationInfoList:[]};if(o.value.groupSupplierIdList.length&&(o.value.projectId=a.value.form.projectId,e.addProjectAllocationInfoList.push(o.value)),a.value.form.groupSupplierIdList=o.value.groupSupplierIdList,a.value.title!=="分配")e.addProjectAllocationInfoList.length||(I.value=!0);else if(!e.addProjectAllocationInfoList.length){R.warning({message:"至少选择一个分配目标",center:!0});return}let s="分配成功";I.value&&(s="取消分配成功",e={addProjectAllocationInfoList:[{projectId:a.value.form.projectId,allocationType:5,groupSupplierIdList:[],deleteSet:[]}]});const{status:c}=await he(O.allocation(e));c===1&&R.success({message:s,center:!0}),x(),M("fetch-data")}})}ie(async()=>{const l=await B.list({name:""});l.data&&(p.value=l.data)});const I=r(!1),b=r(!1),X=()=>{b.value=!b.value,D(),b.value?I.value=!0:I.value=!1};r();const n=r({search:{name:""},tree:[],currentNode:void 0,currentData:void 0,dialog:{visible:!1,parentId:"",id:"",isClick:!1},row:"",loading:!1}),Y=(l,e)=>{n.value.currentData=e,n.value.dialog.parentId="",n.value.dialog.id="",n.value.dialog.visible=!0},Z=async()=>{const l=await B.list({name:""});p.value=l.data};return U({showEdit:z}),(l,e)=>{const s=g("el-table-column"),c=g("el-table"),m=g("el-checkbox"),f=de,C=g("el-button"),ee=g("el-tree-select"),K=g("el-form-item"),le=g("el-form"),te=g("el-dialog"),ae=se("loading");return h(),T("div",null,[d(te,{modelValue:t(y),"onUpdate:modelValue":e[4]||(e[4]=u=>ue(y)?y.value=u:null),title:t(a).title,width:"700","before-close":x},{footer:i(()=>[S("div",Le,[d(C,{onClick:x},{default:i(()=>[v(" 取消 ")]),_:1}),d(C,{type:"primary",onClick:W},{default:i(()=>[v(" 确定 ")]),_:1})])]),default:i(()=>[re((h(),w(c,{data:t(a).list,"row-key":"id"},{default:i(()=>[d(s,{align:"left","show-overflow-tooltip":"",label:"项目编码",prop:"projectId"}),d(s,{align:"left","show-overflow-tooltip":"",label:"项目名称",prop:"projectName"}),d(s,{align:"left","show-overflow-tooltip":"",label:"配额/限量",prop:"name"},{default:i(({row:u})=>[v(P(u.limitedQuantity||0)+"/ "+P(u.num||0),1)]),_:1})]),_:1},8,["data"])),[[ae,!1]]),t(a).form.allocationType===3&&t(a).form.allocationType!==5?(h(),w(le,{key:0,ref_key:"formRef",ref:A,"label-width":"90px",rules:t($),model:t(a).form,inline:!1,"label-position":"left",style:{"margin-top":"1.25rem"}},{default:i(()=>[d(K,null,{label:i(()=>[Ie]),default:i(()=>[d(ee,{ref_key:"treeRef",ref:_,modelValue:t(o).groupSupplierIdList,"onUpdate:modelValue":e[2]||(e[2]=u=>t(o).groupSupplierIdList=u),data:t(p),"show-checkbox":"","default-expand-all":"","node-key":"id",props:J,onCheckChange:Q,"check-strictly":!0,"check-on-click-node":!0,multiple:!0,"expand-on-click-node":!1,style:{width:"37.625rem"},clearable:"",placeholder:""},ne({prefix:i(()=>[t(p).length==0?(h(),T("span",be,[v(" 请先维护部门数据 "),ke])):k("",!0),!t(o).groupSupplierIdList.length&&t(p).length!=0?(h(),T("span",Se,"请先选择部门数据")):k("",!0)]),empty:i(()=>[S("div",null,[d(C,{type:"primary",link:"",class:"buttonClass",size:"small",onClick:e[1]||(e[1]=u=>Y("部门"))},{default:i(()=>[v(" 快捷新增 "),d(f,{name:"ant-design:plus-outlined",color:"#fff",style:{"background-color":"var(--el-color-primary)","border-radius":"50%",padding:"0.125rem",margin:"0 0.125rem"}})]),_:1})])]),_:2},[t(p).length?{name:"header",fn:i(()=>[d(m,{modelValue:t(a).selectAll.member,"onUpdate:modelValue":e[0]||(e[0]=u=>t(a).selectAll.member=u),onChange:F,style:{display:"flex",height:"unset"}},{default:i(()=>[v("全选")]),_:1},8,["modelValue"])]),key:"0"}:void 0]),1032,["modelValue","data"])]),_:1}),t(a).title=="重新分配"?(h(),w(K,{key:0},{label:i(()=>[d(C,{type:t(b)?"primary":"",onClick:e[3]||(e[3]=u=>X()),style:{"border-radius":"1.875rem"}},{default:i(()=>[v(" 取消分配 ")]),_:1},8,["type"])]),_:1})):k("",!0)]),_:1},8,["rules","model"])):k("",!0)]),_:1},8,["modelValue","title"]),t(n).dialog.visible?(h(),w(ye,{key:0,id:t(n).dialog.id,modelValue:t(n).dialog.visible,"onUpdate:modelValue":e[5]||(e[5]=u=>t(n).dialog.visible=u),row:t(n).row,"parent-id":t(n).dialog.parentId,tree:t(n).tree,isClick:t(n).dialog.isClick,onGetList:Z},null,8,["id","modelValue","row","parent-id","tree","isClick"])):k("",!0)])}}}),Ee=me(je,[["__scopeId","data-v-f754781f"]]);export{Ee as default};

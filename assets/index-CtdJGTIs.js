
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{d as K,m as D,r as g,u as Q,c as W,n as X,p as Y,a as v,q as Z,s as L,i as o,o as _,e as q,w as m,f as t,g as I,b as w,t as E,F as x,y,ao as z,E as P,L as ee}from"./index-FnfKA9mU.js";import{a as B}from"./department-Bw_ExgcA.js";const le={class:"user"},ae={class:"mr checkbox-container"},se={class:"centers mr"},oe={class:"center mr"},te={class:"center mr"},ie=K({__name:"index",props:D({parentId:{default:""},id:{default:""},tree:{},row:{},name:{}},{modelValue:{type:Boolean,default:!1},modelModifiers:{}}),emits:D(["getList"],["update:modelValue"]),setup(U,{emit:F}){const V=g([]),p=U,M=[{label:"完成计提",value:1},{label:"审核计提",value:2},{label:"结算计提",value:3}],N=[{label:"按项目价",value:1},{label:"按成本价",value:2},{label:"按毛利润",value:3}],d=g(!1),j=F,S=Q(U,"modelValue"),R=W(()=>p.id===""?"新增子部门":"编辑子部门"),c=g([]),h=g(),e=g({parentId:p.parentId,name:"",remark:"",userIdList:[],organizationalStructurePersonList:[],superior:"",commission:null,commissionTime:null,commissionStatus:2,commissionType:null}),A=g({name:[{required:!0,message:"请输入部门名称"}],commissionType:[{required:!0,message:"请选择计提方式",trigger:"change"}]});async function O(){try{h.value&&h.value.validate(async u=>{if(u){if(d.value=!0,e.value.organizationalStructurePersonList=[],e.value.commissionStatus===1&&!/^[1-9]\d*$/.test(e.value.commission)){P.warning({message:"提成比例必须是正整数",center:!0}),d.value=!1;return}c.value.forEach(s=>{if(s.userId){const r={id:s.id,userId:s.userId};e.value.organizationalStructurePersonList.push(r)}else{const r={userId:s.id};e.value.organizationalStructurePersonList.push(r)}}),e.value.commission=e.value.commission?e.value.commission:0,e.value.commissionTime=e.value.commissionTime?e.value.commissionTime:1,e.value.commissionType=e.value.commissionType?e.value.commissionType:1;const a=e.value.organizationalStructurePersonList.reduce((s,r)=>(s.some(f=>f.userId===r.userId)||s.push(r),s),[]);e.value.organizationalStructurePersonList=a;const i={...e.value};if(delete i.userIdList,delete i.superior,e.value.id){const{status:s}=await B.edit(i);s===1&&P.success({message:"编辑成功",center:!0}),d.value=!1}else{const{status:s}=await B.create(i);s===1&&P.success({message:"新增成功",center:!0}),d.value=!1}await j("getList"),T()}})}catch{}finally{d.value=!1}}const J=u=>{var a;if(e.value.userIdList=u,c.value=V.value.filter(i=>{var s;return(s=e.value)==null?void 0:s.userIdList.includes(i.id)}),(a=e.value)!=null&&a.userIdList.length){const i=[];e.value.organizationalStructurePersonList.forEach(n=>{i.push(n)}),c.value.forEach(n=>{e.value.organizationalStructurePersonList.some(b=>b.userId===n.id)||i.push(n)});const r=Array.from(new Map(i.map(n=>[n.id,n])).values()).filter(n=>u.includes(n.id));c.value=r,e.value.organizationalStructurePersonList=c.value}else c.value=[],e.value.organizationalStructurePersonList=c.value};function T(){Object.assign(e,{parentId:"",name:"",remark:"",userIdList:[],organizationalStructurePersonList:[],superior:"",commission:null,commissionTime:null,commissionStatus:2,commissionType:null}),S.value=!1}const $=()=>V.value.filter(u=>{var a;return(a=e.value)==null?void 0:a.userIdList.includes(u.id)});return p.parentId&&(e.value.superior=p.name),X(async()=>{try{if(d.value=!0,p.id!==""){const{id:u,name:a,remark:i,organizationalStructurePersonList:s,commission:r,commissionTime:n,commissionStatus:f,commissionType:b}=JSON.parse(p.row);e.value.id=u,e.value.name=a,e.value.remark=i,e.value.commission=r,e.value.commissionTime=n,e.value.commissionStatus=f,e.value.commissionType=b,e.value.organizationalStructurePersonList=s,s.forEach(k=>{e.value.userIdList.push(k.userId)})}else{const{data:u}=await Y.queryAllNotEnableStaffList();u&&(V.value=u)}c.value=$(),e.value.id&&(c.value=e.value.organizationalStructurePersonList),d.value=!1}catch{}finally{d.value=!1}}),(u,a)=>{const i=v("ElInput"),s=v("ElFormItem"),r=v("el-option"),n=v("el-select"),f=v("el-text"),b=v("el-switch"),k=v("ElForm"),C=v("ElButton"),G=v("ElDialog"),H=Z("loading");return L((_(),q(G,{modelValue:S.value,"onUpdate:modelValue":a[8]||(a[8]=l=>S.value=l),title:o(R),style:{width:"48rem"},"close-on-click-modal":!1,"append-to-body":"","destroy-on-close":"",onClosed:T},{footer:m(()=>[t(C,{size:"large",onClick:T},{default:m(()=>[I(" 取消 ")]),_:1}),t(C,{type:"primary",size:"large",onClick:O},{default:m(()=>[I(" 确定 ")]),_:1})]),default:m(()=>[t(k,{ref_key:"formRef",ref:h,model:o(e),rules:o(A),"label-width":"7rem"},{default:m(()=>[t(s,{label:"上级部门",prop:""},{default:m(()=>[t(i,{modelValue:o(e).superior,"onUpdate:modelValue":a[0]||(a[0]=l=>o(e).superior=l),disabled:!!p.parentId,placeholder:"请输入部门名称",clearable:""},null,8,["modelValue","disabled"])]),_:1}),t(s,{label:"部门名称",prop:"name"},{default:m(()=>[t(i,{modelValue:o(e).name,"onUpdate:modelValue":a[1]||(a[1]=l=>o(e).name=l),placeholder:"请输入部门名称",clearable:""},null,8,["modelValue"])]),_:1}),t(s,{label:"部门主管",prop:""},{default:m(()=>[t(n,{modelValue:o(e).userIdList,"onUpdate:modelValue":a[2]||(a[2]=l=>o(e).userIdList=l),"value-key":"",placeholder:"请选择部门主管",multiple:"","collapse-tags":"","collapse-tags-tooltip":"",clearable:"",filterable:"",onChange:J},{default:m(()=>[(_(!0),w(x,null,E(o(V),l=>(_(),q(r,{key:l.value,label:l.userName,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(s,{label:"备注"},{default:m(()=>[t(i,{modelValue:o(e).remark,"onUpdate:modelValue":a[3]||(a[3]=l=>o(e).remark=l),placeholder:"请输入备注",clearable:""},null,8,["modelValue"])]),_:1}),y("div",le,[y("div",ae,[t(f,{style:{width:"4.375rem"}},{default:m(()=>[I("开启提成")]),_:1}),t(b,{modelValue:o(e).commissionStatus,"onUpdate:modelValue":a[4]||(a[4]=l=>o(e).commissionStatus=l),"active-value":1,"inactive-value":2,"inline-prompt":"","active-text":"开启","inactive-text":"关闭"},null,8,["modelValue"])]),L(y("div",se,[t(n,{modelValue:o(e).commissionType,"onUpdate:modelValue":a[5]||(a[5]=l=>o(e).commissionType=l),"value-key":"",placeholder:"计提方式",clearable:"",filterable:""},{default:m(()=>[(_(),w(x,null,E(N,l=>t(r,{key:l.value,label:l.label,value:l.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])],512),[[z,o(e).commissionStatus===1]]),L(y("div",oe,[t(n,{class:"select",modelValue:o(e).commissionTime,"onUpdate:modelValue":a[6]||(a[6]=l=>o(e).commissionTime=l),"value-key":"",placeholder:"计提时间",clearable:"",filterable:""},{default:m(()=>[(_(),w(x,null,E(M,l=>t(r,{key:l.value,label:l.label,value:l.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])],512),[[z,o(e).commissionStatus===1]]),L(y("div",te,[t(i,{modelValue:o(e).commission,"onUpdate:modelValue":a[7]||(a[7]=l=>o(e).commission=l),placeholder:"提成比例",style:{"max-width":"25rem"},clearable:""},{append:m(()=>[I("%")]),_:1},8,["modelValue"])],512),[[z,o(e).commissionStatus===1]])])]),_:1},8,["model","rules"])]),_:1},8,["modelValue","title"])),[[H,o(d)]])}}}),re=ee(ie,[["__scopeId","data-v-3254179e"]]);export{re as default};

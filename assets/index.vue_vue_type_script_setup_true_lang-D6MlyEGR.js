
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{o as I,s as y}from"./apiLoading-BwALWvTU.js";import{_ as R}from"./index.vue_vue_type_script_setup_true_lang-CYAeuLko.js";import{a as v}from"./survey_vip-Djq0KTJL.js";import{u as j}from"./stagedData-uI7xbUHt.js";import{u as M}from"./survey_vip-BSVMzg6q.js";import{d as A,r,a2 as O,a3 as u,a as h,o as k,b as P,f as d,w as c,g as p,e as Q,j as U,i as $,Q as q,an as F,E as f}from"./index-c-Fvncv2.js";const Z=A({__name:"index",emits:["fetch-data"],setup(G,{expose:T,emit:V}){const m=j(),b=M(),C=V,o=r(!1),l=r(""),_=r(),n=r([]),i=r([]);function D(e){i.value.push(e)}O("validateTopTabs",D);let a=u([]);async function L(e){if(!e)l.value="新增",a=m.surveyVip||u([{...b.initialTopTabsData}]);else{l.value="编辑";const{data:s}=await I(v.detail({memberId:e.memberId}));S(s)}n.value=[],o.value=!0}function S(e){a=u([]),a.push({...e})}function x(){m.surveyVip=F(a),a=u([]),o.value=!1,i.value=[]}function g(){a=u([]),o.value=!1,i.value=[],l.value==="新增"&&(m.surveyVip=null)}async function w(){const e=[];i.value.forEach(t=>{e.push(t.validate())});const s=await Promise.allSettled(e);n.value=s.map(t=>t.status)}function N(e){const s=new Set;for(const t of e){if(s.has(t.memberNickname))return!0;s.add(t.memberNickname)}return!1}async function E(){if(await w(),n.value.every(e=>e==="fulfilled"))if(N(a))f.warning({message:"会员名称重复",center:!0});else{if(l.value==="新增"){const{status:e}=await y(v.create({addMemberInfoList:a}));e===1&&f.success({message:"新增成功",center:!0})}else{const{status:e}=await y(v.edit(a[0]));e===1&&f.success({message:"修改成功",center:!0})}b.NickNameList=null,g(),C("fetch-data")}else _.value.activeLeftTab=n.value.indexOf("rejected"),f.warning({message:"请完善表单",center:!0})}return T({showEdit:L}),(e,s)=>{const t=h("el-button"),z=h("el-drawer");return k(),P("div",null,[d(z,{modelValue:o.value,"onUpdate:modelValue":s[0]||(s[0]=B=>o.value=B),class:q(l.value==="新增"?"hide-drawer-header":"edit-drawer"),"append-to-body":"","close-on-click-modal":!1,"destroy-on-close":"",draggable:"",size:"60%"},{footer:c(()=>[d(t,{onClick:g},{default:c(()=>[p(" 取消 ")]),_:1}),l.value==="新增"?(k(),Q(t,{key:0,type:"warning",onClick:x},{default:c(()=>[p(" 暂存 ")]),_:1})):U("",!0),d(t,{type:"primary",onClick:E},{default:c(()=>[p(" 确定 ")]),_:1})]),default:c(()=>[d(R,{onValidate:w,ref_key:"LeftTabsRef",ref:_,title:l.value,"left-tabs-data":$(a),"validate-top-tabs":i.value,"validate-all":n.value},null,8,["title","left-tabs-data","validate-top-tabs","validate-all"])]),_:1},8,["modelValue","class"])])}}});export{Z as _};


/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://fantastic-admin.gitee.io
 * Github https://fantastic-admin.github.io
 */

import{_ as I}from"./index.vue_vue_type_script_setup_true_lang-By-3MERD.js";import{a as m}from"./user_customer-uv4RFwW2.js";import{o as z,s as w}from"./apiLoading-DF5nx7ws.js";import{u as R}from"./stagedData-C_3AC9pm.js";import{u as j}from"./user_customer-BlKNNJ8w.js";import{d as M,r as u,X as U,Z as v,a as C,o as y,b as O,f as d,w as i,y as P,g as p,e as X,j as Z,i as $,N as q,ap as F,E as c,L as G}from"./index-BLhj-6I9.js";import"./index-CfElh_5d.js";import"./index-CT1yDpzy.js";import"./index-BBrED86W.js";import"./index-BXCqgDO6.js";import"./department-Cq_8rMze.js";import"./position_manage-CjuWI3_O.js";import"./configuration_role-xcq-p6Fl.js";import"./tenant_role-CPmRPyYV.js";import"./configuration_manager-BQQ2TXkG.js";import"./configuration_siteSetting--U9pwEDG.js";import"./configuration_site_setting-D-_J3bY8.js";const H={class:"flex-c"},J=M({__name:"index",emits:["fetch-data"],setup(K,{expose:T,emit:k}){const f=R(),_=j(),x=k,r=u(!1),o=u(""),b=u(),n=u([]),l=u([]);function L(t){l.value.push(t)}U("validateTopTabs",L);let e=v([]);async function D(t){if(!t)o.value="新增",e=f.userCustomer||[{..._.initialTopTabsData}];else{o.value="编辑";const{data:s}=await z(m.detail({tenantCustomerId:t.tenantCustomerId}));E(s)}n.value=[],r.value=!0}function E(t){e.length=0,e.push({...t})}function V(t){const s=new Set;for(const a of t){if(s.has(a.customerAccord))return!0;s.add(a.customerAccord)}return!1}function S(){f.userCustomer=F(e),e=v([]),r.value=!1,l.value=[]}function g(){e=v([]),r.value=!1,l.value=[],o.value==="新增"&&(f.userCustomer=null)}async function h(){const t=[];l.value.forEach(a=>{t.push(a.validate())});const s=await Promise.allSettled(t);n.value=s.map(a=>a.status)}async function N(){if(await h(),n.value.every(t=>t==="fulfilled"))if(e.forEach(t=>{if(Number(t.rateAudit)<=0){c.warning({message:"审核率Min值不能低于0",center:!0});return}}),V(e))c.warning({message:"客户名称重复",center:!0});else{if(o.value==="新增"){const t={tenantCustomerInfoList:e};e.turnover&&e.turnover.length&&e.turnover.forEach(a=>{a.turnover=a.turnover==0?null:a.turnover});const{status:s}=await w(m.create(t));s===1&&c.success({message:"新增成功",center:!0})}else{e[0].riskControl===1&&(e[0].turnover=null,e[0].rateAudit=null),e[0].turnover=e[0].turnover==0?null:e[0].turnover;const{status:t}=await w(m.edit(e[0]));t===1&&c.success({message:"修改成功",center:!0})}_.customer=null,x("fetch-data"),g()}else b.value.activeLeftTab=n.value.indexOf("rejected"),c.warning({message:"请完善表单",center:!0})}return T({showEdit:D}),(t,s)=>{const a=C("el-button"),A=C("el-drawer");return y(),O("div",null,[d(A,{modelValue:r.value,"onUpdate:modelValue":s[0]||(s[0]=B=>r.value=B),class:q(o.value==="新增"?"hide-drawer-header":"edit-drawer"),"append-to-body":"","close-on-click-modal":!1,"destroy-on-close":"",draggable:"",size:"70%"},{footer:i(()=>[P("div",H,[d(a,{onClick:g},{default:i(()=>[p(" 取消 ")]),_:1}),o.value==="新增"?(y(),X(a,{key:0,type:"warning",onClick:S},{default:i(()=>[p(" 暂存 ")]),_:1})):Z("",!0),d(a,{type:"primary",onClick:N},{default:i(()=>[p(" 确定 ")]),_:1})])]),default:i(()=>[d(I,{onValidate:h,ref_key:"LeftTabsRef",ref:b,title:o.value,"left-tabs-data":$(e),"validate-top-tabs":l.value,"validate-all":n.value},null,8,["title","left-tabs-data","validate-top-tabs","validate-all"])]),_:1},8,["modelValue","class"])])}}}),ve=G(J,[["__scopeId","data-v-168a021a"]]);export{ve as default};
